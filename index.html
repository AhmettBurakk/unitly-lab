<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unitly Lab - Ultimate Engineering Suite</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --border: #e2e8f0; --result-bg: #eff6ff; --accent: #10b981; --warning: #f59e0b; --danger: #ef4444; --purple: #8b5cf6; --indigo: #6366f1; }
        [data-theme="dark"] { --primary: #3b82f6; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --border: #334155; --result-bg: #0f172a; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); transition: 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid var(--border); padding-bottom: 20px; flex-wrap: wrap; gap: 20px; }
        .logo { font-size: 2rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; }
        .logo span { color: var(--text); }

        .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; }
        .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        .dropbtn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 30px; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: var(--card); min-width: 280px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); border-radius: 12px; z-index: 1000; border: 1px solid var(--border); margin-top: 10px; overflow: hidden; max-height: 500px; overflow-y: auto; }
        .dropdown-content a { color: var(--text); padding: 12px 20px; text-decoration: none; display: block; font-weight: 600; cursor: pointer; border-bottom: 1px solid var(--border); }
        .dropdown-content a:hover { background-color: var(--result-bg); color: var(--primary); }
        .show { display: block; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        h3 { margin-top: 0; color: var(--primary); font-size: 1rem; margin-bottom: 15px; border-left: 4px solid var(--primary); padding-left: 10px; }
        .input-group { display: flex; flex-direction: column; gap: 10px; }
        .row { display: flex; gap: 8px; align-items: center; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; background: var(--card); color: var(--text); outline: none; }
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        .result-box { background: var(--result-bg); padding: 12px; border-radius: 8px; margin-top: 12px; text-align: center; border: 1px dashed var(--primary); }
        .result-val { font-size: 1.1rem; font-weight: 800; color: var(--primary); }
        
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); overflow-y: auto; }
        .modal-content { background: var(--card); margin: 2% auto; padding: 25px; border-radius: 20px; width: 95%; max-width: 900px; border: 1px solid var(--border); position: relative; max-height: 90vh; overflow-y: auto;}
        .close { float: right; cursor: pointer; font-size: 24px; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; font-size: 0.85rem; }
        
        canvas { background: #1e293b; border-radius: 12px; cursor: crosshair; display: block; margin: 0 auto; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); width: 100%; height: 500px; touch-action: none; }
        
        .info-footer { margin-top: 50px; padding: 30px; background: var(--card); border-radius: 20px; border: 1px solid var(--border); text-align: center; }
        .disclaimer { color: var(--danger); font-size: 0.85rem; margin-top: 15px; font-weight: 600; }
        
        .lab-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: var(--primary); color: white; margin-left: 8px; text-transform: uppercase; }
        .lab-badge.new { background: var(--accent); }
        .lab-badge.pro { background: var(--warning); color: #000; }
        .lab-badge.hot { background: var(--purple); }
        .lab-badge.blue { background: var(--indigo); }
        
        .analysis-text { font-size: 0.8rem; opacity: 0.8; margin-top: 5px; line-height: 1.4; }
        .point-dot { cursor: pointer; transition: 0.3s; }
        .point-dot:hover { r: 8; filter: drop-shadow(0 0 5px var(--primary)); }
        .unit-tag { font-size: 0.75rem; font-weight: 600; color: var(--warning); margin-bottom: 2px; }
        .multi-unit-res { font-size: 0.85rem; color: var(--text); opacity: 0.9; margin-top: 4px; border-top: 1px solid var(--border); padding-top: 4px; }

        /* Sketch Tool Styles */
        .sketch-toolbar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; background: var(--result-bg); padding: 10px; border-radius: 12px; flex-wrap: wrap; }
        .tool-btn { padding: 8px 15px; border-radius: 8px; background: var(--card); border: 1px solid var(--border); color: var(--text); cursor: pointer; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .tool-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .sketch-stats { margin-left: auto; text-align: right; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">Unit<span>ly</span> Lab</div>
        <div class="header-actions" style="display:flex; gap:15px; align-items:center;">
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="checkbox">
                    <input type="checkbox" id="checkbox" onclick="toggleTheme()">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="dropdown">
                <button onclick="toggleDropdown('mechDropdown')" class="dropbtn">‚öôÔ∏è Mech</button>
                <div id="mechDropdown" class="dropdown-content">
                    <a onclick="openModal('cncModal')">üè≠ Machining Lab <span class="lab-badge">Adv</span></a>
                    <a onclick="openModal('sheetModal')">üìê Sheet Metal Bend <span class="lab-badge blue">Shop</span></a>
                    <a onclick="openModal('hydroModal')">üöú Hydraulic Force <span class="lab-badge hot">Pro</span></a>
                    <a onclick="openModal('fitsModal')">üî© Fits & Tolerances <span class="lab-badge">ISO</span></a>
                    <a onclick="openModal('gcodeModal')">üìú G-Code Reference</a>
                    <a onclick="openModal('gearModal')">‚öôÔ∏è Transmission Lab</a>
                    <a onclick="openModal('beltModal')">‚õìÔ∏è Belt & Chain Calc</a>
                    <a onclick="openModal('fastenerModal')">üî© Fastener Reference</a>
                    <a onclick="openModal('weightModal')">‚öñÔ∏è Profile Weight Lab</a>
                    <a onclick="openModal('sketchModal')">üé® Design Analyst (2D) <span class="lab-badge new">Pro</span></a>
                    <a onclick="openModal('geomModal')">üìê Material & Volume</a>
                    <a onclick="openModal('beamModal')">üèóÔ∏è Beam Analysis</a>
                    <a onclick="openModal('stressModal')">üìà Material Stress <span class="lab-badge pro">Pro</span></a>
                    <a onclick="openModal('thermModal')">üî• Thermal Expansion</a>
                    <a onclick="openModal('linterpModal')">üå°Ô∏è Linear Interpolation <span class="lab-badge new">Exam</span></a>
                    <a onclick="openModal('flowModal')">üíß Pipe Flow Calc</a>
                    <a onclick="openModal('printModal')">üñ®Ô∏è 3D Print Cost <span class="lab-badge">Maker</span></a>
                </div>
            </div>

            <div class="dropdown">
                <button onclick="toggleDropdown('electricDropdown')" class="dropbtn" style="background:var(--warning); color:#000;">‚ö° Electric</button>
                <div id="electricDropdown" class="dropdown-content">
                    <a onclick="openModal('cableModal')">‚ö° Wire Size & Drop <span class="lab-badge hot">EV</span></a>
                    <a onclick="openModal('electroModal')">‚ö° Electronics Lab <span class="lab-badge new">IoT</span></a>
                    <a onclick="openModal('stepperModal')">ü§ñ Stepper / Linear <span class="lab-badge">CNC</span></a>
                    <a onclick="openModal('ebikeModal')">üö≤ EV Power Dynamics <span class="lab-badge">EV</span></a>
                </div>
            </div>

        </div>
    </header>

    <div class="grid">
        <div class="card"><h3>üìè Length</h3><div class="input-group"><input type="number" id="lenInput" oninput="convert('len')"><div class="row"><select id="lenFrom" onchange="convert('len')"><option value="1">m</option><option value="1000">km</option><option value="0.01">cm</option><option value="0.001">mm</option><option value="0.0254">in</option><option value="0.3048">ft</option><option value="1609.34">mi</option></select>‚ûî<select id="lenTo" onchange="convert('len')"><option value="1">m</option><option value="1000">km</option><option value="0.01">cm</option><option value="0.001">mm</option><option value="0.0254">in</option><option value="0.3048">ft</option><option value="1609.34">mi</option></select></div></div><div class="result-box"><span id="lenRes" class="result-val">0</span></div></div>
        <div class="card"><h3>üü¶ Area</h3><div class="input-group"><input type="number" id="areInput" oninput="convert('are')"><div class="row"><select id="areFrom" onchange="convert('are')"><option value="1">m¬≤</option><option value="1000000">km¬≤</option><option value="0.0001">cm¬≤</option><option value="0.000001">mm¬≤</option><option value="0.092903">ft¬≤</option><option value="0.000645">in¬≤</option><option value="4046.86">acre</option></select>‚ûî<select id="areTo" onchange="convert('are')"><option value="1">m¬≤</option><option value="1000000">km¬≤</option><option value="0.0001">cm¬≤</option><option value="0.000001">mm¬≤</option><option value="0.092903">ft¬≤</option><option value="0.000645">in¬≤</option><option value="4046.86">acre</option></select></div></div><div class="result-box"><span id="areRes" class="result-val">0</span></div></div>
        <div class="card"><h3>‚ö° Speed</h3><div class="input-group"><input type="number" id="spdInput" oninput="convert('spd')"><div class="row"><select id="spdFrom" onchange="convert('spd')"><option value="0.277778">km/h</option><option value="1">m/s</option><option value="0.44704">mph</option><option value="0.514444">knot</option><option value="0.3048">ft/s</option></select>‚ûî<select id="spdTo" onchange="convert('spd')"><option value="0.277778">km/h</option><option value="1">m/s</option><option value="0.44704">mph</option><option value="0.514444">knot</option><option value="0.3048">ft/s</option></select></div></div><div class="result-box"><span id="spdRes" class="result-val">0</span></div></div>
        <div class="card"><h3>‚öôÔ∏è Torque</h3><div class="input-group"><input type="number" id="trqInput" oninput="convert('trq')"><div class="row"><select id="trqFrom" onchange="convert('trq')"><option value="1">Nm</option><option value="1.35582">lb-ft</option><option value="0.112985">lb-in</option><option value="9.80665">kgm</option></select>‚ûî<select id="trqTo" onchange="convert('trq')"><option value="1">Nm</option><option value="1.35582">lb-ft</option><option value="0.112985">lb-in</option><option value="9.80665">kgm</option></select></div></div><div class="result-box"><span id="trqRes" class="result-val">0</span></div></div>
        <div class="card"><h3>üí™ Force</h3><div class="input-group"><input type="number" id="frcInput" oninput="convert('frc')"><div class="row"><select id="frcFrom" onchange="convert('frc')"><option value="1">N</option><option value="1000">kN</option><option value="4.44822">lbf</option><option value="9.80665">kgf</option><option value="0.009806">gf</option></select>‚ûî<select id="frcTo" onchange="convert('frc')"><option value="1">N</option><option value="1000">kN</option><option value="4.44822">lbf</option><option value="9.80665">kgf</option><option value="0.009806">gf</option></select></div></div><div class="result-box"><span id="frcRes" class="result-val">0</span></div></div>
        <div class="card"><h3>üèéÔ∏è Power</h3><div class="input-group"><input type="number" id="pwrInput" oninput="convert('pwr')"><div class="row"><select id="pwrFrom" onchange="convert('pwr')"><option value="1">kW</option><option value="0.001">W</option><option value="0.735499">HP (Metric)</option><option value="0.7457">HP (Mechanical)</option><option value="0.000293">BTU/hr</option></select>‚ûî<select id="pwrTo" onchange="convert('pwr')"><option value="1">kW</option><option value="0.001">W</option><option value="0.735499">HP (Metric)</option><option value="0.7457">HP (Mechanical)</option><option value="0.000293">BTU/hr</option></select></div></div><div class="result-box"><span id="pwrRes" class="result-val">0</span></div></div>
        <div class="card"><h3>üéà Pressure</h3><div class="input-group"><input type="number" id="prsInput" oninput="convert('prs')"><div class="row"><select id="prsFrom" onchange="convert('prs')"><option value="1">Bar</option><option value="0.00001">Pa</option><option value="100">kPa</option><option value="0.068947">Psi</option><option value="1.01325">atm</option><option value="0.001333">mmHg</option></select>‚ûî<select id="prsTo" onchange="convert('prs')"><option value="1">Bar</option><option value="0.00001">Pa</option><option value="100">kPa</option><option value="0.068947">Psi</option><option value="1.01325">atm</option><option value="0.001333">mmHg</option></select></div></div><div class="result-box"><span id="prsRes" class="result-val">0</span></div></div>
        <div class="card"><h3>üèõÔ∏è Structural Stress</h3><div class="input-group"><input type="number" id="strInput" oninput="convert('str')"><div class="row"><select id="strFrom" onchange="convert('str')"><option value="1">MPa (N/mm¬≤)</option><option value="1000">GPa</option><option value="0.006894">psi</option><option value="6.89475">ksi (kips)</option><option value="0.098066">kgf/cm¬≤</option><option value="0.001">kPa</option></select>‚ûî<select id="strTo" onchange="convert('str')"><option value="1">MPa (N/mm¬≤)</option><option value="1000">GPa</option><option value="0.006894">psi</option><option value="6.89475">ksi (kips)</option><option value="0.098066">kgf/cm¬≤</option><option value="0.001">kPa</option></select></div></div><div class="result-box"><span id="strRes" class="result-val">0</span></div></div>
        <div class="card"><h3>‚è±Ô∏è Time</h3><div class="input-group"><input type="number" id="timInput" oninput="convert('tim')"><div class="row"><select id="timFrom" onchange="convert('tim')"><option value="3600">Hr</option><option value="60">Min</option><option value="1">Sec</option><option value="0.001">ms</option><option value="86400">Day</option><option value="604800">Week</option></select>‚ûî<select id="timTo" onchange="convert('tim')"><option value="3600">Hr</option><option value="60">Min</option><option value="1">Sec</option><option value="0.001">ms</option><option value="86400">Day</option><option value="604800">Week</option></select></div></div><div class="result-box"><span id="timRes" class="result-val">0</span></div></div>
        <div class="card"><h3>‚öñÔ∏è Weight</h3><div class="input-group"><input type="number" id="wgtInput" oninput="convert('wgt')"><div class="row"><select id="wgtFrom" onchange="convert('wgt')"><option value="1">kg</option><option value="0.001">g</option><option value="1000">ton</option><option value="0.453592">lb</option><option value="0.028349">oz</option><option value="907.185">ton (US)</option></select>‚ûî<select id="wgtTo" onchange="convert('wgt')"><option value="1">kg</option><option value="0.001">g</option><option value="1000">ton</option><option value="0.453592">lb</option><option value="0.028349">oz</option><option value="907.185">ton (US)</option></select></div></div><div class="result-box"><span id="wgtRes" class="result-val">0</span></div></div>
        <div class="card"><h3>ü•õ Volume</h3><div class="input-group"><input type="number" id="volInput" oninput="convert('vol')"><div class="row"><select id="volFrom" onchange="convert('vol')"><option value="1">L</option><option value="0.001">ml</option><option value="1000">m¬≥</option><option value="0.000001">cm¬≥</option><option value="3.78541">gal (US)</option><option value="0.029573">fl oz (US)</option><option value="0.016387">in¬≥</option></select>‚ûî<select id="volTo" onchange="convert('vol')"><option value="1">L</option><option value="0.001">ml</option><option value="1000">m¬≥</option><option value="0.000001">cm¬≥</option><option value="3.78541">gal (US)</option><option value="0.029573">fl oz (US)</option><option value="0.016387">in¬≥</option></select></div></div><div class="result-box"><span id="volRes" class="result-val">0</span></div></div>
        <div class="card"><h3>üìà Finance</h3><div class="input-group"><input type="number" id="pCap" placeholder="Capital"><div class="row"><input type="number" id="pRate" value="45">%<input type="number" id="pTime" value="12">Mo.</div><button onclick="calcFin()">Calculate</button></div><div class="result-box"><span id="finRes" class="result-val">0</span></div></div>
    </div>

    <div id="sketchModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close" onclick="closeModal('sketchModal')">&times;</span>
            <h3 style="color:var(--primary);">üé® Precision Design Analyst (2D Pro)</h3>
            
            <div class="sketch-toolbar">
                <div style="display:flex; gap:10px;">
                    <button id="btnPoly" class="tool-btn active" onclick="setTool('poly')">üìê Poly/Line</button>
                    <button id="btnCircle" class="tool-btn" onclick="setTool('circle')">‚≠ï Circle</button>
                </div>
                <div style="display:flex; gap:10px; margin-left: 20px;">
                     <button onclick="closePolygon()" style="background:var(--accent); width:auto; padding: 8px 15px; font-size:0.9rem;">Close Path</button>
                     <button onclick="clearCanvas()" style="background:var(--danger); width:auto; padding: 8px 15px; font-size:0.9rem;">Clear All</button>
                </div>
                
                <div class="sketch-stats">
                    <div id="analysisResult" class="result-val" style="color:var(--primary); font-size: 1.2rem;">Total Area: 0 mm¬≤</div>
                    <div id="areaInch" style="font-size: 0.8rem; opacity: 0.7;">0 in¬≤</div>
                </div>
            </div>

            <div style="position:relative; background: #0f172a; border-radius: 12px; overflow: hidden; border: 2px solid var(--border);">
                <canvas id="designCanvas"></canvas>
                <div id="cursorPos" style="position:absolute; bottom:10px; left:10px; color:rgba(255,255,255,0.5); font-size:0.8rem; pointer-events:none;">X:0 Y:0</div>
            </div>
             <p class="analysis-text" style="text-align:center; margin-top:10px;">Poly: Click to add points. Circle: Click center and drag. Lines are auto-dimensioned.</p>
        </div>
    </div>
    
    <div id="sheetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('sheetModal')">&times;</span>
            <h3 style="color:var(--indigo);">üìê Sheet Metal Bending (B√ºk√ºm)</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="input-group">
                    <div class="row">
                        <div style="flex:1"><small>Thickness (T)</small><input type="number" id="bendT" value="2"></div>
                        <div style="flex:1"><small>Inside Radius (R)</small><input type="number" id="bendR" value="2"></div>
                    </div>
                    <div class="row">
                        <div style="flex:1"><small>Angle (¬∞)</small><input type="number" id="bendA" value="90"></div>
                        <div style="flex:1"><small>K-Factor</small><input type="number" id="bendK" value="0.33"></div>
                    </div>
                    <div class="analysis-text">K=0.33 (Air Bend), K=0.50 (Coining)</div>
                    <button onclick="calcBend()" style="background:var(--indigo);">Calculate Unfolded</button>
                </div>
                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center;">
                    <div><small>Bend Allowance (BA)</small><div id="bendBA" class="result-val">0.00 mm</div></div>
                    <div class="multi-unit-res">Deduction (BD): <span id="bendBD">0.00 mm</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="flowModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('flowModal')">&times;</span>
            <h3 style="color:#0ea5e9;">üíß Pipe Flow & Velocity</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="input-group">
                    <div class="unit-tag">Parameters</div>
                    <small>Inner Diameter (mm)</small><input type="number" id="pipeID" value="50">
                    <small>Flow Rate (L/min)</small><input type="number" id="pipeQ" value="100">
                    <button onclick="calcFlow()" style="background:#0ea5e9;">Calculate Velocity</button>
                </div>
                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center;">
                    <div><small>Fluid Velocity</small><div id="pipeVel" class="result-val" style="color:#0ea5e9;">0.00 m/s</div></div>
                    <div class="analysis-text" style="margin-top:10px;">Recommended: <br>Suction: 0.6-1.2 m/s<br>Pressure: 2-5 m/s</div>
                </div>
            </div>
        </div>
    </div>

    <div id="thermModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('thermModal')">&times;</span>
            <h3 style="color:#f97316;">üî• Thermal Expansion (Genle≈üme)</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="input-group">
                    <small>Original Length (mm)</small><input type="number" id="thermL" value="100">
                    <div class="row">
                        <div style="flex:1"><small>Temp Change (ŒîT ¬∞C)</small><input type="number" id="thermDT" value="100"></div>
                    </div>
                    <small>Material</small>
                    <select id="thermMat">
                        <option value="12">Steel (12 ¬µm/m¬∞C)</option>
                        <option value="23">Aluminum (23 ¬µm/m¬∞C)</option>
                        <option value="17">Copper (17 ¬µm/m¬∞C)</option>
                        <option value="11">Cast Iron (11 ¬µm/m¬∞C)</option>
                    </select>
                    <button onclick="calcThermal()" style="background:#f97316;">Calculate ŒîL</button>
                </div>
                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center;">
                    <div><small>Change in Length (ŒîL)</small><div id="thermRes" class="result-val" style="color:#f97316;">0.00 mm</div></div>
                    <div class="multi-unit-res">New Length: <span id="thermNewL">0.00 mm</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="linterpModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('linterpModal')">&times;</span>
            <h3 style="color:var(--accent);">üå°Ô∏è Linear Interpolation</h3>
            <p class="analysis-text">Find Y for given X between two points.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="input-group">
                    <small>Point 1 (x1, y1)</small>
                    <div class="row"><input type="number" id="lx1" placeholder="x1"><input type="number" id="ly1" placeholder="y1"></div>
                    <small>Point 2 (x2, y2)</small>
                    <div class="row"><input type="number" id="lx2" placeholder="x2"><input type="number" id="ly2" placeholder="y2"></div>
                </div>
                <div class="input-group" style="justify-content:center;">
                    <small>Target X</small>
                    <input type="number" id="ltx" placeholder="Enter X">
                    <button onclick="calcLinterp()" style="background:var(--accent); margin-top:10px;">Calculate Y</button>
                    <div class="result-box"><span id="lres" class="result-val">Y = --</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="hydroModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('hydroModal')">&times;</span>
            <h3 style="color:var(--danger);">üöú Hydraulic Force Calculator</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="input-group">
                    <div class="unit-tag">Cylinder Specs</div>
                    <small>Bore Diameter (mm)</small><input type="number" id="cylBore" value="80">
                    <small>Rod Diameter (mm)</small><input type="number" id="cylRod" value="40">
                    <small>Pressure (Bar)</small><input type="number" id="cylPress" value="160">
                    <button onclick="calcHydro()" style="background:var(--danger);">Calculate Force</button>
                </div>
                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center; text-align:left; padding:15px;">
                    <div><strong>Push Force (ƒ∞tme):</strong> <span id="pushForce" style="color:var(--danger); font-weight:800;">0 Ton</span></div>
                    <div style="margin-top:10px;"><strong>Pull Force (√áekme):</strong> <span id="pullForce" style="color:var(--text); font-weight:800;">0 Ton</span></div>
                    <div class="analysis-text" style="margin-top:10px;">F = P √ó A</div>
                </div>
            </div>
        </div>
    </div>

    <div id="cableModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('cableModal')">&times;</span>
            <h3 style="color:var(--warning);">‚ö° DC Wire Size & Drop</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="input-group">
                    <div class="row">
                        <div style="flex:1"><small>Voltage (V)</small><input type="number" id="cabV" value="12"></div>
                        <div style="flex:1"><small>Current (A)</small><input type="number" id="cabA" value="20"></div>
                    </div>
                    <div class="row">
                        <div style="flex:1"><small>Length (m)</small><input type="number" id="cabL" value="5"></div>
                        <div style="flex:1"><small>Max Drop %</small><input type="number" id="cabDrop" value="3"></div>
                    </div>
                    <button onclick="calcCable()" style="background:var(--warning); color:#000;">Calculate Cable</button>
                </div>
                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center;">
                    <div><small>Min Cross Section</small><div id="cabResMM" class="result-val">0 mm¬≤</div></div>
                    <div class="multi-unit-res">Nearest Standard: <strong id="cabStd">--</strong></div>
                    <div class="multi-unit-res" style="color:var(--danger)">Voltage Drop: <span id="cabVDrop">0 V</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="fitsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('fitsModal')">&times;</span>
            <h3 style="color:var(--purple);">üî© ISO Fits & Tolerances (Alƒ±≈ütƒ±rmalar)</h3>
            <p class="analysis-text">Simplified ISO 286 Calculator for Common Fits</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="input-group">
                    <div class="unit-tag">Parameters</div>
                    <div class="row">
                        <div style="flex:1"><small>Diameter (mm)</small><input type="number" id="fitDia" value="10"></div>
                        <div style="flex:1"><small>Fit Type</small>
                            <select id="fitType">
                                <option value="H7g6">H7 / g6 (Sliding)</option>
                                <option value="H7h6">H7 / h6 (Clearance)</option>
                                <option value="H7k6">H7 / k6 (Transition)</option>
                                <option value="H7p6">H7 / p6 (Interference)</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="calcFits()" style="background:var(--purple);">Calculate Fit</button>
                </div>
                <div class="result-box" style="text-align:left; padding:15px; display:flex; flex-direction:column; gap:5px;">
                    <div><strong>Hole:</strong> <span id="fitHoleRes">--</span></div>
                    <div><strong>Shaft:</strong> <span id="fitShaftRes">--</span></div>
                    <div style="margin-top:5px; padding-top:5px; border-top:1px dashed var(--border); color:var(--purple); font-weight:bold;">
                        <span id="fitValRes">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="beltModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('beltModal')">&times;</span>
            <h3 style="color:var(--accent);">‚õìÔ∏è Belt & Pulley Calculator</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="input-group">
                    <div class="row">
                        <div style="flex:1"><small>Large Dia (D)</small><input type="number" id="beltD" value="100"></div>
                        <div style="flex:1"><small>Small Dia (d)</small><input type="number" id="belt_d" value="50"></div>
                    </div>
                    <div class="unit-tag">Center Distance (C) mm</div>
                    <input type="number" id="beltC" value="200">
                    <button onclick="calcBelt()" style="background:var(--accent);">Calculate Length</button>
                </div>
                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center;">
                    <div><small>Belt Pitch Length</small><div id="beltLenRes" class="result-val">0 mm</div></div>
                    <div class="analysis-text" style="margin-top:10px;">L ‚âà 2C + 1.57(D+d) + (D-d)¬≤/4C</div>
                </div>
            </div>
        </div>
    </div>

    <div id="stepperModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('stepperModal')">&times;</span>
            <h3 style="color:var(--warning);">ü§ñ Stepper Motor & Linear Motion</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="input-group">
                    <div class="row">
                        <div style="flex:1"><small>Step Angle</small><select id="stepAng"><option value="1.8">1.8¬∞ (200)</option><option value="0.9">0.9¬∞ (400)</option></select></div>
                        <div style="flex:1"><small>Microstepping</small><select id="stepMicro"><option value="1">1/1</option><option value="2">1/2</option><option value="4">1/4</option><option value="8">1/8</option><option value="16" selected>1/16</option><option value="32">1/32</option></select></div>
                    </div>
                    <div class="unit-tag">Transmission</div>
                    <select id="transType" onchange="toggleTransInput()">
                        <option value="screw">Lead Screw (Pitch mm)</option>
                        <option value="belt">Belt (Pulley Pitch x Teeth)</option>
                    </select>
                    <input type="number" id="transVal" value="8" placeholder="Pitch or Pulley Dia">
                    <button onclick="calcStepper()" style="background:var(--warning); color:#000;">Calculate Steps</button>
                </div>
                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center;">
                    <div><small>Steps per mm</small><div id="stepRes" class="result-val" style="color:var(--warning);">0.00</div></div>
                    <div class="multi-unit-res">Resolution: <span id="stepResMicron">0</span> microns</div>
                </div>
            </div>
        </div>
    </div>

    <div id="printModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('printModal')">&times;</span>
            <h3 style="color:var(--accent);">üñ®Ô∏è 3D Print Cost Estimator</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="input-group">
                    <div class="unit-tag">Filament Info</div>
                    <div class="row">
                        <div style="flex:1"><small>Spool Cost ($/TL)</small><input type="number" id="spoolCost" value="400"></div>
                        <div style="flex:1"><small>Spool Weight (g)</small><input type="number" id="spoolWeight" value="1000"></div>
                    </div>
                    <div class="unit-tag">Print Details</div>
                    <div class="row">
                         <div style="flex:1"><small>Part Weight (g)</small><input type="number" id="partWeight" value="50"></div>
                         <div style="flex:1"><small>Time (Hours)</small><input type="number" id="printTime" value="4"></div>
                    </div>
                    <div class="unit-tag">Electricity</div>
                    <div class="row">
                        <div style="flex:1"><small>Power (Watts)</small><input type="number" id="printerWatts" value="150"></div>
                        <div style="flex:1"><small>kWh Cost</small><input type="number" id="kwhCost" value="3.5"></div>
                    </div>
                    <button onclick="calcPrintCost()" style="background:var(--accent); margin-top:10px;">Calculate</button>
                </div>
                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center; text-align:left; padding:20px;">
                    <div class="multi-unit-res">üßµ Material Cost: <strong id="resMatCost">0.00</strong></div>
                    <div class="multi-unit-res">‚ö° Energy Cost: <strong id="resEnergyCost">0.00</strong></div>
                    <hr style="width:100%; border:0; border-top:1px dashed var(--border);">
                    <div style="font-size:1.5rem; font-weight:800; color:var(--accent); text-align:center; margin-top:10px;">
                        Total: <span id="resTotalPrint">0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="electroModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('electroModal')">&times;</span>
            <h3 style="color:var(--warning);">‚ö° Electronics & Ohm Lab</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="input-group">
                    <h4 style="margin:0; font-size:0.9rem;">LED Resistor Calculator</h4>
                    <div class="row">
                        <div style="flex:1"><small>Source Voltage (V)</small><input type="number" id="ledVs" value="5"></div>
                        <div style="flex:1"><small>LED Forward (V)</small><input type="number" id="ledVf" value="2.0"></div>
                    </div>
                    <small>LED Current (mA)</small>
                    <input type="number" id="ledI" value="20">
                    <button onclick="calcLedResistor()" style="background:var(--warning); color:black;">Calculate Resistor</button>
                    
                    <div class="result-box">
                        <span id="resLedOhm" class="result-val" style="color:var(--warning);">0 Œ©</span>
                        <div style="font-size:0.8rem; margin-top:5px;">Min Power: <span id="resLedPower">0 mW</span></div>
                    </div>
                </div>
                
                <div class="input-group" style="border-left:1px solid var(--border); padding-left:15px;">
                    <h4 style="margin:0; font-size:0.9rem;">Ohm's Law (V = I √ó R)</h4>
                    <small>Voltage (V)</small><input type="number" id="ohmV" placeholder="V" oninput="calcOhm()">
                    <small>Current (A)</small><input type="number" id="ohmI" placeholder="A" oninput="calcOhm()">
                    <small>Resistance (Œ©)</small><input type="number" id="ohmR" placeholder="Œ©" oninput="calcOhm()">
                    <div class="analysis-text" style="margin-top:10px;">Enter any 2 values to calculate the 3rd.</div>
                </div>
            </div>
        </div>
    </div>

    <div id="fastenerModal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <span class="close" onclick="closeModal('fastenerModal')">&times;</span>
            <h3 style="color:#64748b;">üî© ISO Fastener Reference</h3>
            <input type="text" id="fastenerSearch" placeholder="Search M3, M5, Bolt..." onkeyup="searchFasteners()" style="margin-bottom:15px;">
            <div style="max-height: 400px; overflow-y: auto;">
                <table id="fastenerTable">
                    <thead><tr><th>Size</th><th>Pitch (mm)</th><th>Tap Drill (mm)</th><th>Clearance (mm)</th><th>Hex Key (mm)</th></tr></thead>
                    <tbody id="fastenerBody">
                        <tr><td>M2</td><td>0.4</td><td>1.6</td><td>2.2</td><td>1.5</td></tr>
                        <tr><td>M2.5</td><td>0.45</td><td>2.05</td><td>2.7</td><td>2.0</td></tr>
                        <tr><td>M3</td><td>0.5</td><td>2.5</td><td>3.4</td><td>2.5</td></tr>
                        <tr><td>M4</td><td>0.7</td><td>3.3</td><td>4.5</td><td>3.0</td></tr>
                        <tr><td>M5</td><td>0.8</td><td>4.2</td><td>5.5</td><td>4.0</td></tr>
                        <tr><td>M6</td><td>1.0</td><td>5.0</td><td>6.6</td><td>5.0</td></tr>
                        <tr><td>M8</td><td>1.25</td><td>6.8</td><td>9.0</td><td>6.0</td></tr>
                        <tr><td>M10</td><td>1.5</td><td>8.5</td><td>11.0</td><td>8.0</td></tr>
                        <tr><td>M12</td><td>1.75</td><td>10.2</td><td>13.5</td><td>10.0</td></tr>
                        <tr><td>M16</td><td>2.0</td><td>14.0</td><td>17.5</td><td>14.0</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="weightModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('weightModal')">&times;</span>
            <h3 style="color:var(--accent);">‚öñÔ∏è Advanced Profile Weight Lab</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="input-group">
                    <div class="unit-tag">Profile Type</div>
                    <select id="profileType" onchange="updateProfileInputs()">
                        <option value="square_hollow">Kutu Profil (Hollow Square)</option>
                        <option value="round_hollow">Boru (Hollow Round)</option>
                        <option value="l_profile">L K√∂≈üebent (L Profile)</option>
                        <option value="round_solid">Dolu Mil (Round Bar)</option>
                        <option value="flat_bar">Lama (Flat Bar)</option>
                    </select>
                    <div class="unit-tag">Material</div>
                    <select id="profileMat">
                        <option value="7.85">Steel (7.85 g/cm¬≥)</option>
                        <option value="2.70">Aluminum (2.70 g/cm¬≥)</option>
                        <option value="8.0">Stainless Steel (8.0 g/cm¬≥)</option>
                    </select>
                    <div id="profileInputs"></div>
                    <div class="unit-tag">Length (mm)</div>
                    <input type="number" id="profL" value="1000">
                    <button onclick="calcProfileWeight()" style="background:var(--accent);">Calculate Weight</button>
                </div>
                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center; border-style:solid; border-color:var(--accent);">
                    <div><small>Calculated Weight</small><div id="profWeightRes" class="result-val" style="color:var(--accent); font-size:2rem;">0.00 kg</div></div>
                    <div class="multi-unit-res" id="profWeightLbs">Weight: 0.00 lbs</div>
                    <div class="multi-unit-res" id="profWeightNote">Ready for calculation.</div>
                </div>
            </div>
        </div>
    </div>

    <div id="cncModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('cncModal')">&times;</span>
            <h3 style="color:var(--primary);">üè≠ Advanced Machining Analyst</h3>
            <div class="grid" style="grid-template-columns: 1fr 1.2fr; gap: 20px;">
                <div class="input-group">
                    <div class="unit-tag">Cutting Speed (Vc - m/min)</div>
                    <select id="matType" onchange="updateCNCDefaults()">
                        <option value="150">Steel - Low Carbon (150)</option>
                        <option value="90">Stainless Steel (90)</option>
                        <option value="300">Aluminum Alloys (300)</option>
                        <option value="45">Titanium Alloys (45)</option>
                        <option value="200">Cast Iron (200)</option>
                    </select>
                    <div class="row">
                        <div style="flex:1"><div class="unit-tag">Tool Diameter (mm)</div><input type="number" id="cncD" value="10"></div>
                        <div style="flex:1"><div class="unit-tag">Feed/Tooth (fz - mm)</div><input type="number" id="cncFz" value="0.1"></div>
                    </div>
                    <div class="unit-tag">Number of Flutes (z)</div>
                    <input type="number" id="cncZ" value="4">
                    <button onclick="calcCNC()" style="background:var(--primary);">Calculate Cycles</button>
                    <hr style="margin: 15px 0; border: 0; border-top: 1px solid var(--border);">
                    <div class="unit-tag">Metric Tap Reference (Quick Drill Size)</div>
                    <select id="tapSizeSelector" onchange="updateTapDrill()">
                        <option value="">Select Metric Tap...</option>
                        <option value="2.5">M3 x 0.5</option>
                        <option value="3.3">M4 x 0.7</option>
                        <option value="4.2">M5 x 0.8</option>
                        <option value="5.0">M6 x 1.0</option>
                        <option value="6.8">M8 x 1.25</option>
                        <option value="8.5">M10 x 1.5</option>
                        <option value="10.2">M12 x 1.75</option>
                        <option value="12.0">M14 x 2.0</option>
                        <option value="14.0">M16 x 2.0</option>
                        <option value="17.5">M20 x 2.5</option>
                    </select>
                </div>
                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center; gap:8px; border-style:solid;">
                    <div><small>Spindle Speed</small><div id="resRPM" class="result-val">0 RPM</div></div>
                    <div><small>Feed Rate</small><div id="resFeed" class="result-val">0 mm/min</div></div>
                    <div class="multi-unit-res" id="resCNCSfpm">Speed in SFM: 0 ft/min</div>
                    <div class="multi-unit-res" style="border-top: 2px solid var(--accent); color: var(--accent); padding-top: 10px; margin-top: 10px;">
                        <small>Recommended Drill Bit for Tap:</small>
                        <div id="tapDrillRes" style="font-size: 1.5rem; font-weight: 800;">-- mm</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="geomModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('geomModal')">&times;</span>
            <h3 style="color:var(--primary);">üìê Material & Volume Lab</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="input-group">
                    <div class="unit-tag">Geometry Shape</div>
                    <select id="shapeType" onchange="updateGeomInputs()">
                        <option value="cylinder">Cylinder / Rod</option>
                        <option value="sphere">Sphere / Ball</option>
                        <option value="cube">Rectangular Block</option>
                    </select>
                    <div class="unit-tag">Material Density (œÅ)</div>
                    <select id="matDensity">
                        <option value="7.85">Steel (7.85 g/cm¬≥)</option>
                        <option value="2.70">Aluminum (2.70 g/cm¬≥)</option>
                        <option value="8.96">Copper (8.96 g/cm¬≥)</option>
                        <option value="1.20">Plastic/ABS (1.20 g/cm¬≥)</option>
                    </select>
                    <div id="geomInputs"></div>
                    <button onclick="calcGeomVolume()" style="background:var(--primary);">Analyze Physics</button>
                </div>
                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center; border-style:solid;">
                    <div><small>Total Volume</small><div id="geomRes" class="result-val">0 mm¬≥</div></div>
                    <div><small>Estimated Mass</small><div id="massRes" class="result-val" style="color:var(--accent)">0 kg</div></div>
                    <div class="multi-unit-res" id="massLbs">Mass: 0 lbs</div>
                    <div class="multi-unit-res" id="volInches">Volume: 0 in¬≥</div>
                </div>
            </div>
        </div>
    </div>

    <div id="ebikeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('ebikeModal')">&times;</span>
            <h3 style="color:var(--accent);">üö≤ EV Power & Range Dynamics</h3>
            <div class="grid" style="grid-template-columns: 1fr 1.2fr; gap: 20px;">
                <div class="input-group">
                    <div class="row">
                        <div style="flex:1"><div class="unit-tag">Voltage (V)</div><input type="number" id="evV" value="72"></div>
                        <div style="flex:1"><div class="unit-tag">Capacity (Ah)</div><input type="number" id="evAh" value="40"></div>
                    </div>
                    <div class="row">
                        <div style="flex:1"><div class="unit-tag">Motor (W)</div><input type="number" id="evW" value="3000"></div>
                        <div style="flex:1"><div class="unit-tag">Avg Speed (km/h)</div><input type="number" id="evSpd" value="45"></div>
                    </div>
                    <button onclick="calcMobility()" style="background:var(--accent);">Run Range Simulation</button>
                </div>
                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center; border-style:solid; border-color:var(--accent);">
                    <div><small>Energy Storage</small><div id="resWh" class="result-val">0 Wh</div></div>
                    <div><small>Simulated Range</small><div id="resRange" class="result-val">0 km</div></div>
                    <div class="multi-unit-res" id="resRangeMi">Range: 0 miles</div>
                    <div class="multi-unit-res" id="resRuntime">Full Load Runtime: 0 min</div>
                </div>
            </div>
        </div>
    </div>

    <div id="beamModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('beamModal')">&times;</span>
            <h3 style="color:var(--primary);">üèóÔ∏è Beam Analysis Pro (Cantilever)</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="input-group">
                    <div class="unit-tag">Point Load (F - Newton)</div>
                    <input type="number" id="beamF" value="1000">
                    <div class="unit-tag">Beam Length (L - mm)</div>
                    <input type="number" id="beamL" value="2000">
                    <div class="unit-tag">Elastic Modulus (E - GPa)</div>
                    <select id="beamE">
                        <option value="210">Steel (210 GPa)</option>
                        <option value="70">Aluminum (70 GPa)</option>
                        <option value="110">Titanium (110 GPa)</option>
                    </select>
                    <div class="unit-tag">Moment of Inertia (I - mm‚Å¥)</div>
                    <input type="number" id="beamI" value="100000">
                    <button onclick="calcBeamPro()" style="background:var(--primary);">Analyze Deflection</button>
                </div>
                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center; border-style:solid;">
                    <div><small>Max Tip Deflection</small><div id="resDef" class="result-val">0.00 mm</div></div>
                    <div class="analysis-text" style="margin-top:20px;">Formula: $\delta = \frac{F \cdot L^3}{3 \cdot E \cdot I}$</div>
                </div>
            </div>
        </div>
    </div>

    <div id="stressModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('stressModal')">&times;</span>
            <h3 style="color:var(--primary);">üìà Material Stress Lab</h3>
            <div style="background:var(--card); padding:10px; border:1px solid var(--border); border-radius:15px; text-align:center;">
                <svg viewBox="0 0 600 400" width="100%" height="auto">
                    <line x1="50" y1="350" x2="550" y2="350" stroke="var(--text)" stroke-width="2" />
                    <line x1="50" y1="350" x2="50" y2="50" stroke="var(--text)" stroke-width="2" />
                    <path d="M50,350 L150,150 Q200,160 250,120 T450,100 T530,250" fill="none" stroke="var(--primary)" stroke-width="4" />
                    <circle cx="150" cy="150" r="6" fill="var(--accent)" class="point-dot" onmouseover="showPoint('proportional')" />
                    <circle cx="200" cy="158" r="6" fill="#f59e0b" class="point-dot" onmouseover="showPoint('yield')" />
                    <circle cx="450" cy="100" r="6" fill="#ef4444" class="point-dot" onmouseover="showPoint('ultimate')" />
                    <circle cx="530" cy="250" r="6" fill="#000" class="point-dot" onmouseover="showPoint('fracture')" />
                </svg>
            </div>
            <div id="pointDesc" class="analysis-text" style="margin-top:15px;">Hover points for data.</div>
        </div>
    </div>

    <div id="gcodeModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('gcodeModal')">&times;</span>
            <h3 style="color:var(--warning);">üìú ISO G/M Code Reference</h3>
            <input type="text" id="codeSearch" placeholder="Search codes..." onkeyup="searchCodes()" style="margin-bottom:15px;">
            <div style="max-height: 400px; overflow-y: auto;">
                <table id="gCodeTable">
                    <thead><tr><th>Code</th><th>Function</th><th>Description</th></tr></thead>
                    <tbody id="codeTableBody">
                        <tr><td>G00</td><td>Rapid Positioning</td><td>High-speed non-cutting movement.</td></tr>
                        <tr><td>G01</td><td>Linear Interpolation</td><td>Controlled feed cutting motion (Linear).</td></tr>
                        <tr><td>G02</td><td>CW Circular Interpolation</td><td>Clockwise circular arc movement.</td></tr>
                        <tr><td>G03</td><td>CCW Circular Interpolation</td><td>Counter-Clockwise circular arc movement.</td></tr>
                        <tr><td>G17</td><td>XY Plane Selection</td><td>Selects the XY plane for arcs.</td></tr>
                        <tr><td>G18</td><td>ZX Plane Selection</td><td>Selects the ZX plane for arcs.</td></tr>
                        <tr><td>G19</td><td>YZ Plane Selection</td><td>Selects the YZ plane for arcs.</td></tr>
                        <tr><td>G20</td><td>Inch Unit Selection</td><td>Sets units to inches.</td></tr>
                        <tr><td>G21</td><td>Metric Unit Selection</td><td>Sets units to millimeters.</td></tr>
                        <tr><td>G28</td><td>Return to Home</td><td>Moves to machine reference point.</td></tr>
                        <tr><td>G40</td><td>Cutter Comp Cancel</td><td>Cancels G41/G42 compensation.</td></tr>
                        <tr><td>G41</td><td>Cutter Comp Left</td><td>Compensates for tool radius (Left).</td></tr>
                        <tr><td>G42</td><td>Cutter Comp Right</td><td>Compensates for tool radius (Right).</td></tr>
                        <tr><td>G43</td><td>Tool Length Comp</td><td>Adjusts for tool length offset (H).</td></tr>
                        <tr><td>G54</td><td>Work Coordinate 1</td><td>Selects standard work offset 1.</td></tr>
                        <tr><td>G81</td><td>Drilling Cycle</td><td>Simple spot drilling cycle.</td></tr>
                        <tr><td>G83</td><td>Peck Drilling Cycle</td><td>Deep hole drilling with retraction.</td></tr>
                        <tr><td>G90</td><td>Absolute Programming</td><td>Coordinates relative to origin.</td></tr>
                        <tr><td>G91</td><td>Incremental Programming</td><td>Coordinates relative to last position.</td></tr>
                        <tr><td>M00</td><td>Program Stop</td><td>Pauses the program (Operator resume).</td></tr>
                        <tr><td>M01</td><td>Optional Stop</td><td>Pauses if 'Opt Stop' switch is on.</td></tr>
                        <tr><td>M03</td><td>Spindle On (CW)</td><td>Starts spindle clockwise.</td></tr>
                        <tr><td>M04</td><td>Spindle On (CCW)</td><td>Starts spindle counter-clockwise.</td></tr>
                        <tr><td>M05</td><td>Spindle Stop</td><td>Stops the spindle rotation.</td></tr>
                        <tr><td>M06</td><td>Tool Change</td><td>Executes tool change sequence (T).</td></tr>
                        <tr><td>M08</td><td>Coolant On</td><td>Turns on flood coolant.</td></tr>
                        <tr><td>M09</td><td>Coolant Off</td><td>Turns off coolant.</td></tr>
                        <tr><td>M30</td><td>Program End</td><td>Ends program and resets to start.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="gearModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('gearModal')">&times;</span>
            <h3 style="color:var(--primary);">‚öôÔ∏è Drivetrain & Gear Ratio</h3>
            <div class="grid" style="grid-template-columns: 1fr 1.2fr; gap:20px;">
                <div class="input-group">
                    <div class="unit-tag">Motor Specs</div>
                    <small>Motor RPM (Loaded)</small>
                    <input type="number" id="motorRPM" value="4500">
                    
                    <div class="unit-tag">Transmission (Sprockets)</div>
                    <div class="row">
                        <div style="flex:1"><small>Driver (T)</small><input type="number" id="gearDriver" value="12"></div>
                        <div style="flex:1"><small>Driven (T)</small><input type="number" id="gearDriven" value="54"></div>
                    </div>
                    
                    <div class="unit-tag">Wheel Size</div>
                    <small>Tire Diameter (cm)</small>
                    <input type="number" id="tireDia" value="26">
                    
                    <button onclick="calcGearing()" style="background:var(--primary); margin-top:10px;">Calculate Speed</button>
                </div>

                <div class="result-box" style="display:flex; flex-direction:column; justify-content:center; border-style:solid;">
                    <div><small>Theoretical Top Speed</small><div id="speedRes" class="result-val">0 km/h</div></div>
                    
                    <div class="row" style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                        <div style="flex:1; text-align:center;">
                            <small>Gear Ratio</small>
                            <div id="ratioRes" style="font-weight:bold; color:var(--text);">0 : 1</div>
                        </div>
                        <div style="flex:1; text-align:center;">
                            <small>Wheel RPM</small>
                            <div id="wheelRpmRes" style="font-weight:bold; color:var(--text);">0</div>
                        </div>
                    </div>
                    <div class="multi-unit-res" style="text-align:center; margin-top:10px;">
                        Torque Multiplier: <span id="torqueMult">1.0x</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="info-footer">
        <h3>üìñ About Unitly Lab</h3>
        <p>A comprehensive engineering data and manufacturing simulation suite.</p>
        <div class="disclaimer">‚ö†Ô∏è Verify simulation data against physical standards for critical projects.</div>
        <p style="margin-top:10px; opacity:0.4; font-size:0.7rem;">&copy; 2026 Unitly Lab</p>
    </footer>
</div>

<script>
    function toggleTheme() {
        const isChecked = document.getElementById('checkbox').checked;
        isChecked ? document.body.setAttribute('data-theme', 'dark') : document.body.removeAttribute('data-theme');
    }
    // Updated toggleDropdown to handle specific IDs
    function toggleDropdown(id) { 
        var dropdowns = document.getElementsByClassName("dropdown-content");
        for (var i = 0; i < dropdowns.length; i++) {
            if (dropdowns[i].id !== id) {
                dropdowns[i].classList.remove('show');
            }
        }
        document.getElementById(id).classList.toggle("show"); 
    }
    function openModal(id) { 
        document.getElementById(id).style.display = "block"; 
        if(id === 'sketchModal') setTimeout(initCanvas, 100);
        if(id === 'geomModal') updateGeomInputs();
        if(id === 'weightModal') updateProfileInputs();
        if(id === 'fitsModal') calcFits(); // Initial calc for fits
    }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }

    function updateProfileInputs() {
        const type = document.getElementById('profileType').value;
        let html = '';
        if(type === 'square_hollow') html = '<div class="row"><div><small>Width (mm)</small><input type="number" id="pW" value="40"></div><div><small>Thickness (mm)</small><input type="number" id="pT" value="2"></div></div>';
        else if(type === 'round_hollow') html = '<div class="row"><div><small>Diameter (mm)</small><input type="number" id="pD" value="30"></div><div><small>Thickness (mm)</small><input type="number" id="pT" value="2"></div></div>';
        else if(type === 'l_profile') html = '<div class="row"><div><small>A (mm)</small><input type="number" id="pW" value="40"></div><div><small>B (mm)</small><input type="number" id="pH" value="40"></div><div><small>t (mm)</small><input type="number" id="pT" value="4"></div></div>';
        else if(type === 'round_solid') html = '<small>Diameter (mm)</small><input type="number" id="pD" value="20">';
        else html = '<div class="row"><div><small>Width (mm)</small><input type="number" id="pW" value="50"></div><div><small>Height (mm)</small><input type="number" id="pH" value="10"></div></div>';
        document.getElementById('profileInputs').innerHTML = html;
    }

    function calcProfileWeight() {
        const type = document.getElementById('profileType').value;
        const rho = parseFloat(document.getElementById('profileMat').value);
        const L = parseFloat(document.getElementById('profL').value);
        let area = 0; // mm2

        if(type === 'square_hollow') {
            const w = parseFloat(document.getElementById('pW').value);
            const t = parseFloat(document.getElementById('pT').value);
            area = (w * w) - ((w - 2*t) * (w - 2*t));
        } else if(type === 'round_hollow') {
            const d = parseFloat(document.getElementById('pD').value);
            const t = parseFloat(document.getElementById('pT').value);
            area = (Math.PI/4) * (Math.pow(d, 2) - Math.pow(d - 2*t, 2));
        } else if(type === 'l_profile') {
            const a = parseFloat(document.getElementById('pW').value);
            const b = parseFloat(document.getElementById('pH').value);
            const t = parseFloat(document.getElementById('pT').value);
            area = (a * t) + ((b - t) * t);
        } else if(type === 'round_solid') {
            const d = parseFloat(document.getElementById('pD').value);
            area = (Math.PI/4) * Math.pow(d, 2);
        } else {
            const w = parseFloat(document.getElementById('pW').value);
            const h = parseFloat(document.getElementById('pH').value);
            area = w * h;
        }

        const massKg = (area * L * rho) / 1000000;
        document.getElementById('profWeightRes').innerText = massKg.toFixed(2) + " kg";
        document.getElementById('profWeightLbs').innerText = "Weight: " + (massKg * 2.204).toFixed(2) + " lbs";
        document.getElementById('profWeightNote').innerText = "Volume: " + Math.round(area * L) + " mm¬≥";
    }

    // --- Stress/Strain Graph Data ---
    const pointData = {
        'proportional': '<strong>Proportional Limit:</strong> Linear elastic region ends here. Hooke\'s Law (œÉ = EŒµ) applies below this point.',
        'yield': '<strong>Yield Point:</strong> Transition from elastic to plastic deformation. Permanent deformation begins.',
        'ultimate': '<strong>Ultimate Tensile Strength (UTS):</strong> The maximum stress the material can withstand before necking occurs.',
        'fracture': '<strong>Fracture Point:</strong> The point where the material physically breaks or separates.'
    };

    function convert(type) {
        const val = parseFloat(document.getElementById(type + 'Input').value) || 0;
        const from = parseFloat(document.getElementById(type + 'From').value), to = parseFloat(document.getElementById(type + 'To').value);
        const res = val * from / to;
        document.getElementById(type + 'Res').innerText = res < 0.01 ? res.toExponential(4) : res.toLocaleString();
    }
    function updateTapDrill() {
        const val = document.getElementById('tapSizeSelector').value;
        document.getElementById('tapDrillRes').innerText = val ? val + " mm" : "-- mm";
    }
    function updateCNCDefaults() {
        const speed = document.getElementById('matType').value;
    }
    function calcCNC() {
        const vc = parseFloat(document.getElementById('matType').value);
        const d = parseFloat(document.getElementById('cncD').value);
        const fz = parseFloat(document.getElementById('cncFz').value);
        const z = parseFloat(document.getElementById('cncZ').value);
        const rpm = (vc * 1000) / (Math.PI * d);
        const feed = rpm * fz * z;
        document.getElementById('resRPM').innerText = Math.round(rpm) + " RPM";
        document.getElementById('resFeed').innerText = Math.round(feed) + " mm/min";
        document.getElementById('resCNCSfpm').innerText = `Speed in SFM: ${Math.round(vc * 3.28)} ft/min`;
    }
    function updateGeomInputs() {
        const type = document.getElementById('shapeType').value;
        let html = '';
        if(type === 'cylinder') html = '<div class="row"><div><small>Radius (mm)</small><input type="number" id="gR" value="10"></div><div><small>Length (mm)</small><input type="number" id="gL" value="100"></div></div>';
        else if(type === 'sphere') html = '<small>Radius (mm)</small><input type="number" id="gR" value="10">';
        else html = '<div class="row"><div><small>L (mm)</small><input type="number" id="gL" value="10"></div><div><small>W (mm)</small><input type="number" id="gW" value="10"></div><div><small>H (mm)</small><input type="number" id="gH" value="10"></div></div>';
        document.getElementById('geomInputs').innerHTML = html;
    }
    function calcGeomVolume() {
        const type = document.getElementById('shapeType').value;
        const rho = parseFloat(document.getElementById('matDensity').value);
        let vol = 0;
        if(type === 'cylinder') vol = Math.PI * Math.pow(document.getElementById('gR').value, 2) * document.getElementById('gL').value;
        else if(type === 'sphere') vol = (4/3) * Math.PI * Math.pow(document.getElementById('gR').value, 3);
        else vol = document.getElementById('gL').value * document.getElementById('gW').value * document.getElementById('gH').value;
        const mass = (vol / 1000) * (rho / 1000); 
        document.getElementById('geomRes').innerText = Math.round(vol).toLocaleString() + " mm¬≥";
        document.getElementById('massRes').innerText = mass.toFixed(3) + " kg";
        document.getElementById('massLbs').innerText = `Mass: ${(mass * 2.204).toFixed(3)} lbs`;
        document.getElementById('volInches').innerText = `Volume: ${(vol / 16387).toFixed(3)} in¬≥`;
    }
    function calcMobility() {
        const v = parseFloat(document.getElementById('evV').value);
        const ah = parseFloat(document.getElementById('evAh').value);
        const w = parseFloat(document.getElementById('evW').value);
        const spd = parseFloat(document.getElementById('evSpd').value);
        const wh = v * ah;
        const range = ((wh * 0.85) / (w / spd));
        const runtime = ((wh * 0.85) / w) * 60;
        document.getElementById('resWh').innerText = wh + " Wh";
        document.getElementById('resRange').innerText = range.toFixed(1) + " km";
        document.getElementById('resRangeMi').innerText = `Range: ${(range * 0.621).toFixed(1)} miles`;
        document.getElementById('resRuntime').innerText = `Full Load Runtime: ${Math.round(runtime)} min`;
    }
    function calcBeamPro() {
        const F = parseFloat(document.getElementById('beamF').value);
        const L = parseFloat(document.getElementById('beamL').value);
        const E_GPa = parseFloat(document.getElementById('beamE').value);
        const I = parseFloat(document.getElementById('beamI').value);
        const E = E_GPa * 1000;
        const def = (F * Math.pow(L, 3)) / (3 * E * I);
        document.getElementById('resDef').innerText = def.toFixed(2) + " mm";
    }
    function showPoint(id) { document.getElementById('pointDesc').innerHTML = pointData[id]; }
    function calcFin() {
        const p = parseFloat(document.getElementById('pCap').value), r = parseFloat(document.getElementById('pRate').value), t = parseFloat(document.getElementById('pTime').value);
        document.getElementById('finRes').innerText = ((p*r*t)/1200).toLocaleString();
    }
    function searchCodes() {
        let input = document.getElementById('codeSearch').value.toUpperCase();
        let rows = document.getElementById('codeTableBody').getElementsByTagName('tr');
        for (let row of rows) { if (row.cells.length > 1) { row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none"; } }
    }
    function searchFasteners() {
        let input = document.getElementById('fastenerSearch').value.toUpperCase();
        let rows = document.getElementById('fastenerBody').getElementsByTagName('tr');
        for (let row of rows) { row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none"; }
    }
    
    // --- Gear Ratio / Drivetrain Calculator ---
    function calcGearing() {
        const rpm = parseFloat(document.getElementById('motorRPM').value);
        const driver = parseFloat(document.getElementById('gearDriver').value);
        const driven = parseFloat(document.getElementById('gearDriven').value);
        const diaCm = parseFloat(document.getElementById('tireDia').value);
        const ratio = driven / driver;
        const wheelRpm = rpm / ratio;
        const circumference = Math.PI * diaCm; // cm
        const speedKmh = (wheelRpm * circumference * 60) / 100000;

        document.getElementById('speedRes').innerText = speedKmh.toFixed(1) + " km/h";
        document.getElementById('ratioRes').innerText = ratio.toFixed(2) + " : 1";
        document.getElementById('wheelRpmRes').innerText = Math.round(wheelRpm);
        document.getElementById('torqueMult').innerText = ratio.toFixed(2) + "x";
    }

    // --- 3D Print Calculator ---
    function calcPrintCost() {
        const spoolCost = parseFloat(document.getElementById('spoolCost').value);
        const spoolWeight = parseFloat(document.getElementById('spoolWeight').value);
        const partWeight = parseFloat(document.getElementById('partWeight').value);
        const time = parseFloat(document.getElementById('printTime').value);
        const watts = parseFloat(document.getElementById('printerWatts').value);
        const kwhPrice = parseFloat(document.getElementById('kwhCost').value);

        const matCost = (partWeight / spoolWeight) * spoolCost;
        const energyCost = (watts / 1000) * time * kwhPrice;
        const total = matCost + energyCost;

        document.getElementById('resMatCost').innerText = matCost.toFixed(2);
        document.getElementById('resEnergyCost').innerText = energyCost.toFixed(2);
        document.getElementById('resTotalPrint').innerText = total.toFixed(2);
    }

    // --- Electronics / LED Calculator ---
    function calcLedResistor() {
        const vs = parseFloat(document.getElementById('ledVs').value);
        const vf = parseFloat(document.getElementById('ledVf').value);
        const i = parseFloat(document.getElementById('ledI').value) / 1000; // mA to A
        if(i <= 0 || vs <= vf) { document.getElementById('resLedOhm').innerText = "Error"; return; }
        
        const r = (vs - vf) / i;
        const p = Math.pow(i, 2) * r;

        document.getElementById('resLedOhm').innerText = Math.round(r) + " Œ©";
        document.getElementById('resLedPower').innerText = (p * 1000).toFixed(0) + " mW";
    }

    function calcOhm() {
        const v = parseFloat(document.getElementById('ohmV').value);
        const i = parseFloat(document.getElementById('ohmI').value);
        const r = parseFloat(document.getElementById('ohmR').value);
        
        if(!isNaN(v) && !isNaN(i)) document.getElementById('ohmR').value = v / i;
        else if(!isNaN(v) && !isNaN(r)) document.getElementById('ohmI').value = v / r;
        else if(!isNaN(i) && !isNaN(r)) document.getElementById('ohmV').value = i * r;
    }

    // --- Fits & Tolerances (Simplified) ---
    function calcFits() {
        const dia = parseFloat(document.getElementById('fitDia').value);
        const type = document.getElementById('fitType').value;
        let holeMax=0, holeMin=0, shaftMax=0, shaftMin=0, valText = "";

        // Approximation for quick calculation (not full ISO database)
        // Values roughly scale with diameter root
        const baseTol = Math.pow(dia, 0.45) * 0.001 * 15; // Rough micron scaling factor

        if(type === 'H7g6') {
            holeMax = baseTol; holeMin = 0;
            shaftMax = -baseTol * 0.4; shaftMin = -baseTol * 1.2;
            valText = "Clearance / Sliding Fit (Hassas Hareketli)";
        } else if(type === 'H7h6') {
            holeMax = baseTol; holeMin = 0;
            shaftMax = 0; shaftMin = -baseTol * 0.8;
            valText = "Clearance Fit (Hassas Bo≈üluklu)";
        } else if(type === 'H7k6') {
            holeMax = baseTol; holeMin = 0;
            shaftMax = baseTol * 0.6; shaftMin = baseTol * 0.1;
            valText = "Transition Fit (Ara Ge√ßme - √áeki√ßle)";
        } else if(type === 'H7p6') {
            holeMax = baseTol; holeMin = 0;
            shaftMax = baseTol * 1.5; shaftMin = baseTol * 0.9;
            valText = "Interference Fit (Sƒ±kƒ± Ge√ßme - Pres)";
        }

        document.getElementById('fitHoleRes').innerText = `+${(holeMax*1000).toFixed(1)} / +${(holeMin*1000).toFixed(1)} ¬µm`;
        document.getElementById('fitShaftRes').innerText = `${(shaftMax*1000 > 0 ? '+' : '')}${(shaftMax*1000).toFixed(1)} / ${(shaftMin*1000 > 0 ? '+' : '')}${(shaftMin*1000).toFixed(1)} ¬µm`;
        document.getElementById('fitValRes').innerText = valText;
    }

    // --- Belt Length Calculator ---
    function calcBelt() {
        const D = parseFloat(document.getElementById('beltD').value);
        const d = parseFloat(document.getElementById('belt_d').value);
        const C = parseFloat(document.getElementById('beltC').value);
        
        const L = (2 * C) + (1.57 * (D + d)) + (Math.pow(D - d, 2) / (4 * C));
        document.getElementById('beltLenRes').innerText = Math.round(L) + " mm";
    }

    // --- Stepper Motor Calculator ---
    function calcStepper() {
        const deg = parseFloat(document.getElementById('stepAng').value);
        const micro = parseFloat(document.getElementById('stepMicro').value);
        const pitch = parseFloat(document.getElementById('transVal').value);
        
        if(pitch === 0) return;
        
        const stepsPerRev = (360 / deg) * micro;
        const stepsPerUnit = stepsPerRev / pitch;
        
        document.getElementById('stepRes').innerText = stepsPerUnit.toFixed(2);
        document.getElementById('stepResMicron').innerText = (1000 / stepsPerUnit).toFixed(2);
    }

    // --- Linterp Calculator ---
    function calcLinterp() {
        const x1 = parseFloat(document.getElementById('lx1').value);
        const y1 = parseFloat(document.getElementById('ly1').value);
        const x2 = parseFloat(document.getElementById('lx2').value);
        const y2 = parseFloat(document.getElementById('ly2').value);
        const x = parseFloat(document.getElementById('ltx').value);

        if (x2 === x1) { document.getElementById('lres').innerText = "Error (x1=x2)"; return; }
        
        const y = y1 + ((x - x1) * (y2 - y1) / (x2 - x1));
        document.getElementById('lres').innerText = "Y = " + y.toFixed(4);
    }

    // --- Hydraulic Force Calculator ---
    function calcHydro() {
        const bore = parseFloat(document.getElementById('cylBore').value);
        const rod = parseFloat(document.getElementById('cylRod').value);
        const bar = parseFloat(document.getElementById('cylPress').value);

        // Areas in cm2 (since bore is mm)
        const areaPush = Math.PI * Math.pow(bore/20, 2); 
        const areaPull = areaPush - (Math.PI * Math.pow(rod/20, 2));

        // Force = P(bar) * A(cm2) = kgf -> /1000 for tons
        const fPush = (bar * areaPush) / 1000;
        const fPull = (bar * areaPull) / 1000;

        document.getElementById('pushForce').innerText = fPush.toFixed(2) + " Ton";
        document.getElementById('pullForce').innerText = fPull.toFixed(2) + " Ton";
    }

    // --- Cable Size Calculator ---
    function calcCable() {
        const v = parseFloat(document.getElementById('cabV').value);
        const i = parseFloat(document.getElementById('cabA').value);
        const l = parseFloat(document.getElementById('cabL').value); // Meters
        const dropPerc = parseFloat(document.getElementById('cabDrop').value);

        // Formula: S = (2 * L * I * 0.0175) / (V_drop) 
        // 0.0175 is resistivity of copper
        const maxDropV = v * (dropPerc / 100);
        const section = (2 * l * i * 0.0175) / maxDropV;

        document.getElementById('cabResMM').innerText = section.toFixed(2) + " mm¬≤";
        document.getElementById('cabVDrop').innerText = maxDropV.toFixed(2) + " V";

        // Find nearest standard size
        const standards = [0.5, 0.75, 1.0, 1.5, 2.5, 4, 6, 10, 16, 25, 35, 50];
        let std = "Custom";
        for(let s of standards) {
            if(s >= section) { std = s + " mm¬≤"; break; }
        }
        document.getElementById('cabStd').innerText = std;
    }

    // --- Sheet Metal Bend Calculator (NEW) ---
    function calcBend() {
        const T = parseFloat(document.getElementById('bendT').value);
        const R = parseFloat(document.getElementById('bendR').value);
        const A = parseFloat(document.getElementById('bendA').value);
        const K = parseFloat(document.getElementById('bendK').value);

        // Bend Allowance Formula: BA = A * (PI/180) * (R + K*T)
        // Bend Deduction Formula: BD = 2 * (R+T) * tan(A/2) - BA
        
        const radA = A * (Math.PI / 180);
        const BA = radA * (R + (K * T));
        
        // Deduction is complex for non-90, using standard setback method
        const OSSB = (R + T) * Math.tan(radA / 2); // Outside Setback
        const BD = (2 * OSSB) - BA;

        document.getElementById('bendBA').innerText = BA.toFixed(2) + " mm";
        document.getElementById('bendBD').innerText = BD.toFixed(2) + " mm";
    }

    // --- Pipe Flow Calculator (NEW) ---
    function calcFlow() {
        const id = parseFloat(document.getElementById('pipeID').value); // mm
        const Q_lmin = parseFloat(document.getElementById('pipeQ').value); // L/min

        // Convert to meters and m3/s
        const d_m = id / 1000;
        const Q_m3s = Q_lmin / 60000;
        const Area = Math.PI * Math.pow(d_m / 2, 2);

        // V = Q / A
        const vel = Q_m3s / Area;
        
        document.getElementById('pipeVel').innerText = vel.toFixed(2) + " m/s";
    }

    // --- Thermal Expansion Calculator (NEW) ---
    function calcThermal() {
        const L = parseFloat(document.getElementById('thermL').value);
        const dT = parseFloat(document.getElementById('thermDT').value);
        const alpha = parseFloat(document.getElementById('thermMat').value) * 0.000001; // micro to standard

        const dL = L * alpha * dT;
        const newL = L + dL;

        document.getElementById('thermRes').innerText = (dL * 1000).toFixed(1) + " ¬µm (" + dL.toFixed(3) + " mm)";
        document.getElementById('thermNewL').innerText = newL.toFixed(3) + " mm";
    }

    // --- MARK: Advanced 2D Sketch Logic (V2.0 - Improved) ---
    let canvas, ctx;
    let shapes = []; // Stores all finished shapes {type, points, radius, etc.}
    let points = []; // Stores points for the CURRENT polygon being drawn
    let activeTool = 'poly'; // 'poly' or 'circle'
    let isDrawing = false;
    let startPoint = null; // For circle center or poly rubber-banding
    let tempPoint = null; // For previewing the current drag

    function initCanvas() {
        canvas = document.getElementById('designCanvas');
        if(!canvas) return;
        canvas.width = canvas.parentElement.offsetWidth; 
        canvas.height = 500; 
        ctx = canvas.getContext('2d');
        
        // Add event listeners for mouse and touch
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('touchstart', handleStart, {passive: false});
        canvas.addEventListener('touchmove', handleMove, {passive: false});
        canvas.addEventListener('touchend', handleEnd);

        drawCanvas(); 
    }

    function getCoords(e) {
        e.preventDefault(); // Prevent scrolling on touch
        const rect = canvas.getBoundingClientRect();
        let x, y;
        if (e.touches && e.touches.length > 0) {
            x = e.touches[0].clientX - rect.left;
            y = e.touches[0].clientY - rect.top;
        } else {
            x = e.clientX - rect.left;
            y = e.clientY - rect.top;
        }
        return {x, y};
    }

    function handleStart(e) {
        const coords = getCoords(e);
        if(activeTool === 'poly') {
            points.push(coords);
            startPoint = coords; // For rubber-banding the next line
        } else if(activeTool === 'circle') {
            isDrawing = true;
            startPoint = coords;
        }
        drawCanvas();
    }

    function handleMove(e) {
        const coords = getCoords(e);
        tempPoint = coords;
        // Update coordinate display
        document.getElementById('cursorPos').innerText = `X:${Math.round(coords.x)} Y:${Math.round(coords.y)}`;
        drawCanvas();
    }

    function handleEnd(e) {
        if(activeTool === 'circle' && isDrawing) {
            const coords = getCoords(e);
            const radius = Math.sqrt(Math.pow(coords.x - startPoint.x, 2) + Math.pow(coords.y - startPoint.y, 2));
            if(radius > 2) {
                 shapes.push({type: 'circle', center: startPoint, radius: radius});
            }
            isDrawing = false;
            startPoint = null;
            tempPoint = null;
            calcTotalArea();
        }
        // Polygon points are added on click (handleStart), so no action needed here for poly
        drawCanvas();
    }

    function setTool(tool) {
        activeTool = tool;
        document.getElementById('btnPoly').classList.toggle('active', tool === 'poly');
        document.getElementById('btnCircle').classList.toggle('active', tool === 'circle');
        // Reset current poly drawing if switching tools
        points = []; startPoint = null; tempPoint = null;
        drawCanvas();
    }


    function drawCanvas() {
        if(!ctx) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw Grid
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
        ctx.lineWidth = 1;
        const gridSize = 20;
        for(let i=0; i<canvas.width; i+=gridSize) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        for(let j=0; j<canvas.height; j+=gridSize) { ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(canvas.width,j); ctx.stroke(); }

        // 1. Draw Finished Shapes
        for(let shape of shapes) {
            ctx.strokeStyle = '#10b981'; ctx.fillStyle = 'rgba(16, 185, 129, 0.2)'; ctx.lineWidth = 2;
            ctx.beginPath();
            if(shape.type === 'poly') {
                ctx.moveTo(shape.points[0].x, shape.points[0].y);
                for(let i=1; i<shape.points.length; i++) ctx.lineTo(shape.points[i].x, shape.points[i].y);
                ctx.closePath(); ctx.fill();
                // Draw labels for finished polygon
                 for(let i=0; i<shape.points.length; i++) {
                    let p1 = shape.points[i];
                    let p2 = shape.points[(i+1) % shape.points.length];
                    drawLabel(p1, p2);
                }
            } else if(shape.type === 'circle') {
                ctx.arc(shape.center.x, shape.center.y, shape.radius, 0, Math.PI*2);
                ctx.fill();
                // Draw radius label
                drawLabel(shape.center, {x: shape.center.x + shape.radius, y: shape.center.y});
            }
            ctx.stroke();
        }

        // 2. Draw Current Polygon being drawn
        if(points.length > 0) {
            ctx.strokeStyle = activeTool === 'poly' ? '#3b82f6' : '#10b981'; ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            for(let i=1; i<points.length; i++) {
                 ctx.lineTo(points[i].x, points[i].y);
                 drawLabel(points[i-1], points[i]); // Label finished segments
            }
            ctx.stroke();
            
            // Draw rubber-band preview line
            if(tempPoint && activeTool === 'poly') {
                 ctx.beginPath(); ctx.moveTo(points[points.length-1].x, points[points.length-1].y); ctx.lineTo(tempPoint.x, tempPoint.y);
                 ctx.strokeStyle = 'rgba(59, 130, 246, 0.5)'; ctx.stroke();
                 drawLabel(points[points.length-1], tempPoint, true); // Preview label
            }
            ctx.fillStyle = '#fff'; for(let p of points) { ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill(); }
        }

        // 3. Draw Circle Preview
        if(isDrawing && activeTool === 'circle' && startPoint && tempPoint) {
             const radius = Math.sqrt(Math.pow(tempPoint.x - startPoint.x, 2) + Math.pow(tempPoint.y - startPoint.y, 2));
             ctx.beginPath(); ctx.arc(startPoint.x, startPoint.y, radius, 0, Math.PI*2);
             ctx.strokeStyle = 'rgba(59, 130, 246, 0.5)'; ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
             ctx.fill(); ctx.stroke();
             drawLabel(startPoint, tempPoint, true); // Radius preview label
        }
    }
    
    // Helper function to draw length labels
    function drawLabel(p1, p2, isPreview = false) {
         const midX = (p1.x + p2.x) / 2;
         const midY = (p1.y + p2.y) / 2;
         const dist = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
         if(dist < 5) return; // Don't label tiny lines
         
         ctx.save();
         ctx.fillStyle = isPreview ? 'rgba(255,255,255,0.7)' : '#fff';
         ctx.font = 'bold 11px Inter, sans-serif';
         ctx.textAlign = 'center';
         ctx.textBaseline = 'middle';
         // Simple background for text readability
         const text = Math.round(dist) + 'mm';
         const metrics = ctx.measureText(text);
         ctx.fillStyle = 'rgba(0,0,0,0.5)';
         ctx.fillRect(midX - metrics.width/2 - 2, midY - 8, metrics.width + 4, 16);
         ctx.fillStyle = isPreview ? 'rgba(255,255,255,0.9)' : '#fff';
         ctx.fillText(text, midX, midY);
         ctx.restore();
    }

    function closePolygon() {
        if(points.length < 3) return;
        shapes.push({type: 'poly', points: points});
        points = []; // Reset current poly
        startPoint = null; tempPoint = null;
        drawCanvas();
        calcTotalArea();
    }

    function calcTotalArea() {
        let totalArea = 0;
        for(let shape of shapes) {
            if(shape.type === 'poly') {
                let area = 0;
                for (let i = 0; i < shape.points.length; i++) {
                    let j = (i + 1) % shape.points.length;
                    area += shape.points[i].x * shape.points[j].y;
                    area -= shape.points[j].x * shape.points[i].y;
                }
                totalArea += Math.abs(area) / 2;
            } else if(shape.type === 'circle') {
                totalArea += Math.PI * Math.pow(shape.radius, 2);
            }
        }
        document.getElementById('analysisResult').innerText = "Total Area: " + Math.round(totalArea).toLocaleString() + " mm¬≤";
        document.getElementById('areaInch').innerText = (totalArea * 0.00155).toFixed(3) + " in¬≤";
    }

    function clearCanvas() {
        points = [];
        shapes = [];
        startPoint = null; tempPoint = null; isDrawing = false;
        document.getElementById('analysisResult').innerText = "Total Area: 0 mm¬≤";
        document.getElementById('areaInch').innerText = "0 in¬≤";
        drawCanvas();
    }
</script>
</body>
</html>
