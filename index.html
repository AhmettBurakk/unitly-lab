<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unitly Lab - Engineering Suite v2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --border: #e2e8f0; --result-bg: #eff6ff; --accent: #10b981; --warning: #f59e0b; --danger: #ef4444; --purple: #8b5cf6; --indigo: #6366f1; --rose: #e11d48; --orange: #f97316; --teal: #14b8a6; }
        [data-theme="dark"] { --primary: #3b82f6; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --border: #334155; --result-bg: #0f172a; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; padding-bottom: 60px; color: var(--text); transition: 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid var(--border); padding-bottom: 20px; flex-wrap: wrap; gap: 20px; }
        .logo { font-size: 2rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; }
        .logo span { color: var(--text); }

        .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; }
        .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        .dropbtn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 30px; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: var(--card); min-width: 280px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); border-radius: 12px; z-index: 1000; border: 1px solid var(--border); margin-top: 10px; overflow: hidden; max-height: 500px; overflow-y: auto; }
        .dropdown-content a { color: var(--text); padding: 12px 20px; text-decoration: none; display: block; font-weight: 600; cursor: pointer; border-bottom: 1px solid var(--border); }
        .dropdown-content a:hover { background-color: var(--result-bg); color: var(--primary); }
        .show { display: block; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        h3 { margin-top: 0; color: var(--primary); font-size: 1rem; margin-bottom: 15px; border-left: 4px solid var(--primary); padding-left: 10px; }
        .input-group { display: flex; flex-direction: column; gap: 10px; }
        .row { display: flex; gap: 8px; align-items: center; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; background: var(--card); color: var(--text); outline: none; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .result-box { background: var(--result-bg); padding: 12px; border-radius: 8px; margin-top: 12px; text-align: center; border: 1px dashed var(--primary); }
        .result-val { font-size: 1.1rem; font-weight: 800; color: var(--primary); }
        
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); overflow-y: auto; }
        .modal-content { background: var(--card); margin: 2% auto; padding: 25px; border-radius: 20px; width: 95%; max-width: 1000px; border: 1px solid var(--border); position: relative; max-height: 90vh; overflow-y: auto;}
        .close { float: right; cursor: pointer; font-size: 24px; font-weight: bold; color: var(--text); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; font-size: 0.85rem; }
        
        canvas { background: #1e293b; border-radius: 12px; cursor: crosshair; display: block; margin: 0 auto; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); width: 100%; height: 400px; touch-action: none; }
        
        .info-footer { margin-top: 50px; padding: 30px; background: var(--card); border-radius: 20px; border: 1px solid var(--border); text-align: center; }
        
        /* Disclaimer Bar */
        .disclaimer-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #0f172a; color: #fff; text-align: center; padding: 10px; font-size: 0.75rem; border-top: 2px solid var(--warning); z-index: 9999; }
        
        .lab-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: var(--primary); color: white; margin-left: 8px; text-transform: uppercase; }
        .lab-badge.new { background: var(--accent); }
        .lab-badge.pro { background: var(--warning); color: #000; }
        .lab-badge.hot { background: var(--purple); }
        .lab-badge.blue { background: var(--indigo); }
        .lab-badge.rose { background: var(--rose); }
        .lab-badge.orange { background: var(--orange); }
        .lab-badge.teal { background: var(--teal); }
        .lab-badge.danger { background: var(--danger); }
        
        .analysis-text { font-size: 0.8rem; opacity: 0.8; margin-top: 5px; line-height: 1.4; }
        .point-dot { cursor: pointer; transition: 0.3s; }
        .point-dot:hover { r: 8; filter: drop-shadow(0 0 5px var(--primary)); }
        .unit-tag { font-size: 0.75rem; font-weight: 600; color: var(--warning); margin-bottom: 2px; }
        .multi-unit-res { font-size: 0.85rem; color: var(--text); opacity: 0.9; margin-top: 4px; border-top: 1px solid var(--border); padding-top: 4px; }

        /* Sketch Tool Styles */
        .sketch-toolbar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; background: var(--result-bg); padding: 10px; border-radius: 12px; flex-wrap: wrap; }
        .tool-btn { padding: 8px 15px; border-radius: 8px; background: var(--card); border: 1px solid var(--border); color: var(--text); cursor: pointer; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; width: auto;}
        .tool-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .sketch-stats { margin-left: auto; text-align: right; }

        /* 3D Viewer Styles */
        #threeContainer { width: 100%; height: 500px; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
        .three-overlay { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; color: white; display: flex; flex-direction: column; gap: 5px; z-index: 10; }
        .three-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; transition: 0.2s; width: auto; }
        .three-btn:hover { background: var(--primary); border-color: var(--primary); }
        .three-btn.active { background: var(--accent); border-color: var(--accent); }

        /* 3D View Cube (Nav) */
        .view-cube { position: absolute; bottom: 20px; right: 20px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; z-index: 10; backdrop-filter: blur(2px); }
        .view-btn { width: 35px; height: 35px; background: #334155; color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; font-size: 0.6rem; font-weight: bold; }
        .view-btn:hover { background: var(--primary); }
        
        /* Comp Table */
        .comp-table { width: 100%; border-collapse: collapse; }
        .comp-table th { background: var(--result-bg); padding: 10px; text-align: left; color: var(--primary); border-bottom: 2px solid var(--border); }
        .comp-table td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .comp-table tr:hover { background-color: var(--result-bg); }

        /* GDT Grid */
        .gdt-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .gdt-card { background: var(--result-bg); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--border); transition: 0.3s; }
        .gdt-card:hover { border-color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .gdt-symbol { font-size: 2.5rem; display: block; margin-bottom: 5px; color: var(--text); font-family: sans-serif; }
        .gdt-name { font-weight: 700; font-size: 0.85rem; color: var(--primary); display: block; margin-bottom: 3px; }
        .gdt-desc { font-size: 0.7rem; opacity: 0.8; line-height: 1.2; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">Unit<span>ly</span> Lab</div>
        <div class="header-actions" style="display:flex; gap:15px; align-items:center;">
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="checkbox">
                    <input type="checkbox" id="checkbox" onclick="toggleTheme()">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="dropdown">
                <button onclick="toggleDropdown('mechDropdown')" class="dropbtn">âš™ï¸ Mech</button>
                <div id="mechDropdown" class="dropdown-content">
                    <a onclick="openModal('threeModal')">ğŸ§Š 3D Studio (Beta) <span class="lab-badge danger">Pro</span></a>
                    <a onclick="openModal('latheModal')">ğŸ›‘ Lathe / Turning <span class="lab-badge rose">DNMG</span></a>
                    <a onclick="openModal('cncModal')">ğŸ­ Milling / CNC</a>
                    <a onclick="openModal('weldingModal')">ğŸ”¥ Welding Calc <span class="lab-badge orange">New</span></a>
                    <a onclick="openModal('laserModal')">âš¡ Laser Cut Cost <span class="lab-badge orange">New</span></a>
                    <a onclick="openModal('oringModal')">â­• O-Ring / Groove <span class="lab-badge orange">New</span></a>
                    <a onclick="openModal('sheetModal')">ğŸ“ Sheet Metal Bend <span class="lab-badge blue">Shop</span></a>
                    <a onclick="openModal('hydroModal')">ğŸšœ Hydraulic Force <span class="lab-badge hot">Pro</span></a>
                    <a onclick="openModal('fitsModal')">ğŸ”© Fits & Tolerances <span class="lab-badge">ISO</span></a>
                    <a onclick="openModal('gearModal')">âš™ï¸ Transmission</a>
                    <a onclick="openModal('beltModal')">â›“ï¸ Belt & Chain</a>
                    <a onclick="openModal('weightModal')">âš–ï¸ Profile Weight</a>
                    <a onclick="openModal('sketchModal')">ğŸ¨ Sketch 2D <span class="lab-badge new">Pro</span></a>
                    <a onclick="openModal('geomModal')">ğŸ“ Material & Volume</a>
                    <a onclick="openModal('beamModal')">ğŸ—ï¸ Beam Analysis</a>
                    <a onclick="openModal('stressModal')">ğŸ“ˆ Stress Analysis</a>
                    <a onclick="openModal('thermModal')">ğŸ”¥ Thermal Exp.</a>
                    <a onclick="openModal('flowModal')">ğŸ’§ Pipe Flow</a>
                    <a onclick="openModal('printModal')">ğŸ–¨ï¸ 3D Print Cost</a>
                </div>
            </div>

            <div class="dropdown">
                <button onclick="toggleDropdown('electricDropdown')" class="dropbtn" style="background:var(--warning); color:#000;">âš¡ Electric</button>
                <div id="electricDropdown" class="dropdown-content">
                    <a onclick="openModal('cableModal')">âš¡ Wire Size & Drop <span class="lab-badge hot">EV</span></a>
                    <a onclick="openModal('electroModal')">âš¡ Electronics Lab <span class="lab-badge new">IoT</span></a>
                    <a onclick="openModal('stepperModal')">ğŸ¤– Stepper / Linear</a>
                    <a onclick="openModal('ebikeModal')">ğŸš² EV Dynamics <span class="lab-badge">EV</span></a>
                </div>
            </div>

            <div class="dropdown">
                <button onclick="toggleDropdown('eduDropdown')" class="dropbtn" style="background:var(--teal); color:white;">ğŸ“ Edu / Ref</button>
                <div id="eduDropdown" class="dropdown-content">
                      <a onclick="openModal('materialModal')">ğŸ“š Materials Lib <span class="lab-badge teal">New</span></a>
                      <a onclick="openModal('gdtModal')">ğŸ“ GD&T Symbols <span class="lab-badge teal">New</span></a>
                      <a onclick="openModal('surfaceModal')">ã€°ï¸ Surface Roughness <span class="lab-badge teal">New</span></a>
                      <a onclick="openModal('gcodeModal')">ğŸ“œ G-Code List</a>
                      <a onclick="openModal('fastenerModal')">ğŸ”© Fastener Table</a>
                      <a onclick="openModal('linterpModal')">ğŸŒ¡ï¸ Linear Interp. <span class="lab-badge">Exam</span></a>
                      <a onclick="openModal('infoModal')">â„¹ï¸ Lathe vs Milling</a>
                </div>
            </div>

        </div>
    </header>

    <div class="grid">
        <div class="card"><h3>ğŸ“ Length</h3><div class="input-group"><input type="number" id="lenInput" oninput="convert('len')"><div class="row"><select id="lenFrom" onchange="convert('len')"><option value="1">m</option><option value="1000">km</option><option value="0.01">cm</option><option value="0.001">mm</option><option value="0.0254">in</option><option value="0.3048">ft</option><option value="1609.34">mi</option></select>â”<select id="lenTo" onchange="convert('len')"><option value="1">m</option><option value="1000">km</option><option value="0.01">cm</option><option value="0.001">mm</option><option value="0.0254">in</option><option value="0.3048">ft</option><option value="1609.34">mi</option></select></div></div><div class="result-box"><span id="lenRes" class="result-val">0</span></div></div>
        <div class="card"><h3>ğŸŸ¦ Area</h3><div class="input-group"><input type="number" id="areInput" oninput="convert('are')"><div class="row"><select id="areFrom" onchange="convert('are')"><option value="1">mÂ²</option><option value="1000000">kmÂ²</option><option value="0.0001">cmÂ²</option><option value="0.000001">mmÂ²</option><option value="0.092903">ftÂ²</option><option value="0.000645">inÂ²</option><option value="4046.86">acre</option></select>â”<select id="areTo" onchange="convert('are')"><option value="1">mÂ²</option><option value="1000000">kmÂ²</option><option value="0.0001">cmÂ²</option><option value="0.000001">mmÂ²</option><option value="0.092903">ftÂ²</option><option value="0.000645">inÂ²</option><option value="4046.86">acre</option></select></div></div><div class="result-box"><span id="areRes" class="result-val">0</span></div></div>
        <div class="card"><h3>âš¡ Speed</h3><div class="input-group"><input type="number" id="spdInput" oninput="convert('spd')"><div class="row"><select id="spdFrom" onchange="convert('spd')"><option value="0.277778">km/h</option><option value="1">m/s</option><option value="0.44704">mph</option><option value="0.514444">knot</option><option value="0.3048">ft/s</option></select>â”<select id="spdTo" onchange="convert('spd')"><option value="0.277778">km/h</option><option value="1">m/s</option><option value="0.44704">mph</option><option value="0.514444">knot</option><option value="0.3048">ft/s</option></select></div></div><div class="result-box"><span id="spdRes" class="result-val">0</span></div></div>
        <div class="card"><h3>âš™ï¸ Torque</h3><div class="input-group"><input type="number" id="trqInput" oninput="convert('trq')"><div class="row"><select id="trqFrom" onchange="convert('trq')"><option value="1">Nm</option><option value="1.35582">lb-ft</option><option value="0.112985">lb-in</option><option value="9.80665">kgm</option></select>â”<select id="trqTo" onchange="convert('trq')"><option value="1">Nm</option><option value="1.35582">lb-ft</option><option value="0.112985">lb-in</option><option value="9.80665">kgm</option></select></div></div><div class="result-box"><span id="trqRes" class="result-val">0</span></div></div>
        <div class="card"><h3>ğŸ’ª Force</h3><div class="input-group"><input type="number" id="frcInput" oninput="convert('frc')"><div class="row"><select id="frcFrom" onchange="convert('frc')"><option value="1">N</option><option value="1000">kN</option><option value="4.44822">lbf</option><option value="9.80665">kgf</option><option value="0.009806">gf</option></select>â”<select id="frcTo" onchange="convert('frc')"><option value="1">N</option><option value="1000">kN</option><option value="4.44822">lbf</option><option value="9.80665">kgf</option><option value="0.009806">gf</option></select></div></div><div class="result-box"><span id="frcRes" class="result-val">0</span></div></div>
        <div class="card"><h3>ğŸï¸ Power</h3><div class="input-group"><input type="number" id="pwrInput" oninput="convert('pwr')"><div class="row"><select id="pwrFrom" onchange="convert('pwr')"><option value="1">kW</option><option value="0.001">W</option><option value="0.735499">HP (Metric)</option><option value="0.7457">HP (Mechanical)</option><option value="0.000293">BTU/hr</option></select>â”<select id="pwrTo" onchange="convert('pwr')"><option value="1">kW</option><option value="0.001">W</option><option value="0.735499">HP (Metric)</option><option value="0.7457">HP (Mechanical)</option><option value="0.000293">BTU/hr</option></select></div></div><div class="result-box"><span id="pwrRes" class="result-val">0</span></div></div>
        <div class="card"><h3>ğŸˆ Pressure</h3><div class="input-group"><input type="number" id="prsInput" oninput="convert('prs')"><div class="row"><select id="prsFrom" onchange="convert('prs')"><option value="1">Bar</option><option value="0.00001">Pa</option><option value="100">kPa</option><option value="0.068947">Psi</option><option value="1.01325">atm</option><option value="0.001333">mmHg</option></select>â”<select id="prsTo" onchange="convert('prs')"><option value="1">Bar</option><option value="0.00001">Pa</option><option value="100">kPa</option><option value="0.068947">Psi</option><option value="1.01325">atm</option><option value="0.001333">mmHg</option></select></div></div><div class="result-box"><span id="prsRes" class="result-val">0</span></div></div>
        <div class="card"><h3>ğŸ›ï¸ Structural Stress</h3><div class="input-group"><input type="number" id="strInput" oninput="convert('str')"><div class="row"><select id="strFrom" onchange="convert('str')"><option value="1">MPa (N/mmÂ²)</option><option value="1000">GPa</option><option value="0.006894">psi</option><option value="6.89475">ksi (kips)</option><option value="0.098066">kgf/cmÂ²</option><option value="0.001">kPa</option></select>â”<select id="strTo" onchange="convert('str')"><option value="1">MPa (N/mmÂ²)</option><option value="1000">GPa</option><option value="0.006894">psi</option><option value="6.89475">ksi (kips)</option><option value="0.098066">kgf/cmÂ²</option><option value="0.001">kPa</option></select></div></div><div class="result-box"><span id="strRes" class="result-val">0</span></div></div>
        <div class="card"><h3>â±ï¸ Time</h3><div class="input-group"><input type="number" id="timInput" oninput="convert('tim')"><div class="row"><select id="timFrom" onchange="convert('tim')"><option value="3600">Hr</option><option value="60">Min</option><option value="1">Sec</option><option value="0.001">ms</option><option value="86400">Day</option><option value="604800">Week</option></select>â”<select id="timTo" onchange="convert('tim')"><option value="3600">Hr</option><option value="60">Min</option><option value="1">Sec</option><option value="0.001">ms</option><option value="86400">Day</option><option value="604800">Week</option></select></div></div><div class="result-box"><span id="timRes" class="result-val">0</span></div></div>
        <div class="card"><h3>âš–ï¸ Weight</h3><div class="input-group"><input type="number" id="wgtInput" oninput="convert('wgt')"><div class="row"><select id="wgtFrom" onchange="convert('wgt')"><option value="1">kg</option><option value="0.001">g</option><option value="1000">ton</option><option value="0.453592">lb</option><option value="0.028349">oz</option><option value="907.185">ton (US)</option></select>â”<select id="wgtTo" onchange="convert('wgt')"><option value="1">kg</option><option value="0.001">g</option><option value="1000">ton</option><option value="0.453592">lb</option><option value="0.028349">oz</option><option value="907.185">ton (US)</option></select></div></div><div class="result-box"><span id="wgtRes" class="result-val">0</span></div></div>
        <div class="card"><h3>ğŸ¥› Volume</h3><div class="input-group"><input type="number" id="volInput" oninput="convert('vol')"><div class="row"><select id="volFrom" onchange="convert('vol')"><option value="1">L</option><option value="0.001">ml</option><option value="1000">mÂ³</option><option value="0.000001">cmÂ³</option><option value="3.78541">gal (US)</option><option value="0.029573">fl oz (US)</option><option value="0.016387">inÂ³</option></select>â”<select id="volTo" onchange="convert('vol')"><option value="1">L</option><option value="0.001">ml</option><option value="1000">mÂ³</option><option value="0.000001">cmÂ³</option><option value="3.78541">gal (US)</option><option value="0.029573">fl oz (US)</option><option value="0.016387">inÂ³</option></select></div></div><div class="result-box"><span id="volRes" class="result-val">0</span></div></div>
        <div class="card"><h3>ğŸ“ˆ Finance</h3><div class="input-group"><input type="number" id="pCap" placeholder="Capital"><div class="row"><input type="number" id="pRate" value="45">%<input type="number" id="pTime" value="12">Mo.</div><button onclick="calcFin()">Calculate</button></div><div class="result-box"><span id="finRes" class="result-val">0</span></div></div>
    </div>

    <div id="threeModal" class="modal">
        <div class="modal-content" style="width: 98%; max-width: 1200px;">
            <span class="close" onclick="closeModal('threeModal')">&times;</span>
            <h3 style="color:var(--danger);">ğŸ§Š 3D Prototyping Studio (Beta)</h3>
            <div id="threeContainer">
                <div class="three-overlay">
                    <button id="btn3DDraw" class="three-btn" onclick="toggle3DDrawMode()">âœï¸ Draw Line Mode</button>
                    <button class="three-btn" onclick="add3DCube()">ğŸŸ¦ Add Block</button>
                    <button class="three-btn" onclick="add3DCylinder()">ğŸ”˜ Add Cylinder</button>
                    <button class="three-btn" onclick="toggleWireframe()">ğŸ•¸ï¸ Wireframe</button>
                    <button class="three-btn" style="background:var(--danger);" onclick="clear3D()">âŒ Clear</button>
                    <small style="font-size:0.7rem; opacity:0.8;">Click 'Draw' & Tap on grid.</small>
                </div>
                <div class="view-cube">
                    <button class="view-btn" onclick="set3DView('top')">TOP</button>
                    <button class="view-btn" onclick="set3DView('front')">FRT</button>
                    <button class="view-btn" onclick="set3DView('right')">RGT</button>
                    <button class="view-btn" onclick="set3DView('iso')" style="background:var(--primary);">ISO</button>
                </div>
            </div>
        </div>
    </div>

    <div id="latheModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('latheModal')">&times;</span><h3 style="color:var(--rose);">ğŸ›‘ Lathe / Turning Lab (Torna)</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="unit-tag">Material</div><select id="latheMat"><option value="steel">Steel (Low Carbon)</option><option value="stainless">Stainless Steel</option><option value="aluminum">Aluminum</option><option value="cast">Cast Iron</option></select><div class="unit-tag">Insert Type</div><select id="latheInsert" onchange="updateLatheDefaults()"><option value="cnmg">CNMG (Roughing - 80Â°)</option><option value="dnmg">DNMG (General - 55Â°)</option><option value="wnmg">WNMG (Economical - 80Â°)</option><option value="vbmt">VBMT (Finishing - 35Â°)</option></select><div class="row"><div style="flex:1"><small>Work Dia (mm)</small><input type="number" id="latheDia" value="50"></div><div style="flex:1"><small>Radius (mm)</small><select id="latheRad"><option value="0.4">0.4</option><option value="0.8" selected>0.8</option><option value="1.2">1.2</option></select></div></div><button onclick="calcLathe()" style="background:var(--rose);">Calculate Turning</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center; text-align:left; padding:15px;"><div style="text-align:center;"><small>Spindle Speed</small><div id="latheRPM" class="result-val" style="color:var(--rose);">0 RPM</div></div><hr style="border:0; border-top:1px dashed var(--border); width:100%; margin:10px 0;"><div><strong>Feed (fn):</strong> <span id="latheFeed">0.25</span> mm/rev</div><div><strong>Depth (ap):</strong> <span id="latheDepth">2.0</span> mm</div><div><strong>Cutting Speed (Vc):</strong> <span id="latheVc">200</span> m/min</div></div></div></div></div>
    <div id="cncModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('cncModal')">&times;</span><h3 style="color:var(--primary);">ğŸ­ Advanced Milling Analyst</h3><div class="grid" style="grid-template-columns: 1fr 1.2fr; gap: 20px;"><div class="input-group"><div class="unit-tag">Cutting Speed (Vc - m/min)</div><select id="matType" onchange="updateCNCDefaults()"><option value="150">Steel - Low Carbon (150)</option><option value="90">Stainless Steel (90)</option><option value="300">Aluminum Alloys (300)</option><option value="45">Titanium Alloys (45)</option><option value="200">Cast Iron (200)</option></select><div class="row"><div style="flex:1"><div class="unit-tag">Tool Diameter (mm)</div><input type="number" id="cncD" value="10"></div><div style="flex:1"><div class="unit-tag">Feed/Tooth (fz - mm)</div><input type="number" id="cncFz" value="0.1"></div></div><div class="unit-tag">Number of Flutes (z)</div><input type="number" id="cncZ" value="4"><button onclick="calcCNC()" style="background:var(--primary);">Calculate Cycles</button><hr style="margin: 15px 0; border: 0; border-top: 1px solid var(--border);"><div class="unit-tag">Metric Tap Reference (Quick Drill Size)</div><select id="tapSizeSelector" onchange="updateTapDrill()"><option value="">Select Metric Tap...</option><option value="2.5">M3 x 0.5</option><option value="3.3">M4 x 0.7</option><option value="4.2">M5 x 0.8</option><option value="5.0">M6 x 1.0</option><option value="6.8">M8 x 1.25</option><option value="8.5">M10 x 1.5</option><option value="10.2">M12 x 1.75</option><option value="12.0">M14 x 2.0</option><option value="14.0">M16 x 2.0</option><option value="17.5">M20 x 2.5</option></select></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center; gap:8px; border-style:solid;"><div><small>Spindle Speed</small><div id="resRPM" class="result-val">0 RPM</div></div><div><small>Feed Rate</small><div id="resFeed" class="result-val">0 mm/min</div></div><div class="multi-unit-res" id="resCNCSfpm">Speed in SFM: 0 ft/min</div><div class="multi-unit-res" style="border-top: 2px solid var(--accent); color: var(--accent); padding-top: 10px; margin-top: 10px;"><small>Recommended Drill Bit for Tap:</small><div id="tapDrillRes" style="font-size: 1.5rem; font-weight: 800;">-- mm</div></div></div></div></div></div>
    <div id="sketchModal" class="modal"><div class="modal-content" style="max-width: 1000px;"><span class="close" onclick="closeModal('sketchModal')">&times;</span><h3 style="color:var(--primary);">ğŸ¨ Precision Design Analyst (2D Pro)</h3><div class="sketch-toolbar"><div style="display:flex; gap:10px;"><button id="btnPoly" class="tool-btn active" onclick="setTool('poly')">ğŸ“ Poly/Line</button><button id="btnCircle" class="tool-btn" onclick="setTool('circle')">â­• Circle</button></div><div style="display:flex; gap:10px; margin-left: 20px;"><button onclick="closePolygon()" style="background:var(--accent); width:auto; padding: 8px 15px; font-size:0.9rem;">Close Path</button><button onclick="clearCanvas()" style="background:var(--danger); width:auto; padding: 8px 15px; font-size:0.9rem;">Clear All</button></div><div class="sketch-stats"><div id="analysisResult" class="result-val" style="color:var(--primary); font-size: 1.2rem;">Total Area: 0 mmÂ²</div><div id="areaInch" style="font-size: 0.8rem; opacity: 0.7;">0 inÂ²</div></div></div><div style="position:relative; background: #0f172a; border-radius: 12px; overflow: hidden; border: 2px solid var(--border); width: 100%; height: 500px;"><canvas id="designCanvas"></canvas><div id="cursorPos" style="position:absolute; bottom:10px; left:10px; color:rgba(255,255,255,0.5); font-size:0.8rem; pointer-events:none;">X:0 Y:0</div></div><p class="analysis-text" style="text-align:center; margin-top:10px;">Poly: Click to add points. Circle: Click center and drag. Lines are auto-dimensioned.</p></div></div>
    <div id="weldingModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('weldingModal')">&times;</span><h3 style="color:var(--orange);">ğŸ”¥ Welding Calculator</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="unit-tag">Process & Material</div><select id="weldType"><option value="stick">SMAW (Stick/Electrode)</option><option value="mig">MIG/MAG</option><option value="tig">TIG</option></select><small>Material Thickness (mm)</small><input type="number" id="weldThick" value="3"><button onclick="calcWeld()" style="background:var(--orange);">Calculate Amps</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center;"><div><small>Recommended Current</small><div id="weldAmps" class="result-val" style="color:var(--orange);">0 - 0 A</div></div><div class="analysis-text" id="weldNote" style="margin-top:10px;">Select process...</div></div></div></div></div>
    <div id="laserModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('laserModal')">&times;</span><h3 style="color:var(--orange);">âš¡ Laser/Plasma Cutting Cost</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="row"><div style="flex:1"><small>Path Length (m)</small><input type="number" id="cutLen" value="2.5"></div><div style="flex:1"><small>Speed (mm/min)</small><input type="number" id="cutSpeed" value="1500"></div></div><div class="row"><div style="flex:1"><small>Hourly Rate ($/â‚¬)</small><input type="number" id="cutRate" value="60"></div><div style="flex:1"><small>Setup Cost</small><input type="number" id="cutSetup" value="10"></div></div><button onclick="calcLaser()" style="background:var(--orange);">Estimate Cost</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center;"><div><small>Estimated Cost</small><div id="cutCostRes" class="result-val" style="color:var(--orange);">0.00</div></div><div class="multi-unit-res">Time: <span id="cutTimeRes">0 min</span></div></div></div></div></div>
    <div id="oringModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('oringModal')">&times;</span><h3 style="color:var(--orange);">â­• O-Ring Groove Calculator</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="unit-tag">O-Ring Dimensions</div><small>Cross Section (W - mm)</small><select id="oringW" onchange="calcOring()"><option value="1.78">1.78 mm</option><option value="2.62">2.62 mm</option><option value="3.53">3.53 mm</option><option value="5.33">5.33 mm</option><option value="6.99">6.99 mm</option></select><div class="unit-tag">Application</div><select id="oringApp"><option value="rod">Rod Seal</option><option value="piston">Piston Seal</option></select><small>Shaft/Bore Diameter (mm)</small><input type="number" id="oringDia" value="50"><button onclick="calcOring()" style="background:var(--orange);">Calculate Groove</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center; text-align:left; padding:15px;"><div><strong>Groove Width:</strong> <span id="grooveW">0.0 mm</span></div><div><strong>Groove Depth:</strong> <span id="grooveD">0.0 mm</span></div><div style="margin-top:5px; border-top:1px dashed var(--border); padding-top:5px;"><strong>Groove Dia:</strong> <span id="grooveDiaRes" style="color:var(--orange);">0.0 mm</span></div></div></div></div></div>
    <div id="sheetModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('sheetModal')">&times;</span><h3 style="color:var(--indigo);">ğŸ“ Sheet Metal Bending</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="row"><div style="flex:1"><small>Thickness (T)</small><input type="number" id="bendT" value="2"></div><div style="flex:1"><small>Inside Radius (R)</small><input type="number" id="bendR" value="2"></div></div><div class="row"><div style="flex:1"><small>Angle (Â°)</small><input type="number" id="bendA" value="90"></div><div style="flex:1"><small>K-Factor</small><input type="number" id="bendK" value="0.33"></div></div><button onclick="calcBend()" style="background:var(--indigo);">Calculate Unfolded</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center;"><div><small>Bend Allowance (BA)</small><div id="bendBA" class="result-val">0.00 mm</div></div><div class="multi-unit-res">Deduction (BD): <span id="bendBD">0.00 mm</span></div></div></div></div></div>
    <div id="hydroModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('hydroModal')">&times;</span><h3 style="color:var(--danger);">ğŸšœ Hydraulic Force Calculator</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="unit-tag">Cylinder Specs</div><small>Bore Diameter (mm)</small><input type="number" id="cylBore" value="80"><small>Rod Diameter (mm)</small><input type="number" id="cylRod" value="40"><small>Pressure (Bar)</small><input type="number" id="cylPress" value="160"><button onclick="calcHydro()" style="background:var(--danger);">Calculate Force</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center; text-align:left; padding:15px;"><div><strong>Push Force:</strong> <span id="pushForce" style="color:var(--danger); font-weight:800;">0 Ton</span></div><div style="margin-top:10px;"><strong>Pull Force:</strong> <span id="pullForce" style="color:var(--text); font-weight:800;">0 Ton</span></div></div></div></div></div>
    <div id="fitsModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('fitsModal')">&times;</span><h3 style="color:var(--purple);">ğŸ”© ISO Fits & Tolerances</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="row"><div style="flex:1"><small>Diameter (mm)</small><input type="number" id="fitDia" value="10"></div><div style="flex:1"><small>Fit Type</small><select id="fitType"><option value="H7g6">H7 / g6 (Sliding)</option><option value="H7h6">H7 / h6 (Clearance)</option><option value="H7k6">H7 / k6 (Transition)</option><option value="H7p6">H7 / p6 (Interference)</option></select></div></div><button onclick="calcFits()" style="background:var(--purple);">Calculate Fit</button></div><div class="result-box" style="text-align:left; padding:15px; display:flex; flex-direction:column; gap:5px;"><div><strong>Hole:</strong> <span id="fitHoleRes">--</span></div><div><strong>Shaft:</strong> <span id="fitShaftRes">--</span></div><div style="margin-top:5px; padding-top:5px; border-top:1px dashed var(--border); color:var(--purple); font-weight:bold;"><span id="fitValRes">--</span></div></div></div></div></div>
    <div id="gcodeModal" class="modal"><div class="modal-content" style="max-width: 800px;"><span class="close" onclick="closeModal('gcodeModal')">&times;</span><h3 style="color:var(--warning);">ğŸ“œ ISO G/M Code Reference</h3><input type="text" id="codeSearch" placeholder="Search codes..." onkeyup="searchCodes()" style="margin-bottom:15px;"><div style="max-height: 400px; overflow-y: auto;"><table id="gCodeTable"><thead><tr><th>Code</th><th>Function</th><th>Description</th></tr></thead><tbody id="codeTableBody"><tr><td>G00</td><td>Rapid Positioning</td><td>High-speed non-cutting movement.</td></tr><tr><td>G01</td><td>Linear Interpolation</td><td>Controlled feed cutting motion (Linear).</td></tr><tr><td>G02</td><td>CW Circular Interpolation</td><td>Clockwise circular arc movement.</td></tr><tr><td>G03</td><td>CCW Circular Interpolation</td><td>Counter-Clockwise circular arc movement.</td></tr><tr><td>G17</td><td>XY Plane Selection</td><td>Selects the XY plane for arcs.</td></tr><tr><td>G18</td><td>ZX Plane Selection</td><td>Selects the ZX plane for arcs.</td></tr><tr><td>G19</td><td>YZ Plane Selection</td><td>Selects the YZ plane for arcs.</td></tr><tr><td>G20</td><td>Inch Unit Selection</td><td>Sets units to inches.</td></tr><tr><td>G21</td><td>Metric Unit Selection</td><td>Sets units to millimeters.</td></tr><tr><td>G28</td><td>Return to Home</td><td>Moves to machine reference point.</td></tr><tr><td>G40</td><td>Cutter Comp Cancel</td><td>Cancels G41/G42 compensation.</td></tr><tr><td>G41</td><td>Cutter Comp Left</td><td>Compensates for tool radius (Left).</td></tr><tr><td>G42</td><td>Cutter Comp Right</td><td>Compensates for tool radius (Right).</td></tr><tr><td>G43</td><td>Tool Length Comp</td><td>Adjusts for tool length offset (H).</td></tr><tr><td>G54</td><td>Work Coordinate 1</td><td>Selects standard work offset 1.</td></tr><tr><td>G81</td><td>Drilling Cycle</td><td>Simple spot drilling cycle.</td></tr><tr><td>G83</td><td>Peck Drilling Cycle</td><td>Deep hole drilling with retraction.</td></tr><tr><td>G90</td><td>Absolute Programming</td><td>Coordinates relative to origin.</td></tr><tr><td>G91</td><td>Incremental Programming</td><td>Coordinates relative to last position.</td></tr><tr><td>M00</td><td>Program Stop</td><td>Pauses the program (Operator resume).</td></tr><tr><td>M01</td><td>Optional Stop</td><td>Pauses if 'Opt Stop' switch is on.</td></tr><tr><td>M03</td><td>Spindle On (CW)</td><td>Starts spindle clockwise.</td></tr><tr><td>M04</td><td>Spindle On (CCW)</td><td>Starts spindle counter-clockwise.</td></tr><tr><td>M05</td><td>Spindle Stop</td><td>Stops the spindle rotation.</td></tr><tr><td>M06</td><td>Tool Change</td><td>Executes tool change sequence (T).</td></tr><tr><td>M08</td><td>Coolant On</td><td>Turns on flood coolant.</td></tr><tr><td>M09</td><td>Coolant Off</td><td>Turns off coolant.</td></tr><tr><td>M30</td><td>Program End</td><td>Ends program and resets to start.</td></tr></tbody></table></div></div></div>
    <div id="gearModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('gearModal')">&times;</span><h3 style="color:var(--primary);">âš™ï¸ Drivetrain & Gear Ratio</h3><div class="grid" style="grid-template-columns: 1fr 1.2fr; gap:20px;"><div class="input-group"><div class="unit-tag">Motor Specs</div><small>Motor RPM (Loaded)</small><input type="number" id="motorRPM" value="4500"><div class="unit-tag">Transmission (Sprockets)</div><div class="row"><div style="flex:1"><small>Driver (T)</small><input type="number" id="gearDriver" value="12"></div><div style="flex:1"><small>Driven (T)</small><input type="number" id="gearDriven" value="54"></div></div><div class="unit-tag">Wheel Size</div><small>Tire Diameter (cm)</small><input type="number" id="tireDia" value="26"><button onclick="calcGearing()" style="background:var(--primary); margin-top:10px;">Calculate Speed</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center; border-style:solid;"><div><small>Theoretical Top Speed</small><div id="speedRes" class="result-val">0 km/h</div></div><div class="row" style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;"><div style="flex:1; text-align:center;"><small>Gear Ratio</small><div id="ratioRes" style="font-weight:bold; color:var(--text);">0 : 1</div></div><div style="flex:1; text-align:center;"><small>Wheel RPM</small><div id="wheelRpmRes" style="font-weight:bold; color:var(--text);">0</div></div></div><div class="multi-unit-res" style="text-align:center; margin-top:10px;">Torque Multiplier: <span id="torqueMult">1.0x</span></div></div></div></div></div>
    <div id="beltModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('beltModal')">&times;</span><h3 style="color:var(--accent);">â›“ï¸ Belt & Pulley Calculator</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="row"><div style="flex:1"><small>Large Dia (D)</small><input type="number" id="beltD" value="100"></div><div style="flex:1"><small>Small Dia (d)</small><input type="number" id="belt_d" value="50"></div></div><div class="unit-tag">Center Distance (C) mm</div><input type="number" id="beltC" value="200"><button onclick="calcBelt()" style="background:var(--accent);">Calculate Length</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center;"><div><small>Belt Pitch Length</small><div id="beltLenRes" class="result-val">0 mm</div></div><div class="analysis-text" style="margin-top:10px;">L â‰ˆ 2C + 1.57(D+d) + (D-d)Â²/4C</div></div></div></div></div>
    <div id="fastenerModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('fastenerModal')">&times;</span><h3 style="color:#64748b;">ğŸ”© ISO Fastener Reference</h3><input type="text" id="fastenerSearch" placeholder="Search M3, M5, Bolt..." onkeyup="searchFasteners()" style="margin-bottom:15px;"><div style="max-height: 400px; overflow-y: auto;"><table id="fastenerTable"><thead><tr><th>Size</th><th>Pitch (mm)</th><th>Tap Drill (mm)</th><th>Clearance (mm)</th><th>Hex Key (mm)</th></tr></thead><tbody id="fastenerBody"><tr><td>M2</td><td>0.4</td><td>1.6</td><td>2.2</td><td>1.5</td></tr><tr><td>M2.5</td><td>0.45</td><td>2.05</td><td>2.7</td><td>2.0</td></tr><tr><td>M3</td><td>0.5</td><td>2.5</td><td>3.4</td><td>2.5</td></tr><tr><td>M4</td><td>0.7</td><td>3.3</td><td>4.5</td><td>3.0</td></tr><tr><td>M5</td><td>0.8</td><td>4.2</td><td>5.5</td><td>4.0</td></tr><tr><td>M6</td><td>1.0</td><td>5.0</td><td>6.6</td><td>5.0</td></tr><tr><td>M8</td><td>1.25</td><td>6.8</td><td>9.0</td><td>6.0</td></tr><tr><td>M10</td><td>1.5</td><td>8.5</td><td>11.0</td><td>8.0</td></tr><tr><td>M12</td><td>1.75</td><td>10.2</td><td>13.5</td><td>10.0</td></tr><tr><td>M16</td><td>2.0</td><td>14.0</td><td>17.5</td><td>14.0</td></tr></tbody></table></div></div></div>
    <div id="weightModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('weightModal')">&times;</span><h3 style="color:var(--accent);">âš–ï¸ Advanced Profile Weight Lab</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="unit-tag">Profile Type</div><select id="profileType" onchange="updateProfileInputs()"><option value="square_hollow">Kutu Profil (Hollow Square)</option><option value="round_hollow">Boru (Hollow Round)</option><option value="l_profile">L KÃ¶ÅŸebent (L Profile)</option><option value="round_solid">Dolu Mil (Round Bar)</option><option value="flat_bar">Lama (Flat Bar)</option></select><div class="unit-tag">Material</div><select id="profileMat"><option value="7.85">Steel (7.85 g/cmÂ³)</option><option value="2.70">Aluminum (2.70 g/cmÂ³)</option><option value="8.0">Stainless Steel (8.0 g/cmÂ³)</option></select><div id="profileInputs"></div><div class="unit-tag">Length (mm)</div><input type="number" id="profL" value="1000"><button onclick="calcProfileWeight()" style="background:var(--accent);">Calculate Weight</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center; border-style:solid; border-color:var(--accent);"><div><small>Calculated Weight</small><div id="profWeightRes" class="result-val" style="color:var(--accent); font-size:2rem;">0.00 kg</div></div><div class="multi-unit-res" id="profWeightLbs">Weight: 0.00 lbs</div><div class="multi-unit-res" id="profWeightNote">Ready for calculation.</div></div></div></div></div>
    <div id="geomModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('geomModal')">&times;</span><h3 style="color:var(--primary);">ğŸ“ Material & Volume Lab</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="unit-tag">Geometry Shape</div><select id="shapeType" onchange="updateGeomInputs()"><option value="cylinder">Cylinder / Rod</option><option value="sphere">Sphere / Ball</option><option value="cube">Rectangular Block</option></select><div class="unit-tag">Material Density (Ï)</div><select id="matDensity"><option value="7.85">Steel (7.85 g/cmÂ³)</option><option value="2.70">Aluminum (2.70 g/cmÂ³)</option><option value="8.96">Copper (8.96 g/cmÂ³)</option><option value="1.20">Plastic/ABS (1.20 g/cmÂ³)</option></select><div id="geomInputs"></div><button onclick="calcGeomVolume()" style="background:var(--primary);">Analyze Physics</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center; border-style:solid;"><div><small>Total Volume</small><div id="geomRes" class="result-val">0 mmÂ³</div></div><div><small>Estimated Mass</small><div id="massRes" class="result-val" style="color:var(--accent)">0 kg</div></div><div class="multi-unit-res" id="massLbs">Mass: 0 lbs</div><div class="multi-unit-res" id="volInches">Volume: 0 inÂ³</div></div></div></div></div>
    <div id="beamModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('beamModal')">&times;</span><h3 style="color:var(--primary);">ğŸ—ï¸ Beam Analysis Pro (Cantilever)</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="unit-tag">Point Load (F - Newton)</div><input type="number" id="beamF" value="1000"><div class="unit-tag">Beam Length (L - mm)</div><input type="number" id="beamL" value="2000"><div class="unit-tag">Elastic Modulus (E - GPa)</div><select id="beamE"><option value="210">Steel (210 GPa)</option><option value="70">Aluminum (70 GPa)</option><option value="110">Titanium (110 GPa)</option></select><div class="unit-tag">Moment of Inertia (I - mmâ´)</div><input type="number" id="beamI" value="100000"><button onclick="calcBeamPro()" style="background:var(--primary);">Analyze Deflection</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center; border-style:solid;"><div><small>Max Tip Deflection</small><div id="resDef" class="result-val">0.00 mm</div></div><div class="analysis-text" style="margin-top:20px;">Formula: $\delta = \frac{F \cdot L^3}{3 \cdot E \cdot I}$</div></div></div></div></div>
    <div id="stressModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('stressModal')">&times;</span><h3 style="color:var(--primary);">ğŸ“ˆ Material Stress Lab</h3><div style="background:var(--card); padding:10px; border:1px solid var(--border); border-radius:15px; text-align:center;"><svg viewBox="0 0 600 400" width="100%" height="auto"><line x1="50" y1="350" x2="550" y2="350" stroke="var(--text)" stroke-width="2" /><line x1="50" y1="350" x2="50" y2="50" stroke="var(--text)" stroke-width="2" /><path d="M50,350 L150,150 Q200,160 250,120 T450,100 T530,250" fill="none" stroke="var(--primary)" stroke-width="4" /><circle cx="150" cy="150" r="6" fill="var(--accent)" class="point-dot" onmouseover="showPoint('proportional')" /><circle cx="200" cy="158" r="6" fill="#f59e0b" class="point-dot" onmouseover="showPoint('yield')" /><circle cx="450" cy="100" r="6" fill="#ef4444" class="point-dot" onmouseover="showPoint('ultimate')" /><circle cx="530" cy="250" r="6" fill="#000" class="point-dot" onmouseover="showPoint('fracture')" /></svg></div><div id="pointDesc" class="analysis-text" style="margin-top:15px;">Hover points for data.</div></div></div>
    <div id="thermModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('thermModal')">&times;</span><h3 style="color:#f97316;">ğŸ”¥ Thermal Expansion (GenleÅŸme)</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><small>Original Length (mm)</small><input type="number" id="thermL" value="100"><div class="row"><div style="flex:1"><small>Temp Change (Î”T Â°C)</small><input type="number" id="thermDT" value="100"></div></div><small>Material</small><select id="thermMat"><option value="12">Steel (12 Âµm/mÂ°C)</option><option value="23">Aluminum (23 Âµm/mÂ°C)</option><option value="17">Copper (17 Âµm/mÂ°C)</option><option value="11">Cast Iron (11 Âµm/mÂ°C)</option></select><button onclick="calcThermal()" style="background:#f97316;">Calculate Î”L</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center;"><div><small>Change in Length (Î”L)</small><div id="thermRes" class="result-val" style="color:#f97316;">0.00 mm</div></div><div class="multi-unit-res">New Length: <span id="thermNewL">0.00 mm</span></div></div></div></div></div>
    <div id="linterpModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('linterpModal')">&times;</span><h3 style="color:var(--accent);">ğŸŒ¡ï¸ Linear Interpolation</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px;"><div class="input-group"><small>Point 1 (x1, y1)</small><div class="row"><input type="number" id="lx1" placeholder="x1"><input type="number" id="ly1" placeholder="y1"></div><small>Point 2 (x2, y2)</small><div class="row"><input type="number" id="lx2" placeholder="x2"><input type="number" id="ly2" placeholder="y2"></div></div><div class="input-group" style="justify-content:center;"><small>Target X</small><input type="number" id="ltx" placeholder="Enter X"><button onclick="calcLinterp()" style="background:var(--accent); margin-top:10px;">Calculate Y</button><div class="result-box"><span id="lres" class="result-val">Y = --</span></div></div></div></div></div>
    <div id="flowModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('flowModal')">&times;</span><h3 style="color:#0ea5e9;">ğŸ’§ Pipe Flow & Velocity</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="unit-tag">Parameters</div><small>Inner Diameter (mm)</small><input type="number" id="pipeID" value="50"><small>Flow Rate (L/min)</small><input type="number" id="pipeQ" value="100"><button onclick="calcFlow()" style="background:#0ea5e9;">Calculate Velocity</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center;"><div><small>Fluid Velocity</small><div id="pipeVel" class="result-val" style="color:#0ea5e9;">0.00 m/s</div></div><div class="analysis-text" style="margin-top:10px;">Recommended: <br>Suction: 0.6-1.2 m/s<br>Pressure: 2-5 m/s</div></div></div></div></div>
    <div id="printModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('printModal')">&times;</span><h3 style="color:var(--accent);">ğŸ–¨ï¸ 3D Print Cost Estimator</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="unit-tag">Filament Info</div><div class="row"><div style="flex:1"><small>Spool Cost ($/TL)</small><input type="number" id="spoolCost" value="400"></div><div style="flex:1"><small>Spool Weight (g)</small><input type="number" id="spoolWeight" value="1000"></div></div><div class="unit-tag">Print Details</div><div class="row"><div style="flex:1"><small>Part Weight (g)</small><input type="number" id="partWeight" value="50"></div><div style="flex:1"><small>Time (Hours)</small><input type="number" id="printTime" value="4"></div></div><div class="unit-tag">Electricity</div><div class="row"><div style="flex:1"><small>Power (Watts)</small><input type="number" id="printerWatts" value="150"></div><div style="flex:1"><small>kWh Cost</small><input type="number" id="kwhCost" value="3.5"></div></div><button onclick="calcPrintCost()" style="background:var(--accent); margin-top:10px;">Calculate</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center; text-align:left; padding:20px;"><div class="multi-unit-res">ğŸ§µ Material Cost: <strong id="resMatCost">0.00</strong></div><div class="multi-unit-res">âš¡ Energy Cost: <strong id="resEnergyCost">0.00</strong></div><hr style="width:100%; border:0; border-top:1px dashed var(--border);"><div style="font-size:1.5rem; font-weight:800; color:var(--accent); text-align:center; margin-top:10px;">Total: <span id="resTotalPrint">0.00</span></div></div></div></div></div>
    <div id="cableModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('cableModal')">&times;</span><h3 style="color:var(--warning);">âš¡ DC Wire Size & Drop</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="row"><div style="flex:1"><small>Voltage (V)</small><input type="number" id="cabV" value="12"></div><div style="flex:1"><small>Current (A)</small><input type="number" id="cabA" value="20"></div></div><div class="row"><div style="flex:1"><small>Length (m)</small><input type="number" id="cabL" value="5"></div><div style="flex:1"><small>Max Drop %</small><input type="number" id="cabDrop" value="3"></div></div><button onclick="calcCable()" style="background:var(--warning); color:#000;">Calculate Cable</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center;"><div><small>Min Cross Section</small><div id="cabResMM" class="result-val">0 mmÂ²</div></div><div class="multi-unit-res">Nearest Standard: <strong id="cabStd">--</strong></div><div class="multi-unit-res" style="color:var(--danger)">Voltage Drop: <span id="cabVDrop">0 V</span></div></div></div></div></div>
    <div id="electroModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('electroModal')">&times;</span><h3 style="color:var(--warning);">âš¡ Electronics & Ohm Lab</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><h4 style="margin:0; font-size:0.9rem;">LED Resistor Calculator</h4><div class="row"><div style="flex:1"><small>Source Voltage (V)</small><input type="number" id="ledVs" value="5"></div><div style="flex:1"><small>LED Forward (V)</small><input type="number" id="ledVf" value="2.0"></div></div><small>LED Current (mA)</small><input type="number" id="ledI" value="20"><button onclick="calcLedResistor()" style="background:var(--warning); color:black;">Calculate Resistor</button><div class="result-box"><span id="resLedOhm" class="result-val" style="color:var(--warning);">0 Î©</span><div style="font-size:0.8rem; margin-top:5px;">Min Power: <span id="resLedPower">0 mW</span></div></div></div><div class="input-group" style="border-left:1px solid var(--border); padding-left:15px;"><h4 style="margin:0; font-size:0.9rem;">Ohm's Law (V = I Ã— R)</h4><small>Voltage (V)</small><input type="number" id="ohmV" placeholder="V" oninput="calcOhm()"><small>Current (A)</small><input type="number" id="ohmI" placeholder="A" oninput="calcOhm()"><small>Resistance (Î©)</small><input type="number" id="ohmR" placeholder="Î©" oninput="calcOhm()"><div class="analysis-text" style="margin-top:10px;">Enter any 2 values to calculate the 3rd.</div></div></div></div></div>
    <div id="stepperModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('stepperModal')">&times;</span><h3 style="color:var(--warning);">ğŸ¤– Stepper Motor & Linear Motion</h3><div class="grid" style="grid-template-columns: 1fr 1fr; gap:20px;"><div class="input-group"><div class="row"><div style="flex:1"><small>Step Angle</small><select id="stepAng"><option value="1.8">1.8Â° (200)</option><option value="0.9">0.9Â° (400)</option></select></div><div style="flex:1"><small>Microstepping</small><select id="stepMicro"><option value="1">1/1</option><option value="2">1/2</option><option value="4">1/4</option><option value="8">1/8</option><option value="16" selected>1/16</option><option value="32">1/32</option></select></div></div><div class="unit-tag">Transmission</div><select id="transType" onchange="toggleTransInput()"><option value="screw">Lead Screw (Pitch mm)</option><option value="belt">Belt (Pulley Pitch x Teeth)</option></select><input type="number" id="transVal" value="8" placeholder="Pitch or Pulley Dia"><button onclick="calcStepper()" style="background:var(--warning); color:#000;">Calculate Steps</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center;"><div><small>Steps per mm</small><div id="stepRes" class="result-val" style="color:var(--warning);">0.00</div></div><div class="multi-unit-res">Resolution: <span id="stepResMicron">0</span> microns</div></div></div></div></div>
    <div id="ebikeModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('ebikeModal')">&times;</span><h3 style="color:var(--accent);">ğŸš² EV Power & Range Dynamics</h3><div class="grid" style="grid-template-columns: 1fr 1.2fr; gap: 20px;"><div class="input-group"><div class="row"><div style="flex:1"><div class="unit-tag">Voltage (V)</div><input type="number" id="evV" value="72"></div><div style="flex:1"><div class="unit-tag">Capacity (Ah)</div><input type="number" id="evAh" value="40"></div></div><div class="row"><div style="flex:1"><div class="unit-tag">Motor (W)</div><input type="number" id="evW" value="3000"></div><div style="flex:1"><div class="unit-tag">Avg Speed (km/h)</div><input type="number" id="evSpd" value="45"></div></div><button onclick="calcMobility()" style="background:var(--accent);">Run Range Simulation</button></div><div class="result-box" style="display:flex; flex-direction:column; justify-content:center; border-style:solid; border-color:var(--accent);"><div><small>Energy Storage</small><div id="resWh" class="result-val">0 Wh</div></div><div><small>Simulated Range</small><div id="resRange" class="result-val">0 km</div></div><div class="multi-unit-res" id="resRangeMi">Range: 0 miles</div><div class="multi-unit-res" id="resRuntime">Full Load Runtime: 0 min</div></div></div></div></div>

    <div id="materialModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('materialModal')">&times;</span>
            <h3 style="color:var(--teal);">ğŸ“š Engineering Materials Library</h3>
            <div class="input-group">
                <input type="text" id="matSearch" placeholder="Search (e.g. 1040, Aluminum, Steel)..." onkeyup="searchMaterials()">
            </div>
            <div style="max-height: 400px; overflow-y: auto; margin-top:15px;">
                <table class="comp-table">
                    <thead><tr><th>Material</th><th>Density (g/cmÂ³)</th><th>Yield Strength (MPa)</th><th>Hardness (Brinell)</th></tr></thead>
                    <tbody id="matTableBody">
                        <tr><td>Steel 1018 (Mild)</td><td>7.87</td><td>370</td><td>126</td></tr>
                        <tr><td>Steel 1040 (Carbon)</td><td>7.85</td><td>415</td><td>201</td></tr>
                        <tr><td>Steel 4140 (Chrome-Moly)</td><td>7.85</td><td>655</td><td>217</td></tr>
                        <tr><td>Stainless 304</td><td>8.00</td><td>215</td><td>123</td></tr>
                        <tr><td>Stainless 316</td><td>8.00</td><td>205</td><td>149</td></tr>
                        <tr><td>Aluminum 6061-T6</td><td>2.70</td><td>276</td><td>95</td></tr>
                        <tr><td>Aluminum 7075-T6</td><td>2.81</td><td>503</td><td>150</td></tr>
                        <tr><td>Brass C360</td><td>8.49</td><td>310</td><td>135</td></tr>
                        <tr><td>Bronze C932 (Bearing)</td><td>8.93</td><td>125</td><td>65</td></tr>
                        <tr><td>Titanium Gr5 (6Al-4V)</td><td>4.43</td><td>880</td><td>334</td></tr>
                        <tr><td>Cast Iron (Gray)</td><td>7.20</td><td>N/A (Brittle)</td><td>180</td></tr>
                        <tr><td>Nylon 6/6</td><td>1.14</td><td>80</td><td>-</td></tr>
                        <tr><td>Delrin (Acetal)</td><td>1.41</td><td>70</td><td>-</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="gdtModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('gdtModal')">&times;</span>
            <h3 style="color:var(--teal);">ğŸ“ GD&T Symbols Reference</h3>
            <p class="analysis-text">Geometric Dimensioning and Tolerancing</p>
            <div class="gdt-grid">
                <div class="gdt-card"><span class="gdt-symbol">â¤</span><span class="gdt-name">Straightness</span><span class="gdt-desc">Form: Line element straightness</span></div>
                <div class="gdt-card"><span class="gdt-symbol">â¥</span><span class="gdt-name">Flatness</span><span class="gdt-desc">Form: Surface evenness</span></div>
                <div class="gdt-card"><span class="gdt-symbol">â—‹</span><span class="gdt-name">Circularity</span><span class="gdt-desc">Form: Roundness of a section</span></div>
                <div class="gdt-card"><span class="gdt-symbol">âŒ­</span><span class="gdt-name">Cylindricity</span><span class="gdt-desc">Form: Roundness along length</span></div>
                <div class="gdt-card"><span class="gdt-symbol">âˆ¥</span><span class="gdt-name">Parallelism</span><span class="gdt-desc">Orientation: Equidistant lines</span></div>
                <div class="gdt-card"><span class="gdt-symbol">âŸ‚</span><span class="gdt-name">Perpendicularity</span><span class="gdt-desc">Orientation: 90Â° angle</span></div>
                <div class="gdt-card"><span class="gdt-symbol">âˆ </span><span class="gdt-name">Angularity</span><span class="gdt-desc">Orientation: Specific angle</span></div>
                <div class="gdt-card"><span class="gdt-symbol">âŠ•</span><span class="gdt-name">Position</span><span class="gdt-desc">Location: True position</span></div>
                <div class="gdt-card"><span class="gdt-symbol">â—</span><span class="gdt-name">Concentricity</span><span class="gdt-desc">Location: Center alignment</span></div>
                <div class="gdt-card"><span class="gdt-symbol">â†—</span><span class="gdt-name">Runout</span><span class="gdt-desc">Runout: Circular deviation</span></div>
            </div>
        </div>
    </div>

    <div id="surfaceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('surfaceModal')">&times;</span>
            <h3 style="color:var(--teal);">ã€°ï¸ Surface Roughness Conversion</h3>
            <table class="comp-table">
                <thead><tr><th>N-Grade</th><th>Ra (Âµm)</th><th>Ra (Âµin)</th><th>Typical Process</th></tr></thead>
                <tbody>
                    <tr><td>N12</td><td>50</td><td>2000</td><td>Flame Cut, Sawing</td></tr>
                    <tr><td>N11</td><td>25</td><td>1000</td><td>Sand Casting, Sawing</td></tr>
                    <tr><td>N10</td><td>12.5</td><td>500</td><td>Die Casting, Planing</td></tr>
                    <tr><td>N9</td><td>6.3</td><td>250</td><td>Drilling, Rough Turning</td></tr>
                    <tr><td>N8</td><td>3.2</td><td>125</td><td>Milling, Fine Turning</td></tr>
                    <tr><td>N7</td><td>1.6</td><td>63</td><td>Reaming, Broaching, Grinding</td></tr>
                    <tr><td>N6</td><td>0.8</td><td>32</td><td>Grinding, Honing</td></tr>
                    <tr><td>N5</td><td>0.4</td><td>16</td><td>Lapping, Polishing</td></tr>
                    <tr><td>N4</td><td>0.2</td><td>8</td><td>Superfinishing</td></tr>
                    <tr><td>N3</td><td>0.1</td><td>4</td><td>Mirror Finish</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('infoModal')">&times;</span>
            <h3 style="color:var(--primary);">ğŸ›‘ Torna (Turning) vs ğŸ­ Freze (Milling)</h3>
            <p class="analysis-text">Comparison of basic machining processes.</p>
            <div style="overflow-x:auto;">
                <table class="comp-table">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>ğŸ›‘ Turning (Lathe)</th>
                            <th>ğŸ­ Milling</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Principle</strong></td>
                            <td>Workpiece rotates, Tool moves.</td>
                            <td>Tool rotates, Workpiece moves.</td>
                        </tr>
                        <tr>
                            <td><strong>Part Shape</strong></td>
                            <td>Cylindrical (Shaft, Tube).</td>
                            <td>Prismatic (Block, Plate).</td>
                        </tr>
                        <tr>
                            <td><strong>Feed Unit</strong></td>
                            <td>mm/rev (G95)</td>
                            <td>mm/min (G94)</td>
                        </tr>
                        <tr>
                            <td><strong>Common Tools</strong></td>
                            <td>DNMG, CNMG (Single Point)</td>
                            <td>End Mill, Face Mill (Multi Point)</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="disclaimer-bar">âš ï¸ Safety Warning: All calculations are for reference only. Verify with official standards before critical manufacturing.</div>

    <footer class="info-footer">
        <h3>ğŸ“– About Unitly Lab</h3>
        <p>A comprehensive engineering data and manufacturing simulation suite.</p>
        <p style="margin-top:10px; opacity:0.4; font-size:0.7rem;">&copy; 2026 Unitly Lab</p>
    </footer>
</div>

<script>
    // --- HELPER FUNCTIONS (VALIDATION) ---
    function safeFloat(id, def = 0) {
        const el = document.getElementById(id);
        if(!el) return def;
        const val = parseFloat(el.value);
        return isNaN(val) ? def : val;
    }

    // --- GENERAL ---
    function initTheme() {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('checkbox').checked = true;
        }
    }
    initTheme();

    function toggleTheme() {
        const isChecked = document.getElementById('checkbox').checked;
        isChecked ? document.body.setAttribute('data-theme', 'dark') : document.body.removeAttribute('data-theme');
    }
    function toggleDropdown(id) { 
        var dropdowns = document.getElementsByClassName("dropdown-content");
        for (var i = 0; i < dropdowns.length; i++) {
            if (dropdowns[i].id !== id) {
                dropdowns[i].classList.remove('show');
            }
        }
        document.getElementById(id).classList.toggle("show"); 
    }
    function openModal(id) { 
        document.getElementById(id).style.display = "block"; 
        if(id === 'sketchModal') {
             setTimeout(() => {
                 initCanvas();
                 resizeCanvas(); // Ensure correct size on open
             }, 100);
        }
        if(id === 'threeModal') {
            setTimeout(() => {
                init3D();
                animate3D(); // Restart loop
            }, 100);
        }
        if(id === 'geomModal') updateGeomInputs();
        if(id === 'weightModal') updateProfileInputs();
        if(id === 'fitsModal') calcFits(); 
        if(id === 'latheModal') calcLathe();
    }
    
    function closeModal(id) { 
        document.getElementById(id).style.display = "none";
        // Stop 3D animation to save battery
        if(id === 'threeModal') {
             if(reqAnimId) cancelAnimationFrame(reqAnimId);
             isLineDrawing = false;
        }
    }

    // --- Search Materials ---
    function searchMaterials() {
        let input = document.getElementById('matSearch').value.toUpperCase();
        let rows = document.getElementById('matTableBody').getElementsByTagName('tr');
        for (let row of rows) {
             row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none";
        }
    }

    // --- 3D STUDIO (THREE.JS - OPTIMIZED) ---
    let scene, camera, renderer, currentLine, raycaster, drawingPlane;
    let is3DInitialized = false;
    let isLineDrawing = false;
    let reqAnimId;

    function init3D() {
        if (is3DInitialized) return;
        const container = document.getElementById('threeContainer');
        
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        scene.fog = new THREE.Fog(0x111111, 10, 80);

        // Grid
        const gridHelper = new THREE.GridHelper(100, 100, 0x444444, 0x222222);
        scene.add(gridHelper);
        const axesHelper = new THREE.AxesHelper(5);
        scene.add(axesHelper);

        // Invisible Plane for Drawing
        const planeGeo = new THREE.PlaneGeometry(100, 100);
        const planeMat = new THREE.MeshBasicMaterial({ visible: false });
        drawingPlane = new THREE.Mesh(planeGeo, planeMat);
        drawingPlane.rotation.x = -Math.PI / 2;
        scene.add(drawingPlane);

        camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(10, 10, 10);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        // Lights
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(10, 10, 10);
        scene.add(dirLight);

        // Events
        raycaster = new THREE.Raycaster();
        renderer.domElement.addEventListener('click', on3DClick);
        
        // Basic Orbit Control (Simplified)
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };

        container.addEventListener('mousedown', (e) => { if(!isLineDrawing) isDragging = true; });
        container.addEventListener('mouseup', (e) => { isDragging = false; });
        container.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaMove = { x: e.offsetX - previousMousePosition.x, y: e.offsetY - previousMousePosition.y };
                const deltaRotationQuaternion = new THREE.Quaternion().setFromEuler(new THREE.Euler(toRadians(deltaMove.y * 0.5), toRadians(deltaMove.x * 0.5), 0, 'XYZ'));
                scene.quaternion.multiplyQuaternions(deltaRotationQuaternion, scene.quaternion);
            }
            previousMousePosition = { x: e.offsetX, y: e.offsetY };
        });

        // Touch
        container.addEventListener('touchstart', (e) => { if(!isLineDrawing) { isDragging = true; previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY }; } });
        container.addEventListener('touchmove', (e) => {
             if (isDragging) {
                const deltaMove = { x: e.touches[0].clientX - previousMousePosition.x, y: e.touches[0].clientY - previousMousePosition.y };
                const deltaRotationQuaternion = new THREE.Quaternion().setFromEuler(new THREE.Euler(toRadians(deltaMove.y * 0.5), toRadians(deltaMove.x * 0.5), 0, 'XYZ'));
                scene.quaternion.multiplyQuaternions(deltaRotationQuaternion, scene.quaternion);
                previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        });
        container.addEventListener('touchend', (e) => { isDragging = false; });

        is3DInitialized = true;
    }

    function toggle3DDrawMode() {
        isLineDrawing = !isLineDrawing;
        const btn = document.getElementById('btn3DDraw');
        btn.classList.toggle('active', isLineDrawing);
        btn.innerText = isLineDrawing ? "ğŸ›‘ Stop Drawing" : "âœï¸ Draw Line Mode";
        
        if(isLineDrawing) {
            // Start new line geometry
            const geometry = new THREE.BufferGeometry();
            const material = new THREE.LineBasicMaterial({ color: 0x10b981, linewidth: 2 });
            currentLine = new THREE.Line(geometry, material);
            scene.add(currentLine);
        } else {
            currentLine = null;
        }
    }

    function on3DClick(event) {
        if (!isLineDrawing || !currentLine) return;
        
        // FIX: Calculate mouse position accurately relative to the canvas in the modal
        const rect = renderer.domElement.getBoundingClientRect();
        const mouse = new THREE.Vector2();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObject(drawingPlane);

        if (intersects.length > 0) {
            const point = intersects[0].point;
            // Snap to grid
            point.x = Math.round(point.x);
            point.z = Math.round(point.z);
            point.y = 0; 

            // Add point to line
            const positions = currentLine.geometry.attributes.position ? Array.from(currentLine.geometry.attributes.position.array) : [];
            positions.push(point.x, point.y + 0.1, point.z); 
            currentLine.geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        }
    }

    function set3DView(view) {
        scene.rotation.set(0,0,0);
        scene.quaternion.set(0,0,0,1);

        if(view === 'top') {
            camera.position.set(0, 20, 0); camera.lookAt(0, 0, 0);
        } else if(view === 'front') {
            camera.position.set(0, 0, 20); camera.lookAt(0, 0, 0);
        } else if(view === 'right') {
            camera.position.set(20, 0, 0); camera.lookAt(0, 0, 0);
        } else { 
            camera.position.set(10, 10, 10); camera.lookAt(0, 0, 0);
        }
    }

    function toRadians(angle) { return angle * (Math.PI / 180); }
    
    function animate3D() {
        if(document.getElementById('threeModal').style.display !== 'block') return; // Stop if hidden
        reqAnimId = requestAnimationFrame(animate3D);
        renderer.render(scene, camera);
    }
    
    function add3DCube() {
        const geometry = new THREE.BoxGeometry(2, 2, 2);
        const material = new THREE.MeshPhongMaterial({ color: 0x2563eb, flatShading: true });
        const obj = new THREE.Mesh(geometry, material);
        obj.position.y = 1; scene.add(obj);
    }
    function add3DCylinder() {
        const geometry = new THREE.CylinderGeometry(1, 1, 4, 32);
        const material = new THREE.MeshPhongMaterial({ color: 0x10b981, flatShading: true });
        const obj = new THREE.Mesh(geometry, material);
        obj.position.y = 2; scene.add(obj);
    }
    function clear3D() {
        for( let i = scene.children.length - 1; i >= 0; i--) { 
             let obj = scene.children[i];
             if(obj.type === 'Mesh' || obj.type === 'Line') scene.remove(obj); 
        }
        isLineDrawing = false;
        document.getElementById('btn3DDraw').classList.remove('active');
        document.getElementById('btn3DDraw').innerText = "âœï¸ Draw Line Mode";
    }
    function toggleWireframe() {
        scene.children.forEach(c => {
            if(c.type === 'Mesh') { c.material.wireframe = !c.material.wireframe; }
        });
    }

    // --- CALCULATOR LOGIC (UPDATED WITH VALIDATION) ---
    function updateProfileInputs() {
        const type = document.getElementById('profileType').value;
        let html = '';
        if(type === 'square_hollow') html = '<div class="row"><div><small>Width (mm)</small><input type="number" id="pW" value="40"></div><div><small>Thickness (mm)</small><input type="number" id="pT" value="2"></div></div>';
        else if(type === 'round_hollow') html = '<div class="row"><div><small>Diameter (mm)</small><input type="number" id="pD" value="30"></div><div><small>Thickness (mm)</small><input type="number" id="pT" value="2"></div></div>';
        else if(type === 'l_profile') html = '<div class="row"><div><small>A (mm)</small><input type="number" id="pW" value="40"></div><div><small>B (mm)</small><input type="number" id="pH" value="40"></div><div><small>t (mm)</small><input type="number" id="pT" value="4"></div></div>';
        else if(type === 'round_solid') html = '<small>Diameter (mm)</small><input type="number" id="pD" value="20">';
        else html = '<div class="row"><div><small>Width (mm)</small><input type="number" id="pW" value="50"></div><div><small>Height (mm)</small><input type="number" id="pH" value="10"></div></div>';
        document.getElementById('profileInputs').innerHTML = html;
    }

    function calcProfileWeight() {
        const type = document.getElementById('profileType').value;
        const rho = safeFloat('profileMat', 7.85);
        const L = safeFloat('profL', 1000);
        let area = 0; 
        if(type === 'square_hollow') {
            const w = safeFloat('pW');
            const t = safeFloat('pT');
            area = (w * w) - ((w - 2*t) * (w - 2*t));
        } else if(type === 'round_hollow') {
            const d = safeFloat('pD');
            const t = safeFloat('pT');
            area = (Math.PI/4) * (Math.pow(d, 2) - Math.pow(d - 2*t, 2));
        } else if(type === 'l_profile') {
            const a = safeFloat('pW');
            const b = safeFloat('pH');
            const t = safeFloat('pT');
            area = (a * t) + ((b - t) * t);
        } else if(type === 'round_solid') {
            const d = safeFloat('pD');
            area = (Math.PI/4) * Math.pow(d, 2);
        } else {
            const w = safeFloat('pW');
            const h = safeFloat('pH');
            area = w * h;
        }
        if(area < 0) area = 0;
        const massKg = (area * L * rho) / 1000000;
        document.getElementById('profWeightRes').innerText = massKg.toFixed(2) + " kg";
        document.getElementById('profWeightLbs').innerText = "Weight: " + (massKg * 2.204).toFixed(2) + " lbs";
        document.getElementById('profWeightNote').innerText = "Volume: " + Math.round(area * L) + " mmÂ³";
    }

    const pointData = {
        'proportional': '<strong>Proportional Limit:</strong> Linear elastic region ends here. Hooke\'s Law applies.',
        'yield': '<strong>Yield Point:</strong> Transition from elastic to plastic deformation.',
        'ultimate': '<strong>Ultimate Tensile Strength (UTS):</strong> Max stress before necking.',
        'fracture': '<strong>Fracture Point:</strong> Material breaks.'
    };

    function convert(type) {
        const val = safeFloat(type + 'Input', 0);
        const from = parseFloat(document.getElementById(type + 'From').value);
        const to = parseFloat(document.getElementById(type + 'To').value);
        const res = val * from / to;
        document.getElementById(type + 'Res').innerText = res < 0.01 && res !== 0 ? res.toExponential(4) : res.toLocaleString();
    }
    function updateTapDrill() {
        const val = document.getElementById('tapSizeSelector').value;
        document.getElementById('tapDrillRes').innerText = val ? val + " mm" : "-- mm";
    }
    function updateCNCDefaults() {}

    function calcCNC() {
        const vc = safeFloat('matType', 150);
        const d = safeFloat('cncD', 10);
        const fz = safeFloat('cncFz', 0.1);
        const z = safeFloat('cncZ', 4);
        if(d <= 0) return;
        const rpm = (vc * 1000) / (Math.PI * d);
        const feed = rpm * fz * z;
        document.getElementById('resRPM').innerText = Math.round(rpm) + " RPM";
        document.getElementById('resFeed').innerText = Math.round(feed) + " mm/min";
        document.getElementById('resCNCSfpm').innerText = `Speed in SFM: ${Math.round(vc * 3.28)} ft/min`;
    }
    function updateGeomInputs() {
        const type = document.getElementById('shapeType').value;
        let html = '';
        if(type === 'cylinder') html = '<div class="row"><div><small>Radius (mm)</small><input type="number" id="gR" value="10"></div><div><small>Length (mm)</small><input type="number" id="gL" value="100"></div></div>';
        else if(type === 'sphere') html = '<small>Radius (mm)</small><input type="number" id="gR" value="10">';
        else html = '<div class="row"><div><small>L (mm)</small><input type="number" id="gL" value="10"></div><div><small>W (mm)</small><input type="number" id="gW" value="10"></div><div><small>H (mm)</small><input type="number" id="gH" value="10"></div></div>';
        document.getElementById('geomInputs').innerHTML = html;
    }
    function calcGeomVolume() {
        const type = document.getElementById('shapeType').value;
        const rho = safeFloat('matDensity', 7.85);
        let vol = 0;
        if(type === 'cylinder') vol = Math.PI * Math.pow(safeFloat('gR'), 2) * safeFloat('gL');
        else if(type === 'sphere') vol = (4/3) * Math.PI * Math.pow(safeFloat('gR'), 3);
        else vol = safeFloat('gL') * safeFloat('gW') * safeFloat('gH');
        const mass = (vol / 1000) * (rho / 1000); 
        document.getElementById('geomRes').innerText = Math.round(vol).toLocaleString() + " mmÂ³";
        document.getElementById('massRes').innerText = mass.toFixed(3) + " kg";
        document.getElementById('massLbs').innerText = `Mass: ${(mass * 2.204).toFixed(3)} lbs`;
        document.getElementById('volInches').innerText = `Volume: ${(vol / 16387).toFixed(3)} inÂ³`;
    }
    function calcMobility() {
        const v = safeFloat('evV', 72);
        const ah = safeFloat('evAh', 40);
        const w = safeFloat('evW', 3000);
        const spd = safeFloat('evSpd', 45);
        if(spd <= 0 || w <= 0) return;
        const wh = v * ah;
        const range = ((wh * 0.85) / (w / spd));
        const runtime = ((wh * 0.85) / w) * 60;
        document.getElementById('resWh').innerText = wh + " Wh";
        document.getElementById('resRange').innerText = range.toFixed(1) + " km";
        document.getElementById('resRangeMi').innerText = `Range: ${(range * 0.621).toFixed(1)} miles`;
        document.getElementById('resRuntime').innerText = `Full Load Runtime: ${Math.round(runtime)} min`;
    }
    function calcBeamPro() {
        const F = safeFloat('beamF');
        const L = safeFloat('beamL');
        const E_GPa = safeFloat('beamE');
        const I = safeFloat('beamI');
        if(I <= 0) return;
        const E = E_GPa * 1000;
        const def = (F * Math.pow(L, 3)) / (3 * E * I);
        document.getElementById('resDef').innerText = def.toFixed(2) + " mm";
    }
    function showPoint(id) { document.getElementById('pointDesc').innerHTML = pointData[id]; }
    function calcFin() {
        const p = safeFloat('pCap'), r = safeFloat('pRate'), t = safeFloat('pTime');
        document.getElementById('finRes').innerText = ((p*r*t)/1200).toLocaleString();
    }
    function searchCodes() {
        let input = document.getElementById('codeSearch').value.toUpperCase();
        let rows = document.getElementById('codeTableBody').getElementsByTagName('tr');
        for (let row of rows) { if (row.cells.length > 1) { row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none"; } }
    }
    function searchFasteners() {
        let input = document.getElementById('fastenerSearch').value.toUpperCase();
        let rows = document.getElementById('fastenerBody').getElementsByTagName('tr');
        for (let row of rows) { row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none"; }
    }
    
    function calcGearing() {
        const rpm = safeFloat('motorRPM');
        const driver = safeFloat('gearDriver');
        const driven = safeFloat('gearDriven');
        const diaCm = safeFloat('tireDia');
        if(driver <= 0) return;
        const ratio = driven / driver;
        const wheelRpm = rpm / ratio;
        const circumference = Math.PI * diaCm; // cm
        const speedKmh = (wheelRpm * circumference * 60) / 100000;
        document.getElementById('speedRes').innerText = speedKmh.toFixed(1) + " km/h";
        document.getElementById('ratioRes').innerText = ratio.toFixed(2) + " : 1";
        document.getElementById('wheelRpmRes').innerText = Math.round(wheelRpm);
        document.getElementById('torqueMult').innerText = ratio.toFixed(2) + "x";
    }

    function calcPrintCost() {
        const spoolCost = safeFloat('spoolCost');
        const spoolWeight = safeFloat('spoolWeight');
        const partWeight = safeFloat('partWeight');
        const time = safeFloat('printTime');
        const watts = safeFloat('printerWatts');
        const kwhPrice = safeFloat('kwhCost');
        if(spoolWeight <= 0) return;
        const matCost = (partWeight / spoolWeight) * spoolCost;
        const energyCost = (watts / 1000) * time * kwhPrice;
        const total = matCost + energyCost;
        document.getElementById('resMatCost').innerText = matCost.toFixed(2);
        document.getElementById('resEnergyCost').innerText = energyCost.toFixed(2);
        document.getElementById('resTotalPrint').innerText = total.toFixed(2);
    }

    function calcLedResistor() {
        const vs = safeFloat('ledVs');
        const vf = safeFloat('ledVf');
        const i = safeFloat('ledI') / 1000; // mA to A
        if(i <= 0 || vs <= vf) { document.getElementById('resLedOhm').innerText = "Error"; return; }
        const r = (vs - vf) / i;
        const p = Math.pow(i, 2) * r;
        document.getElementById('resLedOhm').innerText = Math.round(r) + " Î©";
        document.getElementById('resLedPower').innerText = (p * 1000).toFixed(0) + " mW";
    }

    function calcOhm() {
        const v = parseFloat(document.getElementById('ohmV').value);
        const i = parseFloat(document.getElementById('ohmI').value);
        const r = parseFloat(document.getElementById('ohmR').value);
        // Using direct parsing here to allow clearing fields
        if(!isNaN(v) && !isNaN(i)) document.getElementById('ohmR').value = v / i;
        else if(!isNaN(v) && !isNaN(r)) document.getElementById('ohmI').value = v / r;
        else if(!isNaN(i) && !isNaN(r)) document.getElementById('ohmV').value = i * r;
    }

    function calcFits() {
        const dia = safeFloat('fitDia', 10);
        const type = document.getElementById('fitType').value;
        let holeMax=0, holeMin=0, shaftMax=0, shaftMin=0, valText = "";
        const baseTol = Math.pow(dia, 0.45) * 0.001 * 15; 
        if(type === 'H7g6') {
            holeMax = baseTol; holeMin = 0;
            shaftMax = -baseTol * 0.4; shaftMin = -baseTol * 1.2;
            valText = "Clearance / Sliding Fit";
        } else if(type === 'H7h6') {
            holeMax = baseTol; holeMin = 0;
            shaftMax = 0; shaftMin = -baseTol * 0.8;
            valText = "Clearance Fit";
        } else if(type === 'H7k6') {
            holeMax = baseTol; holeMin = 0;
            shaftMax = baseTol * 0.6; shaftMin = baseTol * 0.1;
            valText = "Transition Fit";
        } else if(type === 'H7p6') {
            holeMax = baseTol; holeMin = 0;
            shaftMax = baseTol * 1.5; shaftMin = baseTol * 0.9;
            valText = "Interference Fit (Press)";
        }
        document.getElementById('fitHoleRes').innerText = `+${(holeMax*1000).toFixed(1)} / +${(holeMin*1000).toFixed(1)} Âµm`;
        document.getElementById('fitShaftRes').innerText = `${(shaftMax*1000 > 0 ? '+' : '')}${(shaftMax*1000).toFixed(1)} / ${(shaftMin*1000 > 0 ? '+' : '')}${(shaftMin*1000).toFixed(1)} Âµm`;
        document.getElementById('fitValRes').innerText = valText;
    }

    function calcBelt() {
        const D = safeFloat('beltD');
        const d = safeFloat('belt_d');
        const C = safeFloat('beltC');
        if(C <= 0) return;
        const L = (2 * C) + (1.57 * (D + d)) + (Math.pow(D - d, 2) / (4 * C));
        document.getElementById('beltLenRes').innerText = Math.round(L) + " mm";
    }

    function calcStepper() {
        const deg = safeFloat('stepAng');
        const micro = safeFloat('stepMicro');
        const pitch = safeFloat('transVal');
        if(pitch === 0) return;
        const stepsPerRev = (360 / deg) * micro;
        const stepsPerUnit = stepsPerRev / pitch;
        document.getElementById('stepRes').innerText = stepsPerUnit.toFixed(2);
        document.getElementById('stepResMicron').innerText = (1000 / stepsPerUnit).toFixed(2);
    }

    function calcLinterp() {
        const x1 = safeFloat('lx1');
        const y1 = safeFloat('ly1');
        const x2 = safeFloat('lx2');
        const y2 = safeFloat('ly2');
        const x = safeFloat('ltx');
        if (x2 === x1) { document.getElementById('lres').innerText = "Error (x1=x2)"; return; }
        const y = y1 + ((x - x1) * (y2 - y1) / (x2 - x1));
        document.getElementById('lres').innerText = "Y = " + y.toFixed(4);
    }

    function calcHydro() {
        const bore = safeFloat('cylBore');
        const rod = safeFloat('cylRod');
        const bar = safeFloat('cylPress');
        const areaPush = Math.PI * Math.pow(bore/20, 2); 
        const areaPull = areaPush - (Math.PI * Math.pow(rod/20, 2));
        const fPush = (bar * areaPush) / 1000;
        const fPull = (bar * areaPull) / 1000;
        document.getElementById('pushForce').innerText = fPush.toFixed(2) + " Ton";
        document.getElementById('pullForce').innerText = fPull.toFixed(2) + " Ton";
    }

    function calcCable() {
        const v = safeFloat('cabV');
        const i = safeFloat('cabA');
        const l = safeFloat('cabL'); 
        const dropPerc = safeFloat('cabDrop');
        if(dropPerc <= 0) return;
        const maxDropV = v * (dropPerc / 100);
        const section = (2 * l * i * 0.0175) / maxDropV;
        document.getElementById('cabResMM').innerText = section.toFixed(2) + " mmÂ²";
        document.getElementById('cabVDrop').innerText = maxDropV.toFixed(2) + " V";
        const standards = [0.5, 0.75, 1.0, 1.5, 2.5, 4, 6, 10, 16, 25, 35, 50];
        let std = "Custom";
        for(let s of standards) { if(s >= section) { std = s + " mmÂ²"; break; } }
        document.getElementById('cabStd').innerText = std;
    }

    function calcBend() {
        const T = safeFloat('bendT');
        const R = safeFloat('bendR');
        const A = safeFloat('bendA');
        const K = safeFloat('bendK');
        const radA = A * (Math.PI / 180);
        const BA = radA * (R + (K * T));
        const OSSB = (R + T) * Math.tan(radA / 2);
        const BD = (2 * OSSB) - BA;
        document.getElementById('bendBA').innerText = BA.toFixed(2) + " mm";
        document.getElementById('bendBD').innerText = BD.toFixed(2) + " mm";
    }

    function calcFlow() {
        const id = safeFloat('pipeID'); 
        const Q_lmin = safeFloat('pipeQ');
        const d_m = id / 1000;
        const Q_m3s = Q_lmin / 60000;
        const Area = Math.PI * Math.pow(d_m / 2, 2);
        const vel = Area > 0 ? Q_m3s / Area : 0;
        document.getElementById('pipeVel').innerText = vel.toFixed(2) + " m/s";
    }

    function calcThermal() {
        const L = safeFloat('thermL');
        const dT = safeFloat('thermDT');
        const alpha = safeFloat('thermMat') * 0.000001; 
        const dL = L * alpha * dT;
        const newL = L + dL;
        document.getElementById('thermRes').innerText = (dL * 1000).toFixed(1) + " Âµm (" + dL.toFixed(3) + " mm)";
        document.getElementById('thermNewL').innerText = newL.toFixed(3) + " mm";
    }

    function calcWeld() {
        const type = document.getElementById('weldType').value;
        const t = safeFloat('weldThick');
        let ampMin = 0, ampMax = 0, note = "";
        if (type === 'stick') {
            ampMin = t * 30; ampMax = t * 40;
            note = "Electrode: ~" + (t/2 + 1).toFixed(1) + "mm";
        } else if (type === 'mig') {
            ampMin = t * 35; ampMax = t * 45;
            note = "Wire: 0.8mm - 1.0mm";
        } else if (type === 'tig') {
            ampMin = t * 30; ampMax = t * 35;
            note = "Tungsten: 1.6mm - 2.4mm";
        }
        document.getElementById('weldAmps').innerText = Math.round(ampMin) + " - " + Math.round(ampMax) + " A";
        document.getElementById('weldNote').innerText = note;
    }

    function calcLaser() {
        const len = safeFloat('cutLen'); 
        const speed = safeFloat('cutSpeed'); 
        const rate = safeFloat('cutRate'); 
        const setup = safeFloat('cutSetup'); 
        if(speed <= 0) return;
        const lenMM = len * 1000;
        const timeMin = lenMM / speed;
        const cost = (timeMin / 60) * rate + setup;
        document.getElementById('cutCostRes').innerText = cost.toFixed(2);
        document.getElementById('cutTimeRes').innerText = timeMin.toFixed(1) + " min";
    }

    function calcOring() {
        const w = safeFloat('oringW');
        const type = document.getElementById('oringApp').value;
        const dia = safeFloat('oringDia');
        const compress = 0.85; 
        const glandDepth = w * compress;
        const grooveWidth = w * 1.3; 
        let grooveDia = 0;
        if(type === 'rod') {
            document.getElementById('grooveD').innerText = glandDepth.toFixed(2) + " mm";
            document.getElementById('grooveW').innerText = grooveWidth.toFixed(2) + " mm";
            grooveDia = dia + (2 * glandDepth); 
            document.getElementById('grooveDiaRes').innerText = grooveDia.toFixed(2) + " mm";
        } else {
             document.getElementById('grooveD').innerText = glandDepth.toFixed(2) + " mm";
             document.getElementById('grooveW').innerText = grooveWidth.toFixed(2) + " mm";
             grooveDia = dia - (2 * glandDepth);
             document.getElementById('grooveDiaRes').innerText = grooveDia.toFixed(2) + " mm";
        }
    }

    function updateLatheDefaults() { }

    function calcLathe() {
        const mat = document.getElementById('latheMat').value;
        const insert = document.getElementById('latheInsert').value;
        const dia = safeFloat('latheDia', 50);
        const rad = safeFloat('latheRad', 0.8);
        if(dia <= 0) return;

        const speedDB = {
            'steel': { 'cnmg': 220, 'dnmg': 240, 'wnmg': 200, 'vbmt': 280 },
            'stainless': { 'cnmg': 160, 'dnmg': 180, 'wnmg': 150, 'vbmt': 200 },
            'aluminum': { 'cnmg': 400, 'dnmg': 450, 'wnmg': 350, 'vbmt': 500 },
            'cast': { 'cnmg': 180, 'dnmg': 200, 'wnmg': 170, 'vbmt': 220 }
        };
        let feed = 0.15; 
        let depth = 1.0; 
        if(insert === 'cnmg' || insert === 'wnmg') { feed = 0.25; depth = 2.5; }
        else if(insert === 'vbmt') { feed = 0.1; depth = 0.5; }
        else { feed = 0.2; depth = 1.5; }
        if(rad > 0.8) feed *= 1.2;
        if(rad < 0.4) feed *= 0.8;
        const Vc = speedDB[mat][insert] || 200;
        const rpm = (Vc * 1000) / (Math.PI * dia);
        document.getElementById('latheRPM').innerText = Math.round(rpm) + " RPM";
        document.getElementById('latheFeed').innerText = feed.toFixed(2);
        document.getElementById('latheDepth').innerText = depth.toFixed(1);
        document.getElementById('latheVc').innerText = Vc;
    }

    // --- SKETCH 2D LOGIC ---
    let canvas, ctx, shapes = [], points = [], activeTool = 'poly', isDrawing = false, startPoint = null, tempPoint = null;

    function initCanvas() {
        canvas = document.getElementById('designCanvas');
        if(!canvas) return;
        ctx = canvas.getContext('2d');
        resizeCanvas();

        // FIX: Re-bind events to ensure they don't stack up if init called multiple times
        canvas.removeEventListener('mousedown', handleStart);
        canvas.removeEventListener('mousemove', handleMove);
        canvas.removeEventListener('mouseup', handleEnd);

        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('touchstart', handleStart, {passive: false});
        canvas.addEventListener('touchmove', handleMove, {passive: false});
        canvas.addEventListener('touchend', handleEnd);
    }
    
    // FIX: Canvas Resize Logic
    function resizeCanvas() {
        if(!canvas) return;
        // Check if modal is visible to avoid 0 width
        if(canvas.parentElement.offsetWidth > 0) {
            canvas.width = canvas.parentElement.offsetWidth; 
            canvas.height = 500; 
            drawCanvas(); 
        }
    }
    
    window.addEventListener('resize', () => {
         if(document.getElementById('sketchModal').style.display === 'block') {
             resizeCanvas();
         }
    });

    function getCoords(e) {
        e.preventDefault(); 
        const rect = canvas.getBoundingClientRect();
        let x, y;
        if (e.touches && e.touches.length > 0) { x = e.touches[0].clientX - rect.left; y = e.touches[0].clientY - rect.top; }
        else { x = e.clientX - rect.left; y = e.clientY - rect.top; }
        return {x, y};
    }
    function handleStart(e) {
        const coords = getCoords(e);
        if(activeTool === 'poly') { points.push(coords); startPoint = coords; } 
        else if(activeTool === 'circle') { isDrawing = true; startPoint = coords; }
        drawCanvas();
    }
    function handleMove(e) {
        const coords = getCoords(e);
        tempPoint = coords;
        document.getElementById('cursorPos').innerText = `X:${Math.round(coords.x)} Y:${Math.round(coords.y)}`;
        drawCanvas();
    }
    function handleEnd(e) {
        if(activeTool === 'circle' && isDrawing) {
            const coords = getCoords(e);
            const radius = Math.sqrt(Math.pow(coords.x - startPoint.x, 2) + Math.pow(coords.y - startPoint.y, 2));
            if(radius > 2) shapes.push({type: 'circle', center: startPoint, radius: radius});
            isDrawing = false; startPoint = null; tempPoint = null; calcTotalArea();
        }
        drawCanvas();
    }
    function setTool(tool) {
        activeTool = tool;
        document.getElementById('btnPoly').classList.toggle('active', tool === 'poly');
        document.getElementById('btnCircle').classList.toggle('active', tool === 'circle');
        points = []; startPoint = null; tempPoint = null; drawCanvas();
    }
    function drawCanvas() {
        if(!ctx) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)'; ctx.lineWidth = 1;
        const gridSize = 20;
        for(let i=0; i<canvas.width; i+=gridSize) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        for(let j=0; j<canvas.height; j+=gridSize) { ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(canvas.width,j); ctx.stroke(); }
        for(let shape of shapes) {
            ctx.strokeStyle = '#10b981'; ctx.fillStyle = 'rgba(16, 185, 129, 0.2)'; ctx.lineWidth = 2;
            ctx.beginPath();
            if(shape.type === 'poly') {
                ctx.moveTo(shape.points[0].x, shape.points[0].y);
                for(let i=1; i<shape.points.length; i++) ctx.lineTo(shape.points[i].x, shape.points[i].y);
                ctx.closePath(); ctx.fill();
                 for(let i=0; i<shape.points.length; i++) {
                    let p1 = shape.points[i]; let p2 = shape.points[(i+1) % shape.points.length]; drawLabel(p1, p2);
                }
            } else if(shape.type === 'circle') {
                ctx.arc(shape.center.x, shape.center.y, shape.radius, 0, Math.PI*2); ctx.fill();
                drawLabel(shape.center, {x: shape.center.x + shape.radius, y: shape.center.y});
            }
            ctx.stroke();
        }
        if(points.length > 0) {
            ctx.strokeStyle = activeTool === 'poly' ? '#3b82f6' : '#10b981'; ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            for(let i=1; i<points.length; i++) { ctx.lineTo(points[i].x, points[i].y); drawLabel(points[i-1], points[i]); }
            ctx.stroke();
            if(tempPoint && activeTool === 'poly') {
                 ctx.beginPath(); ctx.moveTo(points[points.length-1].x, points[points.length-1].y); ctx.lineTo(tempPoint.x, tempPoint.y);
                 ctx.strokeStyle = 'rgba(59, 130, 246, 0.5)'; ctx.stroke();
                 drawLabel(points[points.length-1], tempPoint, true); 
            }
            ctx.fillStyle = '#fff'; for(let p of points) { ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill(); }
        }
        if(isDrawing && activeTool === 'circle' && startPoint && tempPoint) {
             const radius = Math.sqrt(Math.pow(tempPoint.x - startPoint.x, 2) + Math.pow(tempPoint.y - startPoint.y, 2));
             ctx.beginPath(); ctx.arc(startPoint.x, startPoint.y, radius, 0, Math.PI*2);
             ctx.strokeStyle = 'rgba(59, 130, 246, 0.5)'; ctx.fillStyle = 'rgba(59, 130, 246, 0.1)'; ctx.fill(); ctx.stroke();
             drawLabel(startPoint, tempPoint, true); 
        }
    }
    function drawLabel(p1, p2, isPreview = false) {
         const midX = (p1.x + p2.x) / 2; const midY = (p1.y + p2.y) / 2;
         const dist = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
         if(dist < 5) return; 
         ctx.save();
         ctx.fillStyle = isPreview ? 'rgba(255,255,255,0.7)' : '#fff';
         ctx.font = 'bold 11px Inter, sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
         const text = Math.round(dist) + 'mm'; const metrics = ctx.measureText(text);
         ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(midX - metrics.width/2 - 2, midY - 8, metrics.width + 4, 16);
         ctx.fillStyle = isPreview ? 'rgba(255,255,255,0.9)' : '#fff'; ctx.fillText(text, midX, midY);
         ctx.restore();
    }
    function closePolygon() {
        if(points.length < 3) return;
        shapes.push({type: 'poly', points: points}); points = []; startPoint = null; tempPoint = null;
        drawCanvas(); calcTotalArea();
    }
    function calcTotalArea() {
        let totalArea = 0;
        for(let shape of shapes) {
            if(shape.type === 'poly') {
                let area = 0;
                for (let i = 0; i < shape.points.length; i++) {
                    let j = (i + 1) % shape.points.length;
                    area += shape.points[i].x * shape.points[j].y;
                    area -= shape.points[j].x * shape.points[i].y;
                }
                totalArea += Math.abs(area) / 2;
            } else if(shape.type === 'circle') { totalArea += Math.PI * Math.pow(shape.radius, 2); }
        }
        document.getElementById('analysisResult').innerText = "Total Area: " + Math.round(totalArea).toLocaleString() + " mmÂ²";
        document.getElementById('areaInch').innerText = (totalArea * 0.00155).toFixed(3) + " inÂ²";
    }
    function clearCanvas() {
        points = []; shapes = []; startPoint = null; tempPoint = null; isDrawing = false;
        document.getElementById('analysisResult').innerText = "Total Area: 0 mmÂ²";
        document.getElementById('areaInch').innerText = "0 inÂ²";
        drawCanvas();
    }
</script>
</body>
</html>
