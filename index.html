<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unitly Lab - Global Engineering Suite</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Cyberpunk / Tech Palette */
            --primary: #3b82f6; 
            --primary-glow: rgba(59, 130, 246, 0.5);
            --accent: #10b981;
            --accent-glow: rgba(16, 185, 129, 0.5);
            --warn: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --sidebar-bg: #020617;
            --card-bg: rgba(30, 41, 59, 0.85);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --gradient-blue: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            --gradient-orange: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            background-attachment: fixed;
            margin: 0; padding: 0;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
        }

        /* --- SIDEBAR STYLING --- */
        .sidebar {
            position: fixed;
            left: 0; top: 0;
            width: 280px;
            height: 100vh;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 5000;
            overflow-y: auto;
        }
        
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-track { background: #020617; }
        .sidebar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 3px; }

        .logo-container { display: flex; align-items: center; gap: 12px; text-decoration: none; margin-bottom: 10px; padding: 0 10px; }
        .logo-svg { width: 35px; height: 35px; fill: none; stroke: var(--primary); stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 0 8px var(--primary-glow)); }
        .brand-name { font-size: 1.3rem; font-weight: 800; letter-spacing: -0.5px; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .brand-badge { background: rgba(59, 130, 246, 0.2); color: #60a5fa; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(59, 130, 246, 0.3); margin-left: 5px; font-family: 'JetBrains Mono', monospace; }

        .nav-group { display: flex; flex-direction: column; gap: 8px; }

        .dropbtn {
            background: transparent; 
            color: var(--text-muted);
            border: 1px solid transparent; 
            padding: 14px 15px;
            border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 0.95rem;
            transition: all 0.2s ease; 
            display: flex; align-items: center; gap: 12px;
            width: 100%;
            text-align: left;
        }
        .dropbtn:hover { background: rgba(255, 255, 255, 0.05); color: #fff; }
        .dropbtn.active { background: rgba(59, 130, 246, 0.1); color: #fff; border-color: rgba(59, 130, 246, 0.2); }
        
        .dropbtn .arrow { transition: transform 0.3s; margin-left: auto; font-size: 0.8rem; opacity: 0.5; }
        .dropbtn.active .arrow { transform: rotate(90deg); opacity: 1; }

        .dropdown { width: 100%; }
        
        .dropdown-content {
            display: none; 
            background: rgba(0, 0, 0, 0.2);
            margin-top: 5px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.03);
        }
        .dropdown-content.show { display: block; animation: fadeIn 0.3s; }
        
        .dropdown-content a { 
            color: #94a3b8; 
            padding: 12px 20px 12px 50px;
            text-decoration: none; 
            display: flex; justify-content: space-between; 
            font-size: 0.85rem; 
            border-bottom: 1px solid rgba(255,255,255,0.02); 
            cursor: pointer;
            position: relative;
        }
        .dropdown-content a::before {
            content: ''; position: absolute; left: 30px; top: 50%; transform: translateY(-50%);
            width: 4px; height: 4px; border-radius: 50%; background: #475569;
        }
        .dropdown-content a:hover { background: rgba(59, 130, 246, 0.05); color: #fff; }
        .dropdown-content a:hover::before { background: var(--primary); }

        /* --- MAIN CONTENT AREA --- */
        .main-wrapper {
            flex: 1;
            margin-left: 280px;
            padding: 40px;
            width: calc(100% - 280px);
            box-sizing: border-box;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* --- SEARCH BAR --- */
        .search-hero { position: relative; max-width: 100%; margin: 0 auto 30px auto; }
        .search-hero input {
            width: 100%; padding: 18px 20px 18px 55px; font-size: 1.1rem;
            background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border);
            border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            color: #fff; transition: all 0.3s;
            box-sizing: border-box;
        }
        .search-hero input:focus { border-color: var(--primary); background: #1e293b; box-shadow: 0 0 25px var(--primary-glow); }
        .search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 1.2rem; }

        /* --- CARDS & GRID --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        
        .card {
            background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border); padding: 25px; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; overflow: hidden;
        }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: linear-gradient(to bottom, var(--primary), transparent); opacity: 0.5; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 20px 30px -5px rgba(0,0,0,0.4); border-color: rgba(59, 130, 246, 0.4); }

        h3 { margin-top: 0; color: var(--primary); font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; font-weight: 800; }

        /* --- INPUTS --- */
        input, select {
            width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border); border-radius: 8px; color: #fff;
            font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; outline: none; transition: 0.2s;
            box-sizing: border-box;
        }
        input:focus, select:focus { border-color: var(--primary); background: rgba(0, 0, 0, 0.5); }
        .input-group { display: flex; flex-direction: column; gap: 15px; }
        .row { display: flex; gap: 10px; align-items: center; }

        button {
            background: var(--gradient-blue); color: white; border: none; padding: 12px;
            border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2); margin-top: 5px; width: 100%;
        }
        button:hover { filter: brightness(1.1); box-shadow: 0 0 15px var(--primary-glow); transform: translateY(-1px); }

        /* --- RESULT DASHBOARD STYLING --- */
        .result-box { 
            background: rgba(15, 23, 42, 0.6); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 20px; 
            margin-top: 15px; 
            text-align: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; }
        .res-item small { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .res-item span { color: #fff; font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: bold; text-shadow: 0 0 10px rgba(255,255,255,0.1); }
        .res-item.highlight span { color: var(--accent); font-size: 1.4rem; }
        
        .result-val { font-family: 'JetBrains Mono', monospace; font-size: 1.4rem; color: #60a5fa; text-shadow: 0 0 10px rgba(59, 130, 246, 0.4); display: block; font-weight: bold; margin-bottom: 5px; }
        .unit-tag { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: block;}

        /* --- MODALS --- */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); overflow-y: auto; }
        .modal-content {
            background: #0f172a; margin: 3% auto; padding: 35px; border-radius: 20px;
            width: 90%; max-width: 1000px; border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7); position: relative; animation: slideUp 0.3s ease-out;
            max-height: 90vh; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .close { color: var(--text-muted); float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .close:hover { color: #fff; transform: rotate(90deg); }

        /* Formula & Lists */
        .formula-category { margin-bottom: 25px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .formula-header { background: rgba(59, 130, 246, 0.1); padding: 10px 20px; color: var(--primary); font-weight: bold; font-size: 0.9rem; border-bottom: 1px solid var(--border); }
        .formula-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1px; background: var(--border); }
        .formula-item { background: var(--bg-dark); padding: 15px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 80px; }
        .f-math { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; color: #fff; margin-bottom: 5px; }
        .f-desc { font-size: 0.75rem; color: var(--text-muted); }

        /* Footer */
        .info-footer {
            margin-top: 60px; padding: 30px; text-align: center;
            border-top: 1px solid var(--border); color: var(--text-muted);
            background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.4));
        }
        .contact-link { color: var(--primary); text-decoration: none; font-family: 'JetBrains Mono', monospace; }
        
        /* Search Tags */
        .search-results-panel { display: none; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 15px; background: rgba(16, 185, 129, 0.1); border: 1px solid var(--accent); border-radius: 12px; }
        .search-tag { background: var(--accent); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; }

        /* Badges */
        .lab-badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; margin-left: auto; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.1); }
        .lab-badge.hot { color: #fb7185; border-color: rgba(244, 63, 94, 0.3); background: rgba(244, 63, 94, 0.1); }
        .lab-badge.new { color: #34d399; border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.1); }
        .comp-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .comp-table th { background: rgba(59, 130, 246, 0.1); padding: 12px; text-align: left; color: var(--primary); border-bottom: 2px solid var(--border); font-size: 0.85rem; }
        .comp-table td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; color: var(--text-muted); }
        .viewer-container { width: 100%; height: 500px; background: #020617; border-radius: 12px; overflow: hidden; position: relative; border: 1px solid var(--border); box-shadow: inset 0 0 50px rgba(0,0,0,0.5); }
        .overlay-tools { position: absolute; top: 15px; left: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 10; }
        .tool-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 12px; cursor: pointer; border-radius: 6px; font-size: 0.8rem; width: auto; text-align: left; backdrop-filter: blur(4px); transition: 0.2s;}
        .tool-btn:hover, .tool-btn.active { background: var(--primary); border-color: var(--primary); }

        /* RESPONSIVE Sidebar */
        @media (max-width: 900px) {
            body { flex-direction: column; }
            .sidebar { 
                position: relative; 
                width: 100%; height: auto; 
                border-right: none; border-bottom: 1px solid var(--border);
                padding: 15px; box-sizing: border-box;
                overflow-y: visible;
            }
            .main-wrapper { margin-left: 0; width: 100%; padding: 20px; }
            .modal-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <a href="#" class="logo-container">
            <svg class="logo-svg" viewBox="0 0 24 24">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                <path d="M12 22V12"></path>
                <path d="M7 7v5a5 5 0 0 0 10 0V7" stroke-opacity="0.8" stroke-width="1.5"></path>
            </svg>
            <div>
                <div class="brand-name">Unitly Lab <span class="brand-badge">PRO</span></div>
            </div>
        </a>

        <div class="nav-group">
            <button onclick="openModal('formulaModal')" class="dropbtn" style="border-color: rgba(16, 185, 129, 0.4);">
                <span style="color:#34d399">‚àë</span> Formulas
            </button>

            <div class="dropdown">
                <button onclick="toggleDropdown('mechDropdown')" class="dropbtn">
                    <span>‚öôÔ∏è</span> Mechanical 
                    <span class="arrow">‚Ä∫</span>
                </button>
                <div id="mechDropdown" class="dropdown-content">
                    <a onclick="openModal('threeModal')">üßä 3D Studio <span class="lab-badge hot">FIXED</span></a>
                    <a onclick="openModal('sketchModal')">üé® Sketch 2D <span class="lab-badge hot">TOUCH</span></a>
                    <a onclick="openModal('robotModal')">ü§ñ Robot Kinematics</a>
                    <a onclick="openModal('gearDesignModal')">‚öôÔ∏è Gear Module / Dim. <span class="lab-badge new">NEW</span></a>
                    <a onclick="openModal('latheModal')">üõë Lathe / Turning</a>
                    <a onclick="openModal('cncModal')">üè≠ Milling / CNC</a>
                    <a onclick="openModal('weldingModal')">üî• Welding Calc</a>
                    <a onclick="openModal('laserModal')">‚ö° Laser Cut Cost</a>
                    <a onclick="openModal('oringModal')">‚≠ï O-Ring / Groove</a>
                    <a onclick="openModal('sheetModal')">üìê Sheet Metal</a>
                    <a onclick="openModal('hydroModal')">üöú Hydraulic Force</a>
                    <a onclick="openModal('fitsModal')">üî© Fits & Tolerances <span class="lab-badge new">ISO</span></a>
                    <a onclick="openModal('gearModal')">üèéÔ∏è Drivetrain Speed</a>
                    <a onclick="openModal('beltModal')">‚õìÔ∏è Belt & Chain</a>
                    <a onclick="openModal('weightModal')">‚öñÔ∏è Profile Weight</a>
                    <a onclick="openModal('geomModal')">üìê Material & Volume</a>
                    <a onclick="openModal('beamModal')">üèóÔ∏è Beam Analysis</a>
                    <a onclick="openModal('stressModal')">üìà Stress Analysis <span class="lab-badge new">NEW</span></a>
                    <a onclick="openModal('thermModal')">üî• Thermal Exp.</a>
                    <a onclick="openModal('flowModal')">üíß Pipe Flow</a>
                    <a onclick="openModal('printModal')">üñ®Ô∏è 3D Print Cost</a>
                </div>
            </div>

            <div class="dropdown">
                <button onclick="toggleDropdown('electricDropdown')" class="dropbtn" style="border-color: rgba(245, 158, 11, 0.1);">
                    <span style="color:#fbbf24">‚ö°</span> Electrical 
                    <span class="arrow">‚Ä∫</span>
                </button>
                <div id="electricDropdown" class="dropdown-content">
                    <a onclick="openModal('ebikeModal')">üö≤ EV & E-Bike Sim</a>
                    <a onclick="openModal('batteryModal')">üîã Battery Designer</a>
                    <a onclick="openModal('cableModal')">‚ö° Wire Size & Drop</a>
                    <a onclick="openModal('electroModal')">üí° Electronics / Ohm</a>
                    <a onclick="openModal('resistorModal')">üé® Resistor Colors <span class="lab-badge new">NEW</span></a>
                    <a onclick="openModal('stepperModal')">ü§ñ Stepper Motor</a>
                </div>
            </div>

            <div class="dropdown">
                <button onclick="toggleDropdown('eduDropdown')" class="dropbtn">
                    <span>üéì</span> Reference 
                    <span class="arrow">‚Ä∫</span>
                </button>
                <div id="eduDropdown" class="dropdown-content">
                      <a onclick="openModal('materialModal')">üìö Materials Lib</a>
                      <a onclick="openModal('gcodeModal')">üìú G-Code List</a>
                      <a onclick="openModal('fastenerModal')">üî© Fastener Table</a>
                      <a onclick="openModal('gdtModal')">üìê GD&T Symbols</a>
                      <a onclick="openModal('surfaceModal')">„Ä∞Ô∏è Surface Roughness</a>
                      <a onclick="openModal('linterpModal')">üå°Ô∏è Linear Interp.</a>
                      <a onclick="openModal('infoModal')">‚ÑπÔ∏è Lathe vs Milling</a>
                </div>
            </div>
        </div>
        
        <div style="margin-top:auto; font-size:0.75rem; color:var(--text-muted); padding-top:20px; border-top:1px solid var(--border);">
            System Status: <span style="color:#10b981">‚óè Online</span><br>
            Ver: 2.1.7
        </div>
    </nav>

    <div class="main-wrapper">
        <div class="container">
            
            <div class="search-hero">
                <span class="search-icon">üîç</span>
                <input type="text" id="globalSearch" placeholder="Search tools, formulas, or calculators (e.g. 'Gear', 'Stress')..." onkeyup="filterTools()">
            </div>
            
            <div id="dynamicSearchResults" class="search-results-panel"></div>

            <div class="grid" id="mainGrid">
                <div class="card"><h3>üìè Length</h3><div class="input-group"><input type="number" id="lenInput" oninput="convert('len')"><div class="row"><select id="lenFrom" onchange="convert('len')"><option value="1">m</option><option value="1000">km</option><option value="0.01">cm</option><option value="0.001">mm</option><option value="0.0254">in</option><option value="0.3048">ft</option><option value="1609.34">mi</option></select>‚ûî<select id="lenTo" onchange="convert('len')"><option value="1">m</option><option value="1000">km</option><option value="0.01">cm</option><option value="0.001">mm</option><option value="0.0254">in</option><option value="0.3048">ft</option><option value="1609.34">mi</option></select></div></div><div class="result-box"><span id="lenRes" class="result-val">0</span></div></div>
                <div class="card"><h3>üü¶ Area</h3><div class="input-group"><input type="number" id="areInput" oninput="convert('are')"><div class="row"><select id="areFrom" onchange="convert('are')"><option value="1">m¬≤</option><option value="1000000">km¬≤</option><option value="0.0001">cm¬≤</option><option value="0.000001">mm¬≤</option><option value="0.092903">ft¬≤</option><option value="0.000645">in¬≤</option></select>‚ûî<select id="areTo" onchange="convert('are')"><option value="1">m¬≤</option><option value="1000000">km¬≤</option><option value="0.0001">cm¬≤</option><option value="0.000001">mm¬≤</option><option value="0.092903">ft¬≤</option><option value="0.000645">in¬≤</option></select></div></div><div class="result-box"><span id="areRes" class="result-val">0</span></div></div>
                <div class="card"><h3>‚ö° Speed</h3><div class="input-group"><input type="number" id="spdInput" oninput="convert('spd')"><div class="row"><select id="spdFrom" onchange="convert('spd')"><option value="0.277778">km/h</option><option value="1">m/s</option><option value="0.44704">mph</option><option value="0.514444">knot</option></select>‚ûî<select id="spdTo" onchange="convert('spd')"><option value="0.277778">km/h</option><option value="1">m/s</option><option value="0.44704">mph</option><option value="0.514444">knot</option></select></div></div><div class="result-box"><span id="spdRes" class="result-val">0</span></div></div>
                <div class="card"><h3>‚öôÔ∏è Torque</h3><div class="input-group"><input type="number" id="trqInput" oninput="convert('trq')"><div class="row"><select id="trqFrom" onchange="convert('trq')"><option value="1">Nm</option><option value="1.35582">lb-ft</option><option value="0.112985">lb-in</option><option value="9.80665">kgm</option></select>‚ûî<select id="trqTo" onchange="convert('trq')"><option value="1">Nm</option><option value="1.35582">lb-ft</option><option value="0.112985">lb-in</option><option value="9.80665">kgm</option></select></div></div><div class="result-box"><span id="trqRes" class="result-val">0</span></div></div>
                <div class="card"><h3>üí™ Force</h3><div class="input-group"><input type="number" id="frcInput" oninput="convert('frc')"><div class="row"><select id="frcFrom" onchange="convert('frc')"><option value="1">N</option><option value="1000">kN</option><option value="4.44822">lbf</option><option value="9.80665">kgf</option></select>‚ûî<select id="frcTo" onchange="convert('frc')"><option value="1">N</option><option value="1000">kN</option><option value="4.44822">lbf</option><option value="9.80665">kgf</option></select></div></div><div class="result-box"><span id="frcRes" class="result-val">0</span></div></div>
                <div class="card"><h3>üèéÔ∏è Power</h3><div class="input-group"><input type="number" id="pwrInput" oninput="convert('pwr')"><div class="row"><select id="pwrFrom" onchange="convert('pwr')"><option value="1">kW</option><option value="0.001">W</option><option value="0.735499">HP (Met)</option><option value="0.7457">HP (Mech)</option></select>‚ûî<select id="pwrTo" onchange="convert('pwr')"><option value="1">kW</option><option value="0.001">W</option><option value="0.735499">HP (Met)</option><option value="0.7457">HP (Mech)</option></select></div></div><div class="result-box"><span id="pwrRes" class="result-val">0</span></div></div>
                <div class="card"><h3>üéà Pressure</h3><div class="input-group"><input type="number" id="prsInput" oninput="convert('prs')"><div class="row"><select id="prsFrom" onchange="convert('prs')"><option value="1">Bar</option><option value="0.00001">Pa</option><option value="0.068947">Psi</option><option value="1.01325">atm</option></select>‚ûî<select id="prsTo" onchange="convert('prs')"><option value="1">Bar</option><option value="0.00001">Pa</option><option value="0.068947">Psi</option><option value="1.01325">atm</option></select></div></div><div class="result-box"><span id="prsRes" class="result-val">0</span></div></div>
                <div class="card"><h3>üèõÔ∏è Stress</h3><div class="input-group"><input type="number" id="strInput" oninput="convert('str')"><div class="row"><select id="strFrom" onchange="convert('str')"><option value="1">MPa</option><option value="1000">GPa</option><option value="0.006894">psi</option><option value="6.89475">ksi</option></select>‚ûî<select id="strTo" onchange="convert('str')"><option value="1">MPa</option><option value="1000">GPa</option><option value="0.006894">psi</option><option value="6.89475">ksi</option></select></div></div><div class="result-box"><span id="strRes" class="result-val">0</span></div></div>
                <div class="card"><h3>‚è±Ô∏è Time</h3><div class="input-group"><input type="number" id="timInput" oninput="convert('tim')"><div class="row"><select id="timFrom" onchange="convert('tim')"><option value="3600">Hr</option><option value="60">Min</option><option value="1">Sec</option><option value="86400">Day</option></select>‚ûî<select id="timTo" onchange="convert('tim')"><option value="3600">Hr</option><option value="60">Min</option><option value="1">Sec</option><option value="86400">Day</option></select></div></div><div class="result-box"><span id="timRes" class="result-val">0</span></div></div>
                <div class="card"><h3>‚öñÔ∏è Weight</h3><div class="input-group"><input type="number" id="wgtInput" oninput="convert('wgt')"><div class="row"><select id="wgtFrom" onchange="convert('wgt')"><option value="1">kg</option><option value="0.001">g</option><option value="1000">ton</option><option value="0.453592">lb</option></select>‚ûî<select id="wgtTo" onchange="convert('wgt')"><option value="1">kg</option><option value="0.001">g</option><option value="1000">ton</option><option value="0.453592">lb</option></select></div></div><div class="result-box"><span id="wgtRes" class="result-val">0</span></div></div>
                <div class="card"><h3>ü•õ Volume</h3><div class="input-group"><input type="number" id="volInput" oninput="convert('vol')"><div class="row"><select id="volFrom" onchange="convert('vol')"><option value="1">L</option><option value="0.001">ml</option><option value="1000">m¬≥</option><option value="3.78541">gal</option></select>‚ûî<select id="volTo" onchange="convert('vol')"><option value="1">L</option><option value="0.001">ml</option><option value="1000">m¬≥</option><option value="3.78541">gal</option></select></div></div><div class="result-box"><span id="volRes" class="result-val">0</span></div></div>
                <div class="card"><h3>üìà Finance</h3><div class="input-group"><input type="number" id="pCap" placeholder="Capital"><div class="row"><input type="number" id="pRate" value="45" placeholder="%"><input type="number" id="pTime" value="12" placeholder="Mo"></div><button onclick="calcFin()">Calculate</button></div><div class="result-box"><span id="finRes" class="result-val">0</span></div></div>
            </div>

            <footer class="info-footer">
                <h3>Unitly Lab ¬© 2026</h3>
                <div style="margin: 10px 0;">
                    <a href="mailto:unitlylab@gmail.com" class="contact-link">unitlylab@gmail.com</a>
                </div>
                <p class="disclaimer">
                    <strong>Disclaimer:</strong> All calculations, data, and information provided by Unitly Lab are for educational and reference purposes only. 
                    Use these tools as an estimation aid, not as a replacement for professional verification.
                </p>
            </footer>

        </div>
    </div>

    <div id="formulaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('formulaModal')">&times;</span>
            <h3>‚àë Engineering Handbook</h3>
            
            <div class="formula-category">
                <div class="formula-header">üìê Mathematics & Geometry</div>
                <div class="formula-grid">
                    <div class="formula-item"><div class="f-math">A = œÄr¬≤</div><div class="f-desc">Area of Circle</div></div>
                    <div class="formula-item"><div class="f-math">C = 2œÄr</div><div class="f-desc">Circumference</div></div>
                    <div class="formula-item"><div class="f-math">a¬≤ + b¬≤ = c¬≤</div><div class="f-desc">Pythagoras</div></div>
                    <div class="formula-item"><div class="f-math">V = (4/3)œÄr¬≥</div><div class="f-desc">Sphere Volume</div></div>
                    <div class="formula-item"><div class="f-math">x = -b ¬± ‚àö(b¬≤-4ac) / 2a</div><div class="f-desc">Quadratic Formula</div></div>
                </div>
            </div>

            <div class="formula-category">
                <div class="formula-header">‚öõÔ∏è Physics & Dynamics</div>
                <div class="formula-grid">
                    <div class="formula-item"><div class="f-math">F = m ¬∑ a</div><div class="f-desc">Newton's 2nd Law</div></div>
                    <div class="formula-item"><div class="f-math">KE = ¬Ωmv¬≤</div><div class="f-desc">Kinetic Energy</div></div>
                    <div class="formula-item"><div class="f-math">PE = m ¬∑ g ¬∑ h</div><div class="f-desc">Potential Energy</div></div>
                    <div class="formula-item"><div class="f-math">W = F ¬∑ d</div><div class="f-desc">Work</div></div>
                    <div class="formula-item"><div class="f-math">P = W / t</div><div class="f-desc">Power</div></div>
                </div>
            </div>

            <div class="formula-category">
                <div class="formula-header">üèóÔ∏è Mechanics & Strength</div>
                <div class="formula-grid">
                    <div class="formula-item"><div class="f-math">œÉ = F / A</div><div class="f-desc">Stress</div></div>
                    <div class="formula-item"><div class="f-math">Œµ = ŒîL / L‚ÇÄ</div><div class="f-desc">Strain</div></div>
                    <div class="formula-item"><div class="f-math">E = œÉ / Œµ</div><div class="f-desc">Young's Modulus</div></div>
                    <div class="formula-item"><div class="f-math">œÑ = (T ¬∑ r) / J</div><div class="f-desc">Torsion Stress</div></div>
                    <div class="formula-item"><div class="f-math">M = F ¬∑ d</div><div class="f-desc">Moment</div></div>
                </div>
            </div>
            
            <div class="formula-category">
                <div class="formula-header">üî• Thermodynamics & Fluids</div>
                <div class="formula-grid">
                    <div class="formula-item"><div class="f-math">PV = nRT</div><div class="f-desc">Ideal Gas Law</div></div>
                    <div class="formula-item"><div class="f-math">Q = mcŒîT</div><div class="f-desc">Heat Transfer</div></div>
                    <div class="formula-item"><div class="f-math">P = œÅ ¬∑ g ¬∑ h</div><div class="f-desc">Hydrostatic Press.</div></div>
                    <div class="formula-item"><div class="f-math">Q = A ¬∑ v</div><div class="f-desc">Flow Rate</div></div>
                </div>
            </div>

            <div class="formula-category">
                <div class="formula-header">‚ö° Electrical</div>
                <div class="formula-grid">
                    <div class="formula-item"><div class="f-math">V = I ¬∑ R</div><div class="f-desc">Ohm's Law</div></div>
                    <div class="formula-item"><div class="f-math">P = V ¬∑ I</div><div class="f-desc">Electric Power</div></div>
                    <div class="formula-item"><div class="f-math">1/R = 1/R‚ÇÅ + 1/R‚ÇÇ</div><div class="f-desc">Parallel Resistors</div></div>
                    <div class="formula-item"><div class="f-math">f = 1 / T</div><div class="f-desc">Frequency</div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="threeModal" class="modal">
        <div class="modal-content" style="width: 98%; max-width: 1200px;">
            <span class="close" onclick="closeModal('threeModal')">&times;</span>
            <h3>üßä 3D Prototyping Studio</h3>
            <p class="unit-tag">Left Click: Rotate ‚Ä¢ Right Click: Pan ‚Ä¢ Scroll: Zoom</p>
            <div class="viewer-container" id="threeContainer">
                <div class="overlay-tools">
                    <button class="tool-btn" id="btn3DDraw" onclick="toggle3DDrawMode()">‚úçÔ∏è Draw Line on Grid</button>
                    <button class="tool-btn" onclick="add3DCube()">üü¶ Add Cube</button>
                    <button class="tool-btn" onclick="add3DCylinder()">üîò Add Cylinder</button>
                    <button class="tool-btn" onclick="toggleWireframe()">üï∏Ô∏è Toggle Wireframe</button>
                    <button class="tool-btn" style="background:rgba(239, 68, 68, 0.4);" onclick="clear3D()">‚ùå Clear Scene</button>
                </div>
            </div>
        </div>
    </div>

    <div id="sketchModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('sketchModal')">&times;</span>
            <h3>üé® 2D Sketch Pro</h3>
            <p class="unit-tag">Freehand & Geometric Drafting (Supports Touch)</p>
            <div class="viewer-container" style="height:550px; background:#1e293b; cursor:crosshair;">
                <div class="overlay-tools" style="flex-direction:row;">
                    <button class="tool-btn" id="btnPencil" onclick="setTool('pencil')">‚úèÔ∏è Pencil (Free)</button>
                    <button class="tool-btn" id="btnPoly" onclick="setTool('poly')">üìê Polyline</button>
                    <button class="tool-btn" id="btnCircle" onclick="setTool('circle')">‚≠ï Circle</button>
                    <button class="tool-btn" onclick="closePolygon()" style="background:rgba(16, 185, 129, 0.3);">‚úÖ Close Path</button>
                    <button class="tool-btn" style="background:rgba(239, 68, 68, 0.3);" onclick="clearCanvas()">‚ùå Clear</button>
                </div>
                <canvas id="designCanvas" style="width:100%; height:100%; display:block;"></canvas>
                <div id="analysisResult" style="position:absolute; bottom:15px; right:15px; color:var(--accent); font-weight:bold; font-size:1.2rem; text-shadow:0 0 10px rgba(0,0,0,0.8);">Area: 0 mm¬≤</div>
            </div>
        </div>
    </div>

    <div id="ebikeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('ebikeModal')">&times;</span>
            <h3 style="color:#fbbf24;">üö≤ EV & E-Bike Mobility Simulator</h3>
            <div class="modal-grid">
                <div class="input-group">
                    <span class="unit-tag">Vehicle Specs</span>
                    <div class="row">
                        <div style="flex:1"><small>System Voltage (V)</small><input type="number" id="evV" value="72"></div>
                        <div style="flex:1"><small>Battery Cap (Ah)</small><input type="number" id="evAh" value="40"></div>
                    </div>
                    <div class="row">
                        <div style="flex:1"><small>Total Weight (kg)</small><input type="number" id="evWeight" value="120" placeholder="Rider+Bike"></div>
                        <div style="flex:1"><small>Avg Speed (km/h)</small><input type="number" id="evSpd" value="45"></div>
                    </div>
                    <small>Motor Power (Watts - Nominal)</small><input type="number" id="evW" value="3000">
                    <button onclick="calcMobility()" style="background:var(--gradient-orange); margin-top:20px;">Run Simulation</button>
                </div>
                
                <div class="result-box" style="text-align:left;">
                    <div class="res-grid">
                        <div class="res-item highlight"><small>Est. Range</small><span id="resRange">0 km</span></div>
                        <div class="res-item"><small>Ride Duration</small><span id="resTime">0 h 00 m</span></div>
                        <div class="res-item"><small>Energy/Km</small><span id="resWhKm">0 Wh/km</span></div>
                        <div class="res-item"><small>Total Energy</small><span id="resTotalE">0 Wh</span></div>
                        <div class="res-item"><small>Est. Top Speed</small><span id="resMaxSpd">-- km/h</span></div>
                        <div class="res-item"><small>Charge Cost (TR)</small><span id="resCost">0 ‚Ç∫</span></div>
                    </div>
                    <hr style="border-color:rgba(255,255,255,0.1); margin:15px 0;">
                    <p style="font-size:0.8rem; color:#94a3b8; text-align:center; margin:0;">
                        *Simulated based on flat ground & 85% battery efficiency.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="batteryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('batteryModal')">&times;</span>
            <h3 style="color:#f59e0b;">üîã Battery Pack Architect</h3>
            <div class="modal-grid">
                <div class="input-group">
                    <span class="unit-tag">Targets</span>
                    <div class="row">
                        <div style="flex:1"><small>Target Volts (V)</small><input type="number" id="batTargetV" value="72"></div>
                        <div style="flex:1"><small>Target Ah</small><input type="number" id="batTargetAh" value="40"></div>
                    </div>
                    <span class="unit-tag">Cell Data (e.g. 18650)</span>
                    <div class="row">
                        <div style="flex:1"><small>Cell V (Nom)</small><input type="number" id="cellV" value="3.7"></div>
                        <div style="flex:1"><small>Cell mAh</small><input type="number" id="cellMah" value="2500"></div>
                    </div>
                    <div class="row">
                        <div style="flex:1"><small>Max Disch. (A)</small><input type="number" id="cellAmps" value="20"></div>
                        <div style="flex:1"><small>Cell Weight (g)</small><input type="number" id="cellG" value="48"></div>
                    </div>
                    <button onclick="calcBattery()">Generate Pack</button>
                </div>
                <div class="result-box">
                    <div style="font-size:2rem; color:#f59e0b; margin-bottom:15px; font-weight:800;" id="batConf">--S / --P</div>
                    <div class="res-grid">
                         <div class="res-item"><small>Total Energy</small><span id="batKwh">0 kWh</span></div>
                         <div class="res-item"><small>Max Power</small><span id="batKw">0 kW</span></div>
                         <div class="res-item"><small>Real Capacity</small><span id="batRealAh">0 Ah</span></div>
                         <div class="res-item"><small>Total Cells</small><span id="batTotalCells">0</span></div>
                         <div class="res-item"><small>Est Weight</small><span id="batWeight">0 kg</span></div>
                         <div class="res-item"><small>Full Charge V</small><span id="batMaxV">0 V</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="latheModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('latheModal')">&times;</span>
            <h3>üõë Lathe / Turning Calculator</h3>
            <div class="modal-grid">
                <div class="input-group">
                    <span class="unit-tag">Parameters</span>
                    <div class="row">
                        <div style="flex:1"><small>Material</small><select id="latheMat"><option value="200">Steel (Mild)</option><option value="150">Stainless</option><option value="400">Aluminum</option><option value="180">Cast Iron</option></select></div>
                        <div style="flex:1"><small>Diameter (mm)</small><input type="number" id="latheDia" value="50"></div>
                    </div>
                    <div class="row">
                         <div style="flex:1"><small>Depth Cut (mm)</small><input type="number" id="latheAp" value="1.5"></div>
                         <div style="flex:1"><small>Feed (mm/rev)</small><input type="number" id="latheFn" value="0.2"></div>
                    </div>
                    <button onclick="calcLathe()">Calculate Cutting Data</button>
                </div>
                <div class="result-box">
                    <div class="res-grid">
                        <div class="res-item highlight"><small>Spindle Speed</small><span id="latheRPM">0 RPM</span></div>
                        <div class="res-item"><small>Cutting Speed</small><span id="latheVc">0 m/min</span></div>
                        <div class="res-item"><small>MRR (Removal)</small><span id="latheMRR">0 cm¬≥/min</span></div>
                        <div class="res-item"><small>Req Power</small><span id="lathePower">0 kW</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="cncModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('cncModal')">&times;</span>
            <h3>üè≠ CNC Milling Calculator</h3>
            <div class="modal-grid">
                <div class="input-group">
                    <span class="unit-tag">Tool & Cut</span>
                    <div class="row">
                        <div style="flex:1"><small>Tool Dia (mm)</small><input type="number" id="cncD" value="10"></div>
                        <div style="flex:1"><small>Flutes (Z)</small><input type="number" id="cncZ" value="4"></div>
                    </div>
                    <small>Surface Speed (Vc - m/min)</small><input type="number" id="matType" value="150">
                    <small>Feed per Tooth (fz - mm)</small><input type="number" id="cncFz" value="0.1">
                    <div class="row">
                        <div style="flex:1"><small>Stepover (Ae)</small><input type="number" id="cncAe" value="4"></div>
                        <div style="flex:1"><small>Depth (Ap)</small><input type="number" id="cncAp" value="10"></div>
                    </div>
                    <button onclick="calcCNC()">Calculate Feeds</button>
                </div>
                <div class="result-box">
                    <div class="res-grid">
                        <div class="res-item highlight"><small>RPM</small><span id="resRPM">0</span></div>
                        <div class="res-item"><small>Feed Rate</small><span id="resFeed">0 mm/min</span></div>
                        <div class="res-item"><small>MRR (Volume)</small><span id="resMRR">0 cm¬≥/min</span></div>
                        <div class="res-item"><small>Tooth Load</small><span id="resChip">0 mm</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="robotModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('robotModal')">&times;</span><h3>ü§ñ Robot Kinematics</h3><div class="modal-grid"><div class="input-group"><span class="unit-tag">Arm Parameters</span><div class="row"><div style="flex:1"><small>Link 1 (mm)</small><input type="number" id="robL1" value="100" oninput="drawRobot()"></div><div style="flex:1"><small>Link 2 (mm)</small><input type="number" id="robL2" value="80" oninput="drawRobot()"></div></div><span class="unit-tag">Joint Angles</span><div style="margin-top:5px;"><small>Joint 1 (Œ∏1): <span id="valT1" style="color:#a78bfa">45</span>¬∞</small><input type="range" id="robT1" min="0" max="360" value="45" oninput="drawRobot()" style="width:100%"></div><div><small>Joint 2 (Œ∏2): <span id="valT2" style="color:#a78bfa">-30</span>¬∞</small><input type="range" id="robT2" min="-180" max="180" value="-30" oninput="drawRobot()" style="width:100%"></div><div class="result-box"><div>X: <strong id="robX">0</strong> | Y: <strong id="robY">0</strong></div></div></div><div class="viewer-container" style="background:#020617;"><canvas id="robotCanvas" width="500" height="350" style="width:100%; height:100%;"></canvas></div></div></div></div>

    <div id="infoModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('infoModal')">&times;</span><h3>‚ÑπÔ∏è Lathe vs Milling Differences</h3><table class="comp-table"><thead><tr><th>Feature</th><th>Lathe (Turning)</th><th>Milling</th></tr></thead><tbody><tr><td><strong>Primary Motion</strong></td><td>Workpiece Rotates</td><td>Tool Rotates</td></tr><tr><td><strong>Feed Motion</strong></td><td>Tool moves linearly</td><td>Workpiece moves linearly</td></tr><tr><td><strong>Shape Produced</strong></td><td>Cylindrical / Round</td><td>Flat / Prismatic / Contoured</td></tr><tr><td><strong>Cutting Tool</strong></td><td>Single Point Insert</td><td>Multi-Point (Endmill/Face)</td></tr></tbody></table></div></div>
    <div id="gdtModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('gdtModal')">&times;</span><h3>üìê GD&T Symbols (ASME Y14.5)</h3><table class="comp-table"><thead><tr><th>Symbol</th><th>Type</th><th>Name</th></tr></thead><tbody><tr><td>‚è§</td><td>Form</td><td>Straightness</td></tr><tr><td>‚è•</td><td>Form</td><td>Flatness</td></tr><tr><td>‚óã</td><td>Form</td><td>Circularity</td></tr><tr><td>‚å≠</td><td>Form</td><td>Cylindricity</td></tr><tr><td>‚à•</td><td>Orientation</td><td>Parallelism</td></tr><tr><td>‚üÇ</td><td>Orientation</td><td>Perpendicularity</td></tr><tr><td>‚óé</td><td>Location</td><td>Concentricity</td></tr></tbody></table></div></div>
    <div id="surfaceModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('surfaceModal')">&times;</span><h3>„Ä∞Ô∏è Surface Roughness Conversion</h3><table class="comp-table"><thead><tr><th>ISO Grade</th><th>Ra (¬µm)</th><th>Ra (¬µin)</th><th>Rz (¬µm)</th></tr></thead><tbody><tr><td>N12</td><td>50</td><td>2000</td><td>200</td></tr><tr><td>N10</td><td>12.5</td><td>500</td><td>50</td></tr><tr><td>N9</td><td>6.3</td><td>250</td><td>25</td></tr><tr><td>N8</td><td>3.2</td><td>125</td><td>12.5</td></tr><tr><td>N7</td><td>1.6</td><td>63</td><td>6.3</td></tr><tr><td>N6</td><td>0.8</td><td>32</td><td>3.2</td></tr></tbody></table></div></div>

    <div id="gcodeModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('gcodeModal')">&times;</span><h3>üìú G-Code Reference</h3><div class="input-group"><input type="text" id="codeSearch" placeholder="Search code (e.g. G01)..." onkeyup="searchCodes()"></div><div style="max-height:400px; overflow-y:auto; margin-top:15px;"><table id="gCodeTable" class="comp-table"><thead><tr><th>Code</th><th>Description</th></tr></thead><tbody id="codeTableBody"><tr><td>G00</td><td>Rapid Positioning</td></tr><tr><td>G01</td><td>Linear Interpolation (Cutting)</td></tr><tr><td>G02</td><td>Circular Interpolation (CW)</td></tr><tr><td>G03</td><td>Circular Interpolation (CCW)</td></tr><tr><td>G20</td><td>Units: Inches</td></tr><tr><td>G21</td><td>Units: Millimeters</td></tr><tr><td>G28</td><td>Return to Home</td></tr><tr><td>G90</td><td>Absolute Positioning</td></tr><tr><td>G91</td><td>Incremental Positioning</td></tr><tr><td>M03</td><td>Spindle ON (CW)</td></tr><tr><td>M04</td><td>Spindle ON (CCW)</td></tr><tr><td>M05</td><td>Spindle OFF</td></tr><tr><td>M06</td><td>Tool Change</td></tr><tr><td>M08</td><td>Coolant ON</td></tr><tr><td>M30</td><td>End Program</td></tr></tbody></table></div></div></div>

    <div id="materialModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('materialModal')">&times;</span><h3>üìö Materials Library</h3><div class="input-group"><input type="text" id="matSearch" placeholder="Search material (e.g. Steel)..." onkeyup="searchMaterials()"></div><div style="max-height:400px; overflow-y:auto; margin-top:15px;"><table class="comp-table"><thead><tr><th>Material</th><th>Density (g/cm¬≥)</th><th>Yield (MPa)</th></tr></thead><tbody id="matTableBody"><tr><td>Steel 1018 (Mild)</td><td>7.87</td><td>370</td></tr><tr><td>Steel 1040 (Carbon)</td><td>7.85</td><td>415</td></tr><tr><td>Steel 4140</td><td>7.85</td><td>655</td></tr><tr><td>Stainless 304</td><td>8.00</td><td>215</td></tr><tr><td>Aluminum 6061-T6</td><td>2.70</td><td>276</td></tr><tr><td>Aluminum 7075-T6</td><td>2.81</td><td>503</td></tr><tr><td>Titanium Gr5</td><td>4.43</td><td>880</td></tr><tr><td>Brass C360</td><td>8.50</td><td>310</td></tr><tr><td>ABS Plastic</td><td>1.04</td><td>40</td></tr></tbody></table></div></div></div>

    <div id="fastenerModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('fastenerModal')">&times;</span><h3>üî© Fastener Standards (ISO)</h3><div class="input-group"><input type="text" id="fastenerSearch" placeholder="Search size (e.g. M6)..." onkeyup="searchFasteners()"></div><div style="max-height:400px; overflow-y:auto; margin-top:15px;"><table class="comp-table"><thead><tr><th>Size</th><th>Pitch</th><th>Tap Drill</th><th>Hex Key</th></tr></thead><tbody id="fastenerBody"><tr><td>M2</td><td>0.4</td><td>1.6 mm</td><td>1.5 mm</td></tr><tr><td>M3</td><td>0.5</td><td>2.5 mm</td><td>2.5 mm</td></tr><tr><td>M4</td><td>0.7</td><td>3.3 mm</td><td>3.0 mm</td></tr><tr><td>M5</td><td>0.8</td><td>4.2 mm</td><td>4.0 mm</td></tr><tr><td>M6</td><td>1.0</td><td>5.0 mm</td><td>5.0 mm</td></tr><tr><td>M8</td><td>1.25</td><td>6.8 mm</td><td>6.0 mm</td></tr><tr><td>M10</td><td>1.5</td><td>8.5 mm</td><td>8.0 mm</td></tr><tr><td>M12</td><td>1.75</td><td>10.2 mm</td><td>10.0 mm</td></tr></tbody></table></div></div></div>

    <div id="weldingModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('weldingModal')">&times;</span><h3>üî• Welding Parameter Calc</h3><div class="modal-grid"><div class="input-group"><span class="unit-tag">Process</span><select id="weldType"><option value="mig">MIG (GMAW)</option><option value="stick">Stick (SMAW)</option><option value="tig">TIG (GTAW)</option></select><small>Material Thickness (mm)</small><input type="number" id="weldThick" value="3"><button onclick="calcWeld()">Calculate Amps</button></div><div class="result-box"><div>Recommended Current</div><div id="weldAmps" class="result-val">0 - 0 A</div><small id="weldNote" style="display:block; margin-top:10px; color:var(--text-muted);">--</small></div></div></div></div>

    <div id="laserModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('laserModal')">&times;</span><h3>‚ö° Laser/Plasma Cost</h3><div class="modal-grid"><div class="input-group"><small>Path Length (m)</small><input type="number" id="cutLen" value="5.5"><small>Cutting Speed (mm/min)</small><input type="number" id="cutSpeed" value="1200"><small>Hourly Rate ($/‚Ç¨)</small><input type="number" id="cutRate" value="80"><button onclick="calcLaser()">Estimate Cost</button></div><div class="result-box"><div>Total Cost</div><div id="cutCostRes" class="result-val">0.00</div><hr><div>Time: <span id="cutTimeRes">0 min</span></div></div></div></div></div>

    <div id="oringModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('oringModal')">&times;</span><h3>‚≠ï O-Ring Groove Design</h3><div class="modal-grid"><div class="input-group"><span class="unit-tag">O-Ring Spec</span><div class="row"><div style="flex:1"><small>CS (mm)</small><select id="oringW"><option value="1.78">1.78</option><option value="2.62">2.62</option><option value="3.53">3.53</option><option value="5.33">5.33</option></select></div><div style="flex:1"><small>Type</small><select id="oringApp"><option value="rod">Rod Seal</option><option value="piston">Piston Seal</option></select></div></div><small>Diameter (mm)</small><input type="number" id="oringDia" value="50"><button onclick="calcOring()">Calculate Groove</button></div><div class="result-box" style="text-align:left;"><div>Groove Depth: <strong id="grooveD" style="float:right">0</strong></div><hr><div>Groove Width: <strong id="grooveW" style="float:right">0</strong></div><hr><div><span style="color:var(--primary)">Cut Diameter:</span> <strong id="grooveDiaRes" style="float:right; font-size:1.2rem;">0</strong></div></div></div></div></div>

    <div id="sheetModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('sheetModal')">&times;</span><h3>üìê Sheet Metal Bending</h3><div class="modal-grid"><div class="input-group"><div class="row"><div style="flex:1"><small>Thick (mm)</small><input type="number" id="bendT" value="2"></div><div style="flex:1"><small>Radius (mm)</small><input type="number" id="bendR" value="2"></div></div><div class="row"><div style="flex:1"><small>Angle (¬∞)</small><input type="number" id="bendA" value="90"></div><div style="flex:1"><small>K-Factor</small><input type="number" id="bendK" value="0.33"></div></div><button onclick="calcBend()">Calc Unfolded Length</button></div><div class="result-box"><div>Bend Allowance (BA)</div><div id="bendBA" class="result-val">0.00 mm</div><hr><div>Bend Deduction (BD): <span id="bendBD">0.00 mm</span></div></div></div></div></div>

    <div id="hydroModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('hydroModal')">&times;</span><h3>üöú Hydraulic Force</h3><div class="modal-grid"><div class="input-group"><small>Bore Dia (mm)</small><input type="number" id="cylBore" value="80"><small>Rod Dia (mm)</small><input type="number" id="cylRod" value="40"><small>Pressure (Bar)</small><input type="number" id="cylPress" value="160"><button onclick="calcHydro()">Calculate Force</button></div><div class="result-box"><div>Push Force</div><div id="pushForce" class="result-val">0.00 Ton</div><hr><div>Pull Force: <span id="pullForce">0.00 Ton</span></div></div></div></div></div>

    <div id="fitsModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('fitsModal')">&times;</span><h3>üî© ISO Fits & Tolerances (ISO 286)</h3><div class="modal-grid"><div class="input-group"><div class="row"><div style="flex:1"><small>Dia (mm)</small><input type="number" id="fitDia" value="25"></div><div style="flex:1"><small>Class</small><select id="fitType"><option value="H7g6">H7/g6 (Slide)</option><option value="H7h6">H7/h6 (Clear)</option><option value="H7p6">H7/p6 (Press)</option></select></div></div><button onclick="calcFits()">Check Fit</button></div><div class="result-box"><div>Result: <strong id="fitValRes" style="color:var(--accent)">--</strong></div><div style="margin-top:10px; font-size:0.9rem;">Hole: <span id="fitHoleRes">--</span></div><div style="font-size:0.9rem;">Shaft: <span id="fitShaftRes">--</span></div></div></div></div></div>

    <div id="gearModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('gearModal')">&times;</span><h3>üèéÔ∏è Drivetrain Speed Calc</h3><div class="modal-grid"><div class="input-group"><small>Motor RPM</small><input type="number" id="motorRPM" value="4500"><div class="row"><div style="flex:1"><small>Driver T</small><input type="number" id="gearDriver" value="12"></div><div style="flex:1"><small>Driven T</small><input type="number" id="gearDriven" value="54"></div></div><small>Wheel Dia (cm)</small><input type="number" id="tireDia" value="26"><button onclick="calcGearing()">Calculate Speed</button></div><div class="result-box"><div>Top Speed</div><div id="speedRes" class="result-val">0 km/h</div><hr><div>Ratio: <span id="ratioRes">0:1</span></div></div></div></div></div>

    <div id="gearDesignModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('gearDesignModal')">&times;</span>
            <h3>‚öôÔ∏è Gear Dimensions / Module</h3>
            <div class="modal-grid">
                <div class="input-group">
                    <span class="unit-tag">Metric Spur Gear (ISO)</span>
                    <div class="row">
                        <div style="flex:1">
                            <small>Module (m)</small>
                            <input type="number" id="gMod" value="2.0" step="0.25">
                        </div>
                        <div style="flex:1">
                            <small>Teeth (z)</small>
                            <input type="number" id="gTeeth" value="20" step="1">
                        </div>
                    </div>
                    <small>Pressure Angle (Standard 20¬∞)</small>
                    <button onclick="calcGearDesign()">Calculate Dimensions</button>
                </div>
                <div class="result-box">
                    <div class="res-grid">
                        <div class="res-item highlight"><small>Pitch Diameter (d)</small><span id="gPitchDia">0 mm</span></div>
                        <div class="res-item"><small>Outside Dia (da)</small><span id="gOutDia">0 mm</span></div>
                        <div class="res-item"><small>Root Dia (df)</small><span id="gRootDia">0 mm</span></div>
                        <div class="res-item"><small>Addendum (ha)</small><span id="gAdd">0 mm</span></div>
                        <div class="res-item"><small>Dedendum (hf)</small><span id="gDed">0 mm</span></div>
                        <div class="res-item"><small>Tooth Depth (h)</small><span id="gTotalH">0 mm</span></div>
                    </div>
                    <hr style="border-color:rgba(255,255,255,0.1); margin:15px 0;">
                    <p style="font-size:0.8rem; color:#94a3b8; text-align:center; margin:0;">
                         Based on Standard Involute: ha=1m, hf=1.25m
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div id="beltModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('beltModal')">&times;</span><h3>‚õìÔ∏è Belt Length Calc</h3><div class="modal-grid"><div class="input-group"><div class="row"><div style="flex:1"><small>Large Dia</small><input type="number" id="beltD" value="100"></div><div style="flex:1"><small>Small Dia</small><input type="number" id="belt_d" value="50"></div></div><small>Center Dist (mm)</small><input type="number" id="beltC" value="200"><button onclick="calcBelt()">Calculate Length</button></div><div class="result-box"><div>Belt Length</div><div id="beltLenRes" class="result-val">0 mm</div></div></div></div></div>

    <div id="weightModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('weightModal')">&times;</span><h3>‚öñÔ∏è Profile Weight Calculator</h3><div class="modal-grid"><div class="input-group"><div class="row"><div style="flex:1"><small>Profile</small><select id="profileType" onchange="updateProfileInputs()"><option value="round_solid">Round Bar</option><option value="square_hollow">Square Tube</option><option value="plate">Plate</option></select></div><div style="flex:1"><small>Material</small><select id="profileMat"><option value="7.85">Steel</option><option value="2.70">Alu</option></select></div></div><div id="profileInputs"><small>Diameter (mm)</small><input type="number" id="pD" value="20"></div><small>Length (mm)</small><input type="number" id="profL" value="1000"><button onclick="calcProfileWeight()">Calculate Mass</button></div><div class="result-box"><div>Total Weight</div><div id="profWeightRes" class="result-val">0.00 kg</div></div></div></div></div>

    <div id="geomModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('geomModal')">&times;</span><h3>üìê Volume & Mass</h3><div class="modal-grid"><div class="input-group"><select id="shapeType" onchange="updateGeomInputs()"><option value="cylinder">Cylinder</option><option value="sphere">Sphere</option><option value="cube">Cube/Block</option></select><select id="matDensity"><option value="7.85">Steel</option><option value="1.0">Water</option></select><div id="geomInputs"></div><button onclick="calcGeomVolume()">Calculate</button></div><div class="result-box"><div>Volume: <span id="geomRes">0</span> mm¬≥</div><hr><div>Mass: <span id="massRes">0</span> kg</div></div></div></div></div>

    <div id="beamModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('beamModal')">&times;</span><h3>üèóÔ∏è Beam Deflection</h3><div class="modal-grid"><div class="input-group"><span class="unit-tag">Parameters</span><select id="beamType"><option value="cantilever">Cantilever (Ankastre)</option><option value="simple">Simply Supported (Basit)</option></select><small>Load (N)</small><input type="number" id="beamF" value="1000"><small>Length (mm)</small><input type="number" id="beamL" value="2000"><small>Material (E - GPa)</small><select id="beamE"><option value="210">Steel (210)</option><option value="70">Aluminum (70)</option></select><small>Inertia (I - mm‚Å¥)</small><input type="number" id="beamI" value="100000"><button onclick="calcBeamPro()">Calc Deflection</button></div><div class="result-box"><div>Max Deflection</div><div id="resDef" class="result-val">0.00 mm</div></div></div></div></div>

    <div id="thermModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('thermModal')">&times;</span><h3>üî• Thermal Expansion</h3><div class="modal-grid"><div class="input-group"><small>Length (mm)</small><input type="number" id="thermL" value="100"><small>Delta T (¬∞C)</small><input type="number" id="thermDT" value="100"><small>Material</small><select id="thermMat"><option value="12">Steel</option><option value="23">Aluminum</option><option value="17">Copper</option></select><button onclick="calcThermal()">Calculate</button></div><div class="result-box"><div>Expansion (ŒîL)</div><div id="thermRes" class="result-val">0 ¬µm</div></div></div></div></div>

    <div id="flowModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('flowModal')">&times;</span><h3>üíß Pipe Flow Velocity</h3><div class="modal-grid"><div class="input-group"><small>Pipe ID (mm)</small><input type="number" id="pipeID" value="50"><small>Flow Rate (L/min)</small><input type="number" id="pipeQ" value="100"><button onclick="calcFlow()">Calculate Velocity</button></div><div class="result-box"><div>Velocity</div><div id="pipeVel" class="result-val">0.00 m/s</div></div></div></div></div>

    <div id="printModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('printModal')">&times;</span><h3>üñ®Ô∏è 3D Print Cost Est.</h3><div class="modal-grid"><div class="input-group"><div class="row"><div style="flex:1"><small>Spool Cost</small><input type="number" id="spoolCost" value="30"></div><div style="flex:1"><small>Spool (g)</small><input type="number" id="spoolWeight" value="1000"></div></div><div class="row"><div style="flex:1"><small>Part (g)</small><input type="number" id="partWeight" value="50"></div><div style="flex:1"><small>Hours</small><input type="number" id="printTime" value="4"></div></div><div class="row"><div style="flex:1"><small>Watts</small><input type="number" id="printerWatts" value="150"></div><div style="flex:1"><small>kWh Rate</small><input type="number" id="kwhCost" value="0.20"></div></div><button onclick="calcPrintCost()">Calculate</button></div><div class="result-box"><div>Total Cost</div><div id="resTotalPrint" class="result-val">0.00</div></div></div></div></div>

    <div id="cableModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('cableModal')">&times;</span><h3>‚ö° DC Cable Sizing</h3><div class="modal-grid"><div class="input-group"><div class="row"><div style="flex:1"><small>Volts</small><input type="number" id="cabV" value="12"></div><div style="flex:1"><small>Amps</small><input type="number" id="cabA" value="20"></div></div><div class="row"><div style="flex:1"><small>Length (m)</small><input type="number" id="cabL" value="5"></div><div style="flex:1"><small>Drop %</small><input type="number" id="cabDrop" value="3"></div></div><button onclick="calcCable()">Calculate Size</button></div><div class="result-box"><div>Min Section</div><div id="cabResMM" class="result-val">0 mm¬≤</div><div style="font-size:0.9rem; margin-top:5px;">Nearest: <strong id="cabStd">--</strong></div></div></div></div></div>

    <div id="electroModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('electroModal')">&times;</span><h3>üí° Electronics Lab</h3><div class="modal-grid"><div class="input-group"><span class="unit-tag">LED Resistor</span><div class="row"><div style="flex:1"><small>Source V</small><input type="number" id="ledVs" value="5"></div><div style="flex:1"><small>LED V</small><input type="number" id="ledVf" value="2.0"></div></div><small>Current (mA)</small><input type="number" id="ledI" value="20"><button onclick="calcLedResistor()">Find Resistor</button><div class="result-box" style="margin-top:5px; padding:5px;"><span id="resLedOhm">0 Œ©</span></div></div><div class="input-group" style="border-left:1px solid var(--border); padding-left:15px;"><span class="unit-tag">Ohm's Law</span><small>Voltage (V)</small><input type="number" id="ohmV" oninput="calcOhm()"><small>Current (A)</small><input type="number" id="ohmI" oninput="calcOhm()"><small>Resistance (Œ©)</small><input type="number" id="ohmR" oninput="calcOhm()"></div></div></div></div></div>

    <div id="resistorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('resistorModal')">&times;</span>
            <h3>üé® Resistor Color Code</h3>
            <div class="modal-grid">
                <div class="input-group">
                    <div class="row">
                        <div style="flex:1">
                            <small>Band 1</small>
                            <select id="rBand1" onchange="calcResistor()">
                                <option value="0" style="background:black; color:white;">Black</option>
                                <option value="1" style="background:brown; color:white;" selected>Brown</option>
                                <option value="2" style="background:red; color:white;">Red</option>
                                <option value="3" style="background:orange; color:black;">Orange</option>
                                <option value="4" style="background:yellow; color:black;">Yellow</option>
                                <option value="5" style="background:green; color:white;">Green</option>
                                <option value="6" style="background:blue; color:white;">Blue</option>
                                <option value="7" style="background:violet; color:black;">Violet</option>
                                <option value="8" style="background:grey; color:black;">Grey</option>
                                <option value="9" style="background:white; color:black;">White</option>
                            </select>
                        </div>
                        <div style="flex:1">
                            <small>Band 2</small>
                            <select id="rBand2" onchange="calcResistor()">
                                <option value="0" style="background:black; color:white;" selected>Black</option>
                                <option value="1" style="background:brown; color:white;">Brown</option>
                                <option value="2" style="background:red; color:white;">Red</option>
                                <option value="3" style="background:orange; color:black;">Orange</option>
                                <option value="4" style="background:yellow; color:black;">Yellow</option>
                                <option value="5" style="background:green; color:white;">Green</option>
                                <option value="6" style="background:blue; color:white;">Blue</option>
                                <option value="7" style="background:violet; color:black;">Violet</option>
                                <option value="8" style="background:grey; color:black;">Grey</option>
                                <option value="9" style="background:white; color:black;">White</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div style="flex:1">
                            <small>Multiplier</small>
                            <select id="rMul" onchange="calcResistor()">
                                <option value="1" style="background:black; color:white;">Black (x1)</option>
                                <option value="10" style="background:brown; color:white;">Brown (x10)</option>
                                <option value="100" style="background:red; color:white;" selected>Red (x100)</option>
                                <option value="1000" style="background:orange; color:black;">Orange (x1k)</option>
                                <option value="10000" style="background:yellow; color:black;">Yellow (x10k)</option>
                                <option value="100000" style="background:green; color:white;">Green (x100k)</option>
                                <option value="1000000" style="background:blue; color:white;">Blue (x1M)</option>
                                <option value="0.1" style="background:gold; color:black;">Gold (x0.1)</option>
                                <option value="0.01" style="background:silver; color:black;">Silver (x0.01)</option>
                            </select>
                        </div>
                        <div style="flex:1">
                            <small>Tolerance</small>
                            <select id="rTol" onchange="calcResistor()">
                                <option value="1" style="background:brown; color:white;">Brown (1%)</option>
                                <option value="2" style="background:red; color:white;">Red (2%)</option>
                                <option value="5" style="background:gold; color:black;" selected>Gold (5%)</option>
                                <option value="10" style="background:silver; color:black;">Silver (10%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="resistorVisual" style="height:40px; background:#e2e8f0; border-radius:20px; display:flex; justify-content:space-evenly; align-items:center; margin:20px 0; padding:0 30px; position:relative; overflow:hidden; border:2px solid #64748b;">
                        <div style="position:absolute; left:0; right:0; top:45%; height:10%; background:#94a3b8; z-index:0;"></div>
                        <div id="vBand1" style="width:15px; height:100%; background:brown; z-index:1;"></div>
                        <div id="vBand2" style="width:15px; height:100%; background:black; z-index:1;"></div>
                        <div id="vMul" style="width:15px; height:100%; background:red; z-index:1;"></div>
                        <div style="width:20px;"></div>
                        <div id="vTol" style="width:15px; height:100%; background:gold; z-index:1;"></div>
                    </div>

                </div>
                <div class="result-box">
                    <div id="resistorResult" class="result-val">1 kŒ©</div>
                    <small id="resistorTolResult">¬± 5%</small>
                </div>
            </div>
        </div>
    </div>

    <div id="stepperModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('stepperModal')">&times;</span><h3>ü§ñ Stepper Motor Calc</h3><div class="modal-grid"><div class="input-group"><small>Step Angle</small><select id="stepAng"><option value="1.8">1.8¬∞</option><option value="0.9">0.9¬∞</option></select><small>Microstepping</small><select id="stepMicro"><option value="1">Full</option><option value="2">1/2</option><option value="8">1/8</option><option value="16">1/16</option></select><small>Pitch / Lead (mm)</small><input type="number" id="transVal" value="8"><button onclick="calcStepper()">Calculate</button></div><div class="result-box"><div>Steps / mm</div><div id="stepRes" class="result-val">0</div></div></div></div></div>

    <div id="linterpModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('linterpModal')">&times;</span><h3>üå°Ô∏è Linear Interpolation</h3><div class="input-group"><div class="row"><input type="number" id="lx1" placeholder="x1"><input type="number" id="ly1" placeholder="y1"></div><div class="row"><input type="number" id="lx2" placeholder="x2"><input type="number" id="ly2" placeholder="y2"></div><hr><input type="number" id="ltx" placeholder="Target X"><button onclick="calcLinterp()">Calculate Y</button><div class="result-box"><span id="lres" class="result-val">Y = --</span></div></div></div></div>

    <div id="stressModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('stressModal')">&times;</span><h3>üìà Stress Calculator</h3><div class="modal-grid"><div class="input-group"><small>Force (N)</small><input type="number" id="stressF" value="5000"><small>Area (mm¬≤)</small><input type="number" id="stressA" value="50"><small>Orig. Length (mm)</small><input type="number" id="stressL0" value="100"><small>Extension (mm)</small><input type="number" id="stressDl" value="0.5"><button onclick="calcStress()">Calculate</button></div><div class="result-box"><div class="res-item highlight"><small>Stress (œÉ)</small><span id="resSigma">0 MPa</span></div><div class="res-item"><small>Strain (Œµ)</small><span id="resEpsilon">0</span></div><hr><div class="res-item"><small>Modulus (E)</small><span id="resModulus">0 GPa</span></div></div></div></div></div>

<script>
    // --- UTILS ---
    function safeFloat(id, def = 0) {
        const el = document.getElementById(id);
        return el && !isNaN(parseFloat(el.value)) ? parseFloat(el.value) : def;
    }

    // UPDATED DROPDOWN LOGIC FOR ACCORDION
    function toggleDropdown(id) { 
        var dropdowns = document.getElementsByClassName("dropdown-content");
        var btns = document.getElementsByClassName("dropbtn");
        
        // Bu fonksiyon, diƒüer a√ßƒ±k men√ºleri kapatƒ±r ve se√ßileni a√ßar/kapatƒ±r
        var current = document.getElementById(id);
        var isAlreadyOpen = current.classList.contains('show');

        // Close all first
        for (var i = 0; i < dropdowns.length; i++) { 
            dropdowns[i].classList.remove('show'); 
        }
        for (var i = 0; i < btns.length; i++) {
            btns[i].classList.remove('active');
        }

        // Toggle current if it wasn't open
        if (!isAlreadyOpen) {
            current.classList.add("show");
            // Highlight the button that opened it
            var btn = current.previousElementSibling;
            if(btn) btn.classList.add("active");
        }
    }
    
    // Global close handler
    window.onclick = function(event) {
        if (!event.target.matches('.dropbtn') && !event.target.matches('.dropbtn span') && !event.target.closest('.sidebar')) {
            // Optional: Close menus if clicking main content? 
        }
    }

    // --- SEARCH FUNCTION ---
    function filterTools() {
        let input = document.getElementById('globalSearch').value.toUpperCase();
        let cards = document.getElementsByClassName('card');
        let menuItems = document.querySelectorAll('.dropdown-content a');
        let resultPanel = document.getElementById('dynamicSearchResults');
        
        // 1. Filter visible cards
        for (let card of cards) {
            let txt = card.innerText || card.textContent;
            card.style.display = txt.toUpperCase().indexOf(input) > -1 ? "" : "none";
        }

        // 2. Search in hidden menus and create shortcut buttons
        resultPanel.innerHTML = "";
        if(input.length > 1) {
            let found = false;
            menuItems.forEach(item => {
                let txt = item.innerText;
                if(txt.toUpperCase().indexOf(input) > -1) {
                    found = true;
                    // Create a shortcut button
                    let btn = document.createElement('a');
                    btn.className = 'search-tag';
                    btn.innerHTML = txt;
                    btn.onclick = function() { 
                        // Execute the same onclick as the menu item
                        item.click(); 
                    };
                    resultPanel.appendChild(btn);
                }
            });
            resultPanel.style.display = found ? "flex" : "none";
        } else {
            resultPanel.style.display = "none";
        }
    }

    // Animation handler
    let animationId = null; 

    function openModal(id) { 
        document.getElementById(id).style.display = "block";
        if(id === 'threeModal') setTimeout(init3D, 100);
        if(id === 'sketchModal') setTimeout(() => { initCanvas(); resizeCanvas(); }, 100);
        if(id === 'robotModal') setTimeout(drawRobot, 100);
        if(id === 'geomModal') updateGeomInputs();
        if(id === 'weightModal') updateProfileInputs();
        if(id === 'gearDesignModal') calcGearDesign();
        if(id === 'resistorModal') calcResistor(); // Init resistor calc
    }

    function closeModal(id) { 
        document.getElementById(id).style.display = "none"; 
        
        if(id === 'threeModal' && animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }
    }

    // --- SEARCH FUNCTIONS (INTERNAL) ---
    function searchMaterials() {
        let input = document.getElementById('matSearch').value.toUpperCase();
        let rows = document.getElementById('matTableBody').getElementsByTagName('tr');
        for (let row of rows) row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none";
    }
    function searchCodes() {
        let input = document.getElementById('codeSearch').value.toUpperCase();
        let rows = document.getElementById('codeTableBody').getElementsByTagName('tr');
        for (let row of rows) row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none";
    }
    function searchFasteners() {
        let input = document.getElementById('fastenerSearch').value.toUpperCase();
        let rows = document.getElementById('fastenerBody').getElementsByTagName('tr');
        for (let row of rows) row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none";
    }

    // --- CONVERTER LOGIC ---
    function convert(type) {
        const val = safeFloat(type + 'Input');
        const from = parseFloat(document.getElementById(type + 'From').value);
        const to = parseFloat(document.getElementById(type + 'To').value);
        const res = val * from / to;
        document.getElementById(type + 'Res').innerText = res < 0.01 && res !== 0 ? res.toExponential(4) : res.toLocaleString(undefined, {maximumFractionDigits: 4});
    }
    function calcFin() {
        const p = safeFloat('pCap'), r = safeFloat('pRate'), t = safeFloat('pTime');
        document.getElementById('finRes').innerText = ((p*r*t)/1200).toLocaleString();
    }

    // --- ROBOT LOGIC ---
    function drawRobot() {
        const c = document.getElementById('robotCanvas');
        if(!c) return;
        const ctx = c.getContext('2d');
        const L1 = parseFloat(document.getElementById('robL1').value);
        const L2 = parseFloat(document.getElementById('robL2').value);
        const t1 = parseInt(document.getElementById('robT1').value);
        const t2 = parseInt(document.getElementById('robT2').value);
        
        document.getElementById('valT1').innerText = t1; document.getElementById('valT2').innerText = t2;
        const rad1 = t1 * (Math.PI / 180); const rad2 = t2 * (Math.PI / 180);
        const ox = c.width / 2; const oy = c.height - 50;
        const j1x = ox + L1 * Math.cos(-rad1); const j1y = oy + L1 * Math.sin(-rad1);
        const j2x = j1x + L2 * Math.cos(-(rad1 + rad2)); const j2y = j1y + L2 * Math.sin(-(rad1 + rad2));
        document.getElementById('robX').innerText = (j2x - ox).toFixed(1); document.getElementById('robY').innerText = (oy - j2y).toFixed(1);

        ctx.clearRect(0, 0, c.width, c.height);
        // Draw Grid
        ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 1; ctx.beginPath();
        for(let i=0; i<c.width; i+=20) { ctx.moveTo(i,0); ctx.lineTo(i,c.height); }
        for(let i=0; i<c.height; i+=20) { ctx.moveTo(0,i); ctx.lineTo(c.width,i); }
        ctx.stroke();

        ctx.fillStyle = '#64748b'; ctx.fillRect(ox - 25, oy, 50, 10);
        ctx.beginPath(); ctx.moveTo(ox, oy); ctx.lineTo(j1x, j1y); ctx.strokeStyle = '#818cf8'; ctx.lineWidth = 10; ctx.lineCap = 'round'; ctx.stroke();
        ctx.beginPath(); ctx.arc(j1x, j1y, 6, 0, 2*Math.PI); ctx.fillStyle = '#fff'; ctx.fill();
        ctx.beginPath(); ctx.moveTo(j1x, j1y); ctx.lineTo(j2x, j2y); ctx.strokeStyle = '#34d399'; ctx.lineWidth = 8; ctx.stroke();
        ctx.beginPath(); ctx.arc(j2x, j2y, 6, 0, 2*Math.PI); ctx.fillStyle = '#f87171'; ctx.fill();
    }

    // --- ENGINEERING LOGIC ---
    function calcFits(){
        const d = safeFloat('fitDia');
        const type = document.getElementById('fitType').value;
        let h_upper = 0, h_lower = 0;
        let s_upper = 0, s_lower = 0;
        
        // H7 Hole (Standard Basis) - Approx values in microns
        if(d <= 3) { h_upper=10; }
        else if(d <= 6) { h_upper=12; }
        else if(d <= 10) { h_upper=15; }
        else if(d <= 18) { h_upper=18; }
        else if(d <= 30) { h_upper=21; }
        else if(d <= 50) { h_upper=25; }
        else { h_upper=30; } 

        // Shafts
        if(type === 'H7g6') { // Slide (Gap)
             if(d<=3){ s_upper=-2; s_lower=-8; }
             else if(d<=6){ s_upper=-4; s_lower=-12; }
             else if(d<=10){ s_upper=-5; s_lower=-14; }
             else if(d<=18){ s_upper=-6; s_lower=-17; }
             else if(d<=30){ s_upper=-7; s_lower=-20; }
             else { s_upper=-9; s_lower=-25; }
             document.getElementById('fitValRes').innerText = "Clearance / Slide";
        } 
        else if(type === 'H7h6') { // Clearance (Zero)
             s_upper = 0; 
             if(d<=3) s_lower=-6;
             else if(d<=6) s_lower=-8;
             else if(d<=10) s_lower=-9;
             else if(d<=18) s_lower=-11;
             else if(d<=30) s_lower=-13;
             else s_lower=-16;
             document.getElementById('fitValRes').innerText = "Clearance / Locational";
        }
        else if(type === 'H7p6') { // Press (Interference)
             if(d<=3){ s_upper=12; s_lower=6; }
             else if(d<=6){ s_upper=20; s_lower=12; }
             else if(d<=10){ s_upper=24; s_lower=15; }
             else if(d<=18){ s_upper=29; s_lower=18; }
             else if(d<=30){ s_upper=35; s_lower=22; }
             else { s_upper=42; s_lower=26; }
             document.getElementById('fitValRes').innerText = "Interference / Press";
        }

        document.getElementById('fitHoleRes').innerText = `+${(h_upper/1000).toFixed(3)} / 0`;
        document.getElementById('fitShaftRes').innerText = `${(s_upper/1000).toFixed(3)} / ${(s_lower/1000).toFixed(3)}`;
    }

    function calcBeamPro(){
        const F = safeFloat('beamF');
        const L = safeFloat('beamL');
        const E = safeFloat('beamE') * 1000; 
        const I = safeFloat('beamI');
        const type = document.getElementById('beamType').value;
        
        let def = 0;
        if(type === 'cantilever') {
            def = (F * Math.pow(L, 3)) / (3 * E * I);
        } else {
            def = (F * Math.pow(L, 3)) / (48 * E * I);
        }
        document.getElementById('resDef').innerText = def.toFixed(3) + " mm";
    }

    function calcStress() {
        const F = safeFloat('stressF');
        const A = safeFloat('stressA');
        const L0 = safeFloat('stressL0');
        const Dl = safeFloat('stressDl');
        
        if(A > 0) {
            const sigma = F / A;
            document.getElementById('resSigma').innerText = sigma.toFixed(2) + " MPa";
            
            if(L0 > 0) {
                const epsilon = Dl / L0;
                document.getElementById('resEpsilon').innerText = epsilon.toFixed(4);
                
                if(epsilon > 0) {
                     const modulus = (sigma / epsilon) / 1000; // GPa
                     document.getElementById('resModulus').innerText = modulus.toFixed(1) + " GPa";
                }
            }
        }
    }

    function calcMobility() {
        const V = safeFloat('evV');
        const Ah = safeFloat('evAh');
        const W_motor = safeFloat('evW');
        const Speed = safeFloat('evSpd');
        const Weight = safeFloat('evWeight', 100);

        const TotalWh = V * Ah;
        const UsableWh = TotalWh * 0.85; 

        // Physics Approximation (Flat Ground)
        const P_roll = 0.015 * Weight * 9.81 * (Speed / 3.6); 
        const P_drag = 0.4 * 0.5 * 1.225 * Math.pow((Speed / 3.6), 3);
        
        let P_required = (P_roll + P_drag) / 0.85; 
        if(P_required < 50) P_required = 50; 

        const rangeKM = (UsableWh / P_required) * Speed;
        const timeH = rangeKM / Speed;
        const whPerKm = P_required / Speed;
        const estMaxSpeed = Math.pow((W_motor * 0.85) / (0.4 * 0.5 * 1.225), 1/3) * 3.6;
        const cost = (TotalWh / 1000) * 3.5; 

        document.getElementById('resRange').innerText = rangeKM.toFixed(1) + " km";
        document.getElementById('resTime').innerText = Math.floor(timeH) + "h " + Math.round((timeH%1)*60) + "m";
        document.getElementById('resWhKm').innerText = whPerKm.toFixed(1) + " Wh/km";
        document.getElementById('resTotalE').innerText = TotalWh.toFixed(0) + " Wh";
        document.getElementById('resMaxSpd').innerText = estMaxSpeed.toFixed(0) + " km/h";
        document.getElementById('resCost').innerText = cost.toFixed(2) + " ‚Ç∫";
    }

    function calcBattery() {
        const targetV = safeFloat('batTargetV');
        const targetAh = safeFloat('batTargetAh');
        const cellV = safeFloat('cellV');
        const cellMah = safeFloat('cellMah');
        const cellAmps = safeFloat('cellAmps');
        const cellG = safeFloat('cellG');

        if(cellV <= 0 || cellMah <= 0) return;

        const sCount = Math.ceil(targetV / cellV);
        const pCount = Math.ceil(targetAh / (cellMah / 1000));
        
        const totalCells = sCount * pCount;
        const packWeight = (totalCells * cellG) / 1000; 
        const realAh = (pCount * cellMah) / 1000;
        const totalEnergyKwh = (sCount * cellV * realAh) / 1000;
        const maxPowerKw = (pCount * cellAmps * (sCount * cellV)) / 1000;
        const maxV = sCount * 4.2; 

        document.getElementById('batConf').innerText = `${sCount}S / ${pCount}P`;
        document.getElementById('batKwh').innerText = totalEnergyKwh.toFixed(2) + " kWh";
        document.getElementById('batKw').innerText = maxPowerKw.toFixed(1) + " kW";
        document.getElementById('batRealAh').innerText = realAh.toFixed(1) + " Ah";
        document.getElementById('batTotalCells').innerText = totalCells;
        document.getElementById('batWeight').innerText = packWeight.toFixed(2) + " kg";
        document.getElementById('batMaxV').innerText = maxV.toFixed(1) + " V";
    }

    function calcCNC() {
        const vc = safeFloat('matType'); 
        const d = safeFloat('cncD');
        const fz = safeFloat('cncFz');
        const z = safeFloat('cncZ');
        const ae = safeFloat('cncAe');
        const ap = safeFloat('cncAp');

        if(d <= 0) { document.getElementById('resRPM').innerText = "Err"; return; }

        const rpm = (vc * 1000) / (Math.PI * d);
        const feed = rpm * fz * z; 
        const mrr = (feed * ae * ap) / 1000; 

        document.getElementById('resRPM').innerText = Math.round(rpm).toLocaleString();
        document.getElementById('resFeed').innerText = Math.round(feed) + " mm/min";
        document.getElementById('resMRR').innerText = mrr.toFixed(1) + " cm¬≥/min";
        document.getElementById('resChip').innerText = fz + " mm";
    }

    function calcLathe() {
        const dia = safeFloat('latheDia');
        const vc = safeFloat('latheMat');
        const ap = safeFloat('latheAp');
        const fn = safeFloat('latheFn');

        if(dia <= 0) { document.getElementById('latheRPM').innerText = "Err (Dia)"; return; }

        const rpm = (vc * 1000) / (Math.PI * dia);
        const mrrVal = vc * ap * fn; 
        const power = (mrrVal * 2000) / 60000; 

        document.getElementById('latheRPM').innerText = Math.round(rpm) + " RPM";
        document.getElementById('latheVc').innerText = vc + " m/min";
        document.getElementById('latheMRR').innerText = mrrVal.toFixed(1) + " cm¬≥/min";
        document.getElementById('lathePower').innerText = power.toFixed(1) + " kW";
    }

    // --- OTHER CALCULATORS ---
    function calcWeld(){
        const t = safeFloat('weldThick');
        document.getElementById('weldAmps').innerText = (t*30).toFixed(0) + " - " + (t*40).toFixed(0) + " A";
        document.getElementById('weldNote').innerText = "Rough Guide: 30-40A per mm";
    }
    function calcLaser(){
        const cost = ((safeFloat('cutLen')*1000/safeFloat('cutSpeed')/60)*safeFloat('cutRate')+safeFloat('cutSetup'));
        document.getElementById('cutCostRes').innerText = cost.toFixed(2);
        document.getElementById('cutTimeRes').innerText = (safeFloat('cutLen')*1000/safeFloat('cutSpeed')).toFixed(1) + " min";
    }
    function calcOring(){
        const w = safeFloat('oringW');
        document.getElementById('grooveD').innerText = (w*0.85).toFixed(2) + " mm";
        document.getElementById('grooveW').innerText = (w*1.3).toFixed(2) + " mm";
        document.getElementById('grooveDiaRes').innerText = (safeFloat('oringDia')+(2*w*0.85)).toFixed(2)+" mm";
    }
    function calcBend(){
        const ba = (safeFloat('bendA')*Math.PI/180)*(safeFloat('bendR')+(safeFloat('bendK')*safeFloat('bendT'))); 
        document.getElementById('bendBA').innerText = ba.toFixed(2) + " mm";
    }
    function calcHydro(){
        const f = (safeFloat('cylPress')*Math.PI*Math.pow(safeFloat('cylBore')/20,2)/1000);
        document.getElementById('pushForce').innerText = f.toFixed(2)+" Ton";
        document.getElementById('pullForce').innerText = (f * 0.7).toFixed(2) + " Ton";
    }
    function calcGearing(){
        const ratio = safeFloat('gearDriven')/safeFloat('gearDriver');
        const speed = (safeFloat('motorRPM')/ratio*Math.PI*safeFloat('tireDia')*60/100000);
        document.getElementById('speedRes').innerText = speed.toFixed(1)+" km/h";
        document.getElementById('ratioRes').innerText = ratio.toFixed(2)+":1";
    }

    // NEW GEAR DIMENSION CALCULATOR
    function calcGearDesign() {
        const m = safeFloat('gMod');
        const z = safeFloat('gTeeth');
        
        if (m <= 0 || z <= 0) return;

        // Standard ISO Metric Spur Gear Formulas (20 degree pressure angle)
        // ha = 1 * m
        // hf = 1.25 * m
        
        const d = m * z; // Pitch Diameter
        const ha = 1.0 * m; // Addendum
        const hf = 1.25 * m; // Dedendum
        const da = d + 2 * m; // Outside Diameter
        const df = d - 2 * (1.25 * m); // Root Diameter
        const h = ha + hf; // Total Depth

        document.getElementById('gPitchDia').innerText = d.toFixed(2) + " mm";
        document.getElementById('gOutDia').innerText = da.toFixed(2) + " mm";
        document.getElementById('gRootDia').innerText = df.toFixed(2) + " mm";
        document.getElementById('gAdd').innerText = ha.toFixed(2) + " mm";
        document.getElementById('gDed').innerText = hf.toFixed(2) + " mm";
        document.getElementById('gTotalH').innerText = h.toFixed(2) + " mm";
    }

    function calcBelt(){
        const L = (2*safeFloat('beltC')+1.57*(safeFloat('beltD')+safeFloat('belt_d'))+(Math.pow(safeFloat('beltD')-safeFloat('belt_d'),2)/(4*safeFloat('beltC'))));
        document.getElementById('beltLenRes').innerText = L.toFixed(0) + " mm";
    }
    function updateProfileInputs() {
        const t = document.getElementById('profileType').value;
        const div = document.getElementById('profileInputs');
        if(t==='round_solid') div.innerHTML = '<small>Dia (mm)</small><input type="number" id="pD" value="20">';
        else if(t==='plate') div.innerHTML = '<div class="row"><div style="flex:1"><small>W</small><input type="number" id="pW" value="50"></div><div style="flex:1"><small>Thick</small><input type="number" id="pT" value="5"></div></div>';
        else div.innerHTML = '<div class="row"><div style="flex:1"><small>W</small><input type="number" id="pW" value="40"></div><div style="flex:1"><small>Thick</small><input type="number" id="pT" value="2"></div></div>';
    }
    function calcProfileWeight(){
        const rho = parseFloat(document.getElementById('profileMat').value);
        let area = 0;
        const t = document.getElementById('profileType').value;
        if(t==='round_solid') area = Math.PI*Math.pow(safeFloat('pD')/2,2);
        else if(t==='plate') area = safeFloat('pW')*safeFloat('pT');
        else area = Math.pow(safeFloat('pW'),2) - Math.pow(safeFloat('pW')-2*safeFloat('pT'),2);
        document.getElementById('profWeightRes').innerText = (area*safeFloat('profL')*rho/1000000).toFixed(2)+" kg";
    }
    function updateGeomInputs(){
        const t = document.getElementById('shapeType').value;
        const d = document.getElementById('geomInputs');
        if(t==='sphere') d.innerHTML='<small>Radius</small><input type="number" id="gR" value="10">';
        else if(t==='cube') d.innerHTML='<div class="row"><input id="gL" placeholder="L"><input id="gW" placeholder="W"><input id="gH" placeholder="H"></div>';
        else d.innerHTML='<div class="row"><input id="gR" placeholder="R"><input id="gL" placeholder="L"></div>';
    }
    function calcGeomVolume(){
        const t = document.getElementById('shapeType').value;
        let v = 0;
        if(t==='sphere') v = (4/3)*Math.PI*Math.pow(safeFloat('gR'),3);
        else if(t==='cube') v = safeFloat('gL')*safeFloat('gW')*safeFloat('gH');
        else v = Math.PI*Math.pow(safeFloat('gR'),2)*safeFloat('gL');
        document.getElementById('geomRes').innerText = v.toFixed(0);
        document.getElementById('massRes').innerText = (v*safeFloat('matDensity')/1000000).toFixed(3);
    }
    function calcThermal(){document.getElementById('thermRes').innerText = (safeFloat('thermL')*safeFloat('thermMat')*1e-6*safeFloat('thermDT')*1000).toFixed(1)+" ¬µm";}
    function calcFlow(){document.getElementById('pipeVel').innerText = (safeFloat('pipeQ')/60000 / (Math.PI*Math.pow(safeFloat('pipeID')/2000,2))).toFixed(2) + " m/s";}
    function calcPrintCost(){document.getElementById('resTotalPrint').innerText = ((safeFloat('partWeight')/safeFloat('spoolWeight')*safeFloat('spoolCost')) + (safeFloat('printerWatts')/1000*safeFloat('printTime')*safeFloat('kwhCost'))).toFixed(2);}
    function calcCable(){
        const sect = (2*safeFloat('cabL')*safeFloat('cabA')*0.0175 / (safeFloat('cabV')*safeFloat('cabDrop')/100));
        document.getElementById('cabResMM').innerText = sect.toFixed(2) + " mm¬≤";
        const std = [0.5, 0.75, 1.0, 1.5, 2.5, 4, 6];
        document.getElementById('cabStd').innerText = std.find(s=>s>=sect) || "Check Max";
    }
    function calcLedResistor(){const r = (safeFloat('ledVs')-safeFloat('ledVf'))/(safeFloat('ledI')/1000); document.getElementById('resLedOhm').innerText = r.toFixed(0) + " Œ©";}
    function calcOhm(){const v=safeFloat('ohmV'), i=safeFloat('ohmI'); if(v&&i) document.getElementById('ohmR').value = v/i;}
    function calcStepper(){document.getElementById('stepRes').innerText = ((360/1.8*16)/safeFloat('transVal')).toFixed(2);}
    function calcLinterp(){document.getElementById('lres').innerText = (safeFloat('ly1')+((safeFloat('ltx')-safeFloat('lx1'))*(safeFloat('ly2')-safeFloat('ly1'))/(safeFloat('lx2')-safeFloat('lx1')))).toFixed(4);}

    // NEW FUNCTION: RESISTOR CALCULATOR
    function calcResistor() {
        const b1 = parseFloat(document.getElementById('rBand1').value);
        const b2 = parseFloat(document.getElementById('rBand2').value);
        const mul = parseFloat(document.getElementById('rMul').value);
        const tol = document.getElementById('rTol').value;
        
        let ohms = (b1 * 10 + b2) * mul;
        let formatted = ohms;
        
        if (ohms >= 1000000) formatted = (ohms / 1000000).toFixed(2).replace(/\.00$/,'') + " MŒ©";
        else if (ohms >= 1000) formatted = (ohms / 1000).toFixed(2).replace(/\.00$/,'') + " kŒ©";
        else formatted = ohms.toFixed(1).replace(/\.0$/,'') + " Œ©";

        document.getElementById('resistorResult').innerText = formatted;
        document.getElementById('resistorTolResult').innerText = "¬± " + tol + "%";

        // Update Visuals
        const colors = ['black','brown','red','orange','yellow','green','blue','violet','grey','white','gold','silver'];
        // Band 1
        document.getElementById('vBand1').style.backgroundColor = colors[b1];
        // Band 2
        document.getElementById('vBand2').style.backgroundColor = colors[b2];
        // Multiplier Color Mapping
        const mulMap = {1:'black', 10:'brown', 100:'red', 1000:'orange', 10000:'yellow', 100000:'green', 1000000:'blue', 0.1:'gold', 0.01:'silver'};
        document.getElementById('vMul').style.backgroundColor = mulMap[mul];
        // Tolerance Color Mapping
        const tolMap = {1:'brown', 2:'red', 5:'gold', 10:'silver'};
        document.getElementById('vTol').style.backgroundColor = tolMap[tol];
    }

    // --- 2D SKETCH LOGIC ---
    let canvas, ctx, shapes=[], points=[], activeTool='pencil', isDrawing=false, startPoint=null;
    
    function initCanvas(){ 
        canvas = document.getElementById('designCanvas'); 
        if(canvas){ 
            ctx = canvas.getContext('2d'); 
            
            // Mouse Events
            canvas.onmousedown = handleStart; 
            canvas.onmousemove = handleMove; 
            canvas.onmouseup = handleEnd; 
            
            // Touch Events (Mapped to mouse)
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent("mousedown", { clientX: touch.clientX, clientY: touch.clientY });
                canvas.dispatchEvent(mouseEvent);
            }, false);

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent("mousemove", { clientX: touch.clientX, clientY: touch.clientY });
                canvas.dispatchEvent(mouseEvent);
            }, false);

            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                const mouseEvent = new MouseEvent("mouseup", {});
                canvas.dispatchEvent(mouseEvent);
            }, false);

            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
        }
    }
    
    function resizeCanvas(){ 
        if(canvas){ 
            canvas.width = canvas.parentElement.offsetWidth; 
            canvas.height = 550; 
            drawCanvas(); 
        }
    }

    function setTool(t){ 
        activeTool = t; 
        points = [];
        startPoint = null;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        let btnId = t === 'pencil' ? 'btnPencil' : t === 'poly' ? 'btnPoly' : 'btnCircle';
        document.getElementById(btnId).classList.add('active');
    }

    function handleStart(e){ 
        const r = canvas.getBoundingClientRect(); 
        const p = {x: e.clientX - r.left, y: e.clientY - r.top}; 

        if(activeTool === 'poly'){
            points.push(p);
            drawCanvas();
        } else if(activeTool === 'pencil') {
            isDrawing = true;
            points = [p];
            ctx.beginPath();
            ctx.moveTo(p.x, p.y);
        } else if(activeTool === 'circle') {
            isDrawing = true;
            startPoint = p;
        }
    }

    function handleMove(e){ 
        const r = canvas.getBoundingClientRect(); 
        const p = {x: e.clientX - r.left, y: e.clientY - r.top}; 

        if(activeTool === 'pencil' && isDrawing) {
            points.push(p);
            ctx.lineTo(p.x, p.y);
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 2;
            ctx.stroke();
        } else if(activeTool === 'circle' && isDrawing) {
            drawCanvas();
            const rad = Math.sqrt(Math.pow(p.x - startPoint.x, 2) + Math.pow(p.y - startPoint.y, 2));
            ctx.beginPath();
            ctx.arc(startPoint.x, startPoint.y, rad, 0, Math.PI*2);
            ctx.strokeStyle = '#f59e0b';
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]);
        } else if(activeTool === 'poly' && points.length > 0) {
            drawCanvas();
            const last = points[points.length-1];
            ctx.beginPath();
            ctx.moveTo(last.x, last.y);
            ctx.lineTo(p.x, p.y);
            ctx.strokeStyle = '#60a5fa';
            ctx.stroke();
        }
    }

    function handleEnd(e){ 
        if(!isDrawing) return;
        const r = canvas.getBoundingClientRect(); 
        const p = {x: e.clientX - r.left, y: e.clientY - r.top}; 

        if(activeTool === 'pencil'){
            isDrawing = false;
            shapes.push({type: 'pencil', pts: points});
            points = [];
        } else if(activeTool === 'circle'){
            isDrawing = false;
            const rad = Math.sqrt(Math.pow(p.x - startPoint.x, 2) + Math.pow(p.y - startPoint.y, 2));
            shapes.push({type: 'circle', c: startPoint, r: rad});
            drawCanvas();
            calcArea();
        }
    }

    function closePolygon(){ 
        if(points.length > 2) shapes.push({type:'poly', pts:points}); 
        points=[]; 
        drawCanvas(); 
        calcArea(); 
    }

    function clearCanvas(){ 
        shapes=[]; points=[]; 
        drawCanvas(); 
        document.getElementById('analysisResult').innerText="Area: 0 mm¬≤"; 
    }

    function drawCanvas(){ 
        if(!ctx) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height); 
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(255,255,255,0.05)';
        ctx.lineWidth = 1;
        for(let i=0; i<canvas.width; i+=20) { ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); }
        for(let i=0; i<canvas.height; i+=20) { ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); }
        ctx.stroke();

        shapes.forEach(s => {
            ctx.strokeStyle = '#10b981'; ctx.lineWidth = 2; ctx.beginPath();
            if(s.type === 'poly' || s.type === 'pencil'){ 
                if(s.pts.length > 0){
                    ctx.moveTo(s.pts[0].x, s.pts[0].y); 
                    s.pts.forEach(p => ctx.lineTo(p.x, p.y)); 
                    if(s.type === 'poly') ctx.closePath(); 
                    ctx.stroke(); 
                }
            }
            if(s.type === 'circle'){ ctx.arc(s.c.x, s.c.y, s.r, 0, Math.PI*2); ctx.stroke(); }
        });

        if(activeTool === 'poly' && points.length > 0){
             ctx.fillStyle = '#60a5fa';
             points.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill(); });
             ctx.beginPath();
             ctx.strokeStyle = '#60a5fa';
             ctx.moveTo(points[0].x, points[0].y);
             for(let i=1; i<points.length; i++) ctx.lineTo(points[i].x, points[i].y);
             ctx.stroke();
        }
    }

    function calcArea(){
        let total = 0;
        shapes.forEach(s => {
            if(s.type === 'circle') total += Math.PI * Math.pow(s.r, 2);
            if(s.type === 'poly'){
                let a = 0;
                for(let i=0; i<s.pts.length; i++){
                    let j = (i+1)%s.pts.length;
                    a += s.pts[i].x*s.pts[j].y; a -= s.pts[j].x*s.pts[i].y;
                }
                total += Math.abs(a)/2;
            }
        });
        document.getElementById('analysisResult').innerText = "Area: " + total.toFixed(0) + " mm¬≤ (Approx)";
    }

    // --- 3D STUDIO LOGIC ---
    let scene, camera, renderer, controls, raycaster, mouse;
    let is3DDrawMode = false;
    let linePoints = [];
    let currentLine = null;

    function init3D() {
        const cont = document.getElementById('threeContainer');
        if(cont.children.length > 1) return; 
        
        scene = new THREE.Scene(); 
        scene.background = new THREE.Color(0x111111);
        camera = new THREE.PerspectiveCamera(75, cont.clientWidth/cont.clientHeight, 0.1, 1000);
        camera.position.set(10, 10, 15);
        renderer = new THREE.WebGLRenderer({antialias:true}); 
        renderer.setSize(cont.clientWidth, cont.clientHeight);
        cont.appendChild(renderer.domElement);
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        
        const amb = new THREE.AmbientLight(0x404040); scene.add(amb);
        const light = new THREE.DirectionalLight(0xffffff, 1); light.position.set(10,20,10); scene.add(light);
        const grid = new THREE.GridHelper(40, 40, 0x333333, 0x222222); scene.add(grid);

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
        renderer.domElement.addEventListener('click', on3DClick, false);
        
        // RESIZE LISTENER
        window.addEventListener('resize', () => {
            if (!camera || !renderer) return;
            const width = cont.clientWidth;
            const height = cont.clientHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        });

        function animate() { 
            animationId = requestAnimationFrame(animate); 
            controls.update(); 
            renderer.render(scene, camera); 
        }
        animate();
    }

    function toggle3DDrawMode(){
        is3DDrawMode = !is3DDrawMode;
        const btn = document.getElementById('btn3DDraw');
        if(is3DDrawMode){
            btn.style.background = "#10b981";
            btn.innerText = "‚úçÔ∏è Mode ON (Click Grid)";
            controls.enabled = false; 
        } else {
            btn.style.background = "";
            btn.innerText = "‚úçÔ∏è Draw Line on Grid";
            controls.enabled = true;
            linePoints = []; 
        }
    }

    function on3DClick(event){
        if(!is3DDrawMode) return;
        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        
        const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
        const target = new THREE.Vector3();
        const intersect = raycaster.ray.intersectPlane(plane, target); 

        if(intersect){
            target.x = Math.round(target.x);
            target.z = Math.round(target.z);
            target.y = 0;
            const geo = new THREE.SphereGeometry(0.2, 16, 16);
            const mat = new THREE.MeshBasicMaterial({color: 0xf59e0b});
            const marker = new THREE.Mesh(geo, mat);
            marker.position.copy(target);
            scene.add(marker);
            linePoints.push(target);

            if(linePoints.length > 1){
                const points = linePoints;
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const material = new THREE.LineBasicMaterial({ color: 0x3b82f6, linewidth: 3 });
                if(currentLine) scene.remove(currentLine);
                currentLine = new THREE.Line(geometry, material);
                scene.add(currentLine);
            }
        }
    }

    function add3DCube(){ 
        const g=new THREE.BoxGeometry(4,4,4); const m=new THREE.MeshPhongMaterial({color:0x3b82f6}); const c=new THREE.Mesh(g,m); 
        c.position.y=2; c.position.x = (Math.random()-0.5)*10; c.position.z = (Math.random()-0.5)*10; scene.add(c); 
    }
    function add3DCylinder(){ 
        const g=new THREE.CylinderGeometry(2,2,6,32); const m=new THREE.MeshPhongMaterial({color:0x10b981}); const c=new THREE.Mesh(g,m); 
        c.position.y=3; c.position.x = (Math.random()-0.5)*10; scene.add(c); 
    }
    
    // MEMORY CLEANUP
    function clear3D(){ 
        for(let i=scene.children.length-1; i>=0; i--){
            let obj = scene.children[i];
            if(obj.type==='Mesh' || obj.type==='Line') {
                scene.remove(obj);
                if(obj.geometry) obj.geometry.dispose();
                if(obj.material) {
                    if (Array.isArray(obj.material)) obj.material.forEach(m => m.dispose());
                    else obj.material.dispose();
                }
            }
        }
        linePoints = []; currentLine = null;
    }
    function toggleWireframe(){ 
        scene.children.forEach(c => { if(c.type==='Mesh' && c.material) c.material.wireframe = !c.material.wireframe; });
    }

</script>
</body>
</html>
